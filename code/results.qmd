---
title: "Descriptive Analysis & Preliminary Results"
format: 
  html:
    theme: cosmo
    toc: true
    toc_float: true
---

# Introduction

The following document summarises the progress made thus far on Chapter 1: Local Fiscal Risks of Decarbonisation of my DPhil. The work aims to pursue a better understanding of how industrial transformation impacts local well-being. From an original interest in looking at all aspects of local public finance, the project has narrowed to focus on expenditure on public education and its connection to industrial prosperity and transformation. 

```{r, echo = FALSE, message = FALSE}
library(tidyverse)
library(stargazer)
library(zoo)
library(tidycensus)
library(here)
library(viridis)
library(datasets)
library(broom)
library(fixest)
library(readxl)
library(plm)
library(getspanel)
library(gridExtra)
library(ggridges)
source(here('code/useful_functions.R'))
source(here('code/dicts.R'))

```

```{r, echo = FALSE}
# Does not yet include population controls from 1997-1990
df <- readRDS(here("data/out/school_exp_county.RDS")) %>% 
  filter(year >= 2000) %>% 
  complete(fips, year) %>% 
  # Exclude CT for now because of the redistricting/county reorganisation in 2017 (see master_cleaning for preliminary work on this)
  filter(!(substr(fips, 1,2) %in% c("09")))
```

# Data

*Expenditure and Revenue:* The dependent variables of interest come from [Willamette University's Government Finance Database]{https://willamette.edu/mba/research-impact/public-datasets/index.html}. The data includes from county-level revenue and expenditure on public education including disaggregated values by revenue source (federal, state, or other intergovernmental revenue) and expenditure item (lunches, wages, debt). All values are reported in current US dollars.

*GDP Controls:* US Bureau of Economic Analysis. Values are also reported in current US dollars (real GDP values exist). The controls used in the below are total, private industry, and oil, gas, mining & quarrying county-level GDP.

*Population controls:* US Census Bureau.

*Economic Diversity:* [Chmura Analytics]{https://www.chmura.com/blog/chmura-economic-diversity}. This is time-invariant and not yet included in any regressions below.

*Coal mine activity and production levels:* Mine Safety and Health Administration

*Note: GDP controls and economic diversity indicators from the original "main_county/pub_fin/data/temp" and cleaned from Willamette_Scoping.Rmd.*

```{r, echo = FALSE, message = FALSE, include = FALSE}

gdp <- readRDS(here("data/temp/gdp_controls.RDS")) %>% 
  mutate(across(contains("mining"), ~ifelse(is.na(.), 0, .)))

df %>% pull(fips) %>% unique %>% setdiff(unique(gdp$fips)) %>% length(.) == 0
gdp %>% filter(fips %in% unique(df$fips)) %>% filter(!complete.cases(.)) %>% nrow(.) == 0

ec_div <- readRDS(here("data/temp/econ_div_controls.RDS")) %>% select(fips, year, low_econ_div)
df %>% pull(fips) %>% unique %>% setdiff(unique(ec_div$fips)) %>% length(.) == 0

df <- df %>% 
  left_join(., gdp, by = c('fips', 'year')) %>% 
  mutate(across(names(select(gdp, -c(fips, year))), ~./pop_total, .names = "{.col}_pc")) %>% 
  group_by(fips) %>% 
  mutate(across(matches(paste0(names(select(gdp, -c(fips, year))), collapse = "|")),list(diff = ~. - dplyr::lag(., 1), log = ~log(. + 1)), .names = "{.fn}_{.col}"),
         # Currently only GDP controls contain diff
         across(matches(paste0(names(select(gdp, -c(fips, year))), collapse = "|")), list(l1 = ~dplyr::lag(., 1), l2 = ~dplyr::lag(., 2)), .names = "{.col}_{.fn}")) %>% 
  ungroup %>% 
  left_join(., ec_div, by = c('fips', 'year'))

df$state_name = sapply(df$state, get_state) 
df$region = sapply(df$state_name, get_region)

```

## Descriptive Statistics
The below summary tables display descriptive statistics for all indicators used in regression results below. The table is divided in two (pre- and post-2007) as the establishment of Educational Service Agencies started taking place around 2007. First table shows 2007-2021, latter table earlier 2000-2007.
```{r, echo = FALSE, results = 'asis'}
# Variables of interest for descriptive statistics
vars <- c("Total_Revenue", "Total_Taxes", "Property_Tax", "Total_IG_Revenue", "Total_Fed_IG_Revenue", "Total_Expenditure", "Total_Interest_on_Debt")

df %>%
  select(year, esa_tot_exp, esa_tot_exp_pp, voc_adult_tot_exp, voc_adult_tot_exp_pp, Enrollment, all_of(vars), paste0(vars, "_pp"), pop_total, pop_school_age, gdp_total, gdp_priv_ind, gdp_govt, gdp_o_g_mining_quarr_21) %>%
  dplyr::group_split(year < 2007) %>% 
      purrr::iwalk(.,~{
        .x %>% 
          select(-year) %>% 
          data.frame() %>%
          stargazer(digits = 0, digits.extra = 3, type = "html")})
  
```

## Descriptive Figures: County-level education expenditure 
The following plot displays each county's time series of expenditure (total and per pupil log values) as well as the overall mean. 
```{r, echo = FALSE, message = FALSE}

mean_df <- df %>% 
  group_by(year) %>%
             summarise(Total_Educ_Total_Exp = mean(Total_Educ_Total_Exp, na.rm = TRUE),
                       Total_Educ_Total_Exp_pp = mean(Total_Educ_Total_Exp_pp, na.rm = TRUE),
                       log_Total_Educ_Total_Exp = log(Total_Educ_Total_Exp),
                       log_Total_Educ_Total_Exp_pp = log(Total_Educ_Total_Exp_pp))
log_tot <- df %>% 
  ggplot() +
  geom_line(aes(x = year, y = log_Total_Educ_Total_Exp, group = fips, colour = state), alpha = 0.3) +
  geom_line(data = mean_df, aes(x = year, y = log_Total_Educ_Total_Exp), linewidth = 1) + 
  labs(x = "Year", y = "Total County-level Education Expenditure (log)", title = "Total (log) Expenditure")

log_pp <- df %>% ggplot() +
  geom_line(aes(x = year, y = log_Total_Educ_Total_Exp_pp, group = fips, colour = state), alpha = 0.3) +
  geom_line(data = mean_df, aes(x = year, y = log_Total_Educ_Total_Exp_pp)) + 
  labs(x = "Year", y = "Total County-level Education Expenditure Per Pupil (log)", title = "Total (log) Expenditure Per Pupil")

grid.arrange(log_tot, log_pp)
  
  
```

```{r, echo = FALSE, message = FALSE}

df %>% 
  mutate(panel = case_when(year %in% 2000:2003 ~ "2000-2003",
                           year %in% 2004:2007 ~ "2004-2007", 
                           year %in% 2008:2011 ~ "2008-2011", 
                           year %in% 2012:2015 ~ "2012-2015", 
                           year %in% 2016:2021 ~ "2016-2021")) %>% 
  group_by(panel) %>% 
  mutate(color_year = year - min(year)) %>% 
  ggplot(aes(log_Total_Educ_Total_Exp_pp, fill = as.factor(color_year), color = as.factor(color_year))) +
  geom_histogram(position = "identity", alpha = 0.1, bins = 200) +
  facet_wrap(~panel, ncol = 1) +
  theme_minimal() + 
  theme(legend.position = "none") +
  scale_fill_viridis(discrete = T) +
  labs(title = "Histogram of (log) Total Education Expenditure per pupil", x = "(log) Expenditure per Pupil", y = "N Counties")
  
df %>% 
  mutate(panel = case_when(year %in% 2000:2003 ~ "2000-2003",
                           year %in% 2004:2007 ~ "2004-2007", 
                           year %in% 2008:2011 ~ "2008-2011", 
                           year %in% 2012:2015 ~ "2012-2015", 
                           year %in% 2016:2021 ~ "2016-2021")) %>% 
  ggplot(aes(x = log_Total_Educ_Total_Exp_pp, y = as.factor(year), fill = year)) +
  geom_density_ridges() +
  theme_minimal() + 
  scale_fill_viridis() +
  theme(legend.position = "none") +
  scale_y_discrete(limits = rev(levels(as.factor(df$year)))) +
  labs(title = "Histogram of Education Expenditure per Pupil per Year", y = "Year", x = "(log) Total Education Expenditure per Pupil")

df %>% 
  mutate(panel = case_when(year %in% 2000:2003 ~ "2000-2003",
                           year %in% 2004:2007 ~ "2004-2007", 
                           year %in% 2008:2011 ~ "2008-2011", 
                           year %in% 2012:2015 ~ "2012-2015", 
                           year %in% 2016:2021 ~ "2016-2021")) %>% 
  ggplot(aes(x = log_gdp_total_pc, y = as.factor(year), fill = year)) +
  geom_density_ridges(alpha = 0.7) +
  theme_minimal() + 
  scale_fill_viridis() +
  theme(legend.position = "none") +
  scale_y_discrete(limits = rev(levels(as.factor(df$year)))) +
  labs(title = "Histogram of Education Expenditure per Pupil per Year", y = "Year", x = "(log) GDP per Capita")
  
```


# Key Relationships (KR)
Below are scatterplots and diagrams of shares of key relationships among dependent and control variables. 

## KR 1: Revenue Sources
Most important to tease out before modelling is how different revenue sources (federal, state, county (own), and other local sources interplay). 

Below chart plots county-level mean 


```{r, echo = FALSE, message = FALSE}

tots <- df %>% 
  group_by(fips) %>% 
  summarise(across(c(log_Total_Rev_Own_Sources_pp, log_Total_IG_Revenue_pp), ~mean(., na.rm = TRUE)))  %>% 
  ggplot(aes(x = log_Total_Rev_Own_Sources_pp, y = log_Total_IG_Revenue_pp)) +
  geom_jitter(colour = "blue") +
  labs(title = "Total IG Revenue pp vs Own Rev. pp") +
  geom_abline(slope = -1, intercept = 3) +
  theme(title = element_text(size = 9))


fed <- df %>% 
  group_by(fips) %>% 
  summarise(across(c(log_Total_Rev_Own_Sources_pp, log_Total_Fed_IG_Revenue_pp), ~mean(., na.rm = TRUE)))  %>% 
  ggplot(aes(x = log_Total_Rev_Own_Sources_pp, y = log_Total_Fed_IG_Revenue_pp)) +
  geom_jitter(colour = "magenta") +
  labs(title = "Federal IG Revenue pp vs Own Rev. pp") +
  geom_abline(slope = -1, intercept = 0) +
  theme(title = element_text(size = 9),
        legend.position = "none")

state <- df %>% 
  group_by(fips) %>% 
  summarise(across(c(log_Total_Rev_Own_Sources_pp, log_Total_State_IG_Revenue_pp), ~mean(., na.rm = TRUE)))  %>% 
  ggplot(aes(x = log_Total_Rev_Own_Sources_pp, y = log_Total_State_IG_Revenue_pp)) +
  geom_jitter(colour = "purple") +
  labs(title = "State IG Revenue pp vs Own Rev. pp", size = 10) + 
  geom_abline(slope = -1, intercept = 3) +
  theme(title = element_text(size = 9),
        legend.position = "none")

grid.arrange(tots, fed, state, ncol = 2)

```

The following plots show the share of revenue for public education that comes from own sources, local intergovernmental, state intergovernmental, and federal intergovernmental by state. Almost all states have a near 50% split of revenue from state and own sources, which aligns with data from the Congressional Research Service cited in the ToS. Massachusetts has a particularly high share of federal support (eclipsing own sources almost completely). 

**Conclusion: I am still unsure how best to control for the effects of these shares on our results.** 

```{r, echo = FALSE, message = FALSE}
state_df <- df %>% 
  group_by(state, year) %>% 
  summarise(across(c(Enrollment, Total_Expenditure, Total_Educ_Total_Exp, Total_Revenue, Total_Rev_Own_Sources, Total_Fed_IG_Revenue, Total_State_IG_Revenue, Tot_Local_IG_Rev, Total_Taxes, Property_Tax), ~sum(., na.rm = TRUE))) %>% ungroup

state_df$state_name = sapply(state_df$state, get_state) 
state_df$region = sapply(state_df$state_name, get_region)

state_df <- state_df %>% 
  relocate(state_name, region, .after = state) 

state_df %>% 
  select(year, state_name, Total_Rev_Own_Sources, Total_Fed_IG_Revenue, Total_State_IG_Revenue, Tot_Local_IG_Rev) %>% 
  pivot_longer(cols = !c(year, state_name), names_to = "Source", values_to = "Revenue") %>%
  ggplot(aes(x = year, y = Revenue, group = Source, fill = Source)) +
  scale_fill_viridis(discrete = T)+
  geom_area(colour = "white", position = "fill", alpha = 0.8) + 
  geom_line(aes(x = year, y = 0.5), linewidth = 0.1, linetype = "dashed") +
  facet_wrap(~state_name) +
  theme(legend.position = "bottom", panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_x_continuous(breaks = c(2000, 2021)) +
  labs(title = "Share of Revenue from Federal, State, Local Sources", subtitle = "State Levels", xlab = "Year", ylab = "Share of Total Revenue") +
  guides(fill=guide_legend(nrow=2))

#ggsave(here("output/plots/state_shares_of_revenue_by_source.jpg"), width = 20, height = 20, units = "cm")

```

The below plot provides the same information as above but on a national level. 

**Conclusion: By definition, corroborates the near-even split of revenue between state and own sources. I mainly include this as an alternative summarising figure to the above.**

```{r, echo = FALSE}

natl_df <- df %>% 
  group_by(year) %>% 
  summarise(across(c(Enrollment, Total_Expenditure, Total_Educ_Total_Exp, Total_Revenue, Total_Rev_Own_Sources, Total_IG_Revenue, Total_Fed_IG_Revenue, Total_State_IG_Revenue, Tot_Local_IG_Rev, Total_Taxes, Property_Tax), ~sum(., na.rm = TRUE))) %>% ungroup %>% mutate(across(Total_Expenditure:last_col(), ~./Enrollment, .names = "{.col}_pp"))

natl_df %>% 
  select(year, Total_Rev_Own_Sources, Total_Fed_IG_Revenue, Total_State_IG_Revenue, Tot_Local_IG_Rev) %>% 
  pivot_longer(cols = !year, names_to = "Source", values_to = "Revenue") %>%
  ggplot(aes(x = year, y = Revenue, group = Source, fill = Source)) +
  scale_fill_brewer(palette = "Spectral")+
  geom_area(colour = "white", position = "fill") + 
  labs(title = "Share of Revenue from Federal, State, Local Sources", subtitle = "National Levels", xlab = "Year", ylab = "Share of Total Revenue") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  guides(fill=guide_legend(nrow=2))

#ggsave(here("output/plots/natl_shares_of_revenue_by_source.jpg"), width = 18, height = 15, units = "cm")

```

## KR 2: ESAs and County Expenditure

Around 2007, many states instituted Educational Service Agencies (ESAs) which sought to "equalise" public education across the country. To date, ~45 states have ESAs which are responsible for multiple school districts, most often across multiple counties. Therefore, when modelling county-level expenditure it will be important to understand how this change in educational expenditure affected county-level spending (ie. did ESAs replace or supplement county-level funding).

Only 593 counties of 2740 in the dataset have recorded revenue/expenditure from ESAs. After some digging, I believe that these values for ESAs are improperly recorded in the sense that the revenue is recorded only in counties in which the ESA's headquarters is located and not partitioned to the counties to which the revenue ultimately flows. All total expenditure/revenue values that are used in the regressions on this page have explicitly excluded recorded ESA values for this reason. 

The below graphs show some relationships between ESA and county-level finances. I have yet to arrive at a definitive understanding of how ESAs and county-level finances interact. They do not appear to be substitutes.

```{r, echo = FALSE, message = FALSE}

esa_county <- readRDS(here("data/temp/esa_data_county_97_21.RDS")) %>% 
  mutate(state = substr(fips, 1,2))

esa_county$state_name = sapply(esa_county$state, get_state) 

esa_county %>% 
  filter(year >= 2007) %>% 
  group_by(year, state_name) %>% 
  summarise(across(esa_rev:esa_tot_exp, ~sum(., na.rm = TRUE))) %>% 
  mutate(across(esa_rev:esa_tot_exp, ~ifelse(. == 0, NA, .))) %>% 
  rename("State" = state_name) %>% 
  ggplot(aes(x = year, y = log(esa_tot_exp), group = State, color = State)) +
  geom_line() +
  labs(xlab = "Year", ylab = "Expenditure in log thousand USD", title = "Expenditure by Educational Service Agencies per State", subtitle = "by State; Year = 2007-2021") +
  theme(legend.position = "bottom", panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    guides(fill=guide_legend(nrow=5))
  

```

With this we want to demonstrate how ESAs interact with our expenditure indicator. Does high ESA spending imply low/high local spending? It seems from the below that the two have a positive correlation implying little substitution?

```{r, echo = FALSE, message = FALSE}
df %>% 
  select(year, fips, log_Total_Expenditure, log_esa_tot_exp, state_name) %>% 
  mutate(year = as.factor(year),
         log_esa_tot_exp = ifelse(is.na(log_esa_tot_exp), 0, log_esa_tot_exp)) %>% 
  # group_by(fips) %>% 
  # mutate(across(log_Total_Expenditure:log_esa_tot_exp, ~mean(., na.rm = TRUE)))  %>% 
  # ungroup %>%  
  ggplot(aes(x = log_Total_Expenditure, y = log_esa_tot_exp, colour = state_name)) +
  geom_jitter() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_viridis(discrete = T)
```

## KR 3: Revenue and Property Taxes

```{r, echo = FALSE}

tot <- df %>% 
  ggplot(aes(x = log_Property_Tax, y = log_Total_Educ_Total_Exp)) +
  geom_jitter(, colour = "deeppink2", alpha = 0.5) + 
  geom_smooth(method=lm, colour = "black") +
  labs(x = "log Property Taxes Collected", y = "log Education Expenditure") 


pp <- df %>% 
  ggplot(aes(x = log_Property_Tax_pp, y = log_Total_Educ_Total_Exp_pp)) +
  geom_jitter(, colour = "cyan3", alpha = 0.5) + 
  geom_smooth(method=lm, colour = "black") +
  labs(x = "log Property Taxes Collected pp", y = "log Education Expenditure pp") 

grid.arrange(tot, pp, ncol = 2)

```


## KR 4: GDP and Property Taxes


```{r}

tot <- df %>% 
  ggplot(aes(x = log_gdp_total, y = log_Property_Tax)) +
  geom_jitter(, colour = "steelblue", alpha = 0.5) + 
  geom_smooth(method=lm, colour = "black") +
  labs(x = "log GDP", y = "log Property Taxes Collected") 

pp <- df %>% 
  ggplot(aes(x = log_gdp_total_pc, y = log_Property_Tax_pp)) +
  geom_jitter(, colour = "darkorchid", alpha = 0.5) + 
  geom_smooth(method=lm, colour = "black") +
  labs(x = "log GDP pc", y = "log Property Taxes Collected pp") 

grid.arrange(tot, pp, ncol = 2)

```

## KR 5: GDP and Education Expenditure

```{r, echo = FALSE}

tot <- df %>% 
  ggplot(aes(x = log_gdp_total, y = log_Total_Educ_Total_Exp)) +
  geom_jitter(, colour = "brown", alpha = 0.5) + 
  geom_smooth(method=lm, colour = "black") +
  labs(x = "log GDP", y = "log Education Expenditure") 


pp <- df %>% 
  ggplot(aes(x = log_gdp_total_pc, y = log_Total_Educ_Total_Exp_pp)) +
  geom_jitter(, colour = "darkorange2", alpha = 0.5) + 
  geom_smooth(method=lm, colour = "black")  +
  labs(x = "log GDP pc", y = "log Education Expenditure pp") 

grid.arrange(tot, pp, ncol = 2)

```

# Results

## Panel testing

```{r}

is.pbalanced(df, index = c("fips", "year"))

```

## County-level trends
TBA: Summary of county-level trends to be added.
```{r, echo = FALSE, eval = FALSE, message = FALSE}

df %>% 
 select(year, fips, Total_Expenditure, esa_tot_exp) %>% 
  group_by(fips) %>%
  do(glance(lm(Total_Expenditure ~ esa_tot_exp, data = .)))

```


```{r, echo = FALSE, message = FALSE, include = FALSE}
mines_data <- readRDS(here('data/temp/mines_data/allcomp_cap_prod_complete.RDS')) %>% 
  select(-state)

#df %>% filter(!fips %in% unique(mines_data$fips)) %>% pull(fips) %>% unique
# mines_data %>% filter(!fips %in% unique(df$fips)) %>% pull(fips) %>% unique

mines_df <- df %>% 
  #left_join(., allcomp_controls, by = c("year", "fips")) %>% 
  left_join(., mines_data, by = c("year", "fips")) %>% 
  group_by(fips) %>%
  mutate(across(c(Property_Tax_pp, Total_Taxes_pp, Total_Educ_Current_Exp_pp, Total_Rev_Own_Sources_pp, Total_IG_Revenue_pp),  ~. - dplyr::lag(., 1), .names = "diff_{.col}"),
        across(paste0("diff_", c("Property_Tax_pp", "Total_Taxes_pp", "Total_Educ_Current_Exp_pp", "Total_Rev_Own_Sources_pp", "Total_IG_Revenue_pp")), list(l1 = ~dplyr::lag(., 1), l2 = ~dplyr::lag(., 2)), .names = "{.col}_{.fn}"),
        across(c(total_n, total_active_n, total_active_prod, diff_total_active_n, l1_diff_total_active_n, l2_diff_total_active_n, diff_total_active_prod, l1_diff_total_active_prod, l2_diff_total_active_prod), ~ifelse(is.na(.), 0, .)),
        across(c(total_n, total_active_n, total_active_prod), ~log(. + 1), .names = "log_{.col}")) %>% 
  ungroup


# Testing for complete dataset
#Dependent variables are complete
mines_df %>% 
  select(fips, year,"Total_Taxes_pp", "Total_Educ_Current_Exp_pp", "Property_Tax_pp", "diff_Total_Taxes_pp", "diff_Total_Educ_Current_Exp_pp", "diff_Property_Tax_pp") %>% filter(year != 2000) %>% filter(!complete.cases(.))

# Missing a few cases in LA
mines_df %>% 
  filter(year != 2000) %>%  # gdp_o_g_mining_quarr_21_pc,  gdp_o_g_mining_quarr_21_pc, 
  select(fips, year, gdp_total_pc, gdp_priv_ind_pc,gdp_govt_pc, 
         gdp_total_pc, gdp_priv_ind_pc, gdp_govt_pc) %>% 
  filter(!complete.cases(.))
       
# No missing values in coal counties - replaced other counties NA values with 0  
mines_df %>% 
  select(fips, year, total_n, diff_total_active_n, l1_diff_total_active_n, l2_diff_total_active_n, diff_total_active_prod, l1_diff_total_active_prod, l2_diff_total_active_prod) %>% 
  ungroup %>% filter(!complete.cases(.)) 

  
# exog <- c(" ~ diff_total_active_n + l1_diff_total_active_n + l2_diff_total_active_n + realgdp_pc",
#           " ~ diff_total_active_prod + l1_diff_total_active_prod + l2_diff_total_active_prod + realgdp_pc",
#           " ~ i(ruc_bin, diff_total_active_n) + i(ruc_bin, l1_diff_total_active_n) + i(ruc_bin, l2_diff_total_active_n) + realgdp_pc",
#           " ~ i(ruc_bin, diff_total_active_prod) + i(ruc_bin, l1_diff_total_active_prod) + i(ruc_bin, l2_diff_total_active_prod) + realgdp_pc")
# 
# exog_list <- c("diff_total_active_n + l1_diff_total_active_n + l2_diff_total_active_n",
#           "diff_total_active_prod + l1_diff_total_active_prod + l2_diff_total_active_prod",
#           "i(ruc_bin, diff_total_active_n) + i(ruc_bin, l1_diff_total_active_n) + i(ruc_bin, l2_diff_total_active_n",
#           "i(ruc_bin, diff_total_active_prod) + i(ruc_bin, l1_diff_total_active_prod) + i(ruc_bin, l2_diff_total_active_prod)")
#         
#            # Levels & First differences
dep <- c("Total_Rev_Own_Sources_pp", "diff_Total_Rev_Own_Sources_pp",
         "Total_IG_Revenue_pp", "diff_Total_IG_Revenue_pp",
         "Total_Taxes_pp","diff_Total_Taxes_pp",
         "Property_Tax_pp", "diff_Property_Tax_pp",
         "Total_Educ_Current_Exp_pp",  "diff_Total_Educ_Current_Exp_pp")

#forms <- paste0(rep(dep, each = length(exog)), exog)


```

```{r, echo = FALSE}
mines_df <- mines_df %>% 
  filter(year >= 2001) %>% 
  #mutate(ruc_bin = as.factor(ruc_bin)) %>% 
  mutate(across(all_of(dep), ~.*1000),
         time = year - 2000) %>% 
  mutate(across(contains("log"), ~ifelse(is.infinite(.), 0, .)),
         across(c(log_esa_tot_exp_pp, log_esa_tot_exp), ~ifelse(is.na(.), 0, .)))

```


## Descriptive regression models

The below models were run to test the relevance of various gdp control variables (total, private industry, oil, gas & mining) as well as corroborate some relationships in the above scatter plots of KRs.

```{r}
list(feols(log_Property_Tax ~ log_gdp_total | fips + year, data = mines_df, se = "cluster", cluster = "fips"),
     feols(log_Property_Tax_pp ~ log_gdp_total_pc | fips + year, data = mines_df, se = "cluster", cluster = "fips")) %>% etable

feols(log_Total_Educ_Current_Exp ~ sw(log_gdp_total,
                                      log_gdp_priv_ind,
                                      log_gdp_o_g_mining_quarr_21,
                                      log_esa_tot_exp, 
                                       log_Total_Rev_Own_Sources + log_Total_IG_Revenue, 
                                       log_Property_Tax, 
                                       log_Property_Tax + log_Total_IG_Revenue,
                                       log_Property_Tax + log_Total_Fed_IG_Revenue + log_State_IGR_Education) | fips + year, data = mines_df, se = "cluster", cluster = "fips") %>% etable

feols(log_Total_Educ_Current_Exp_pp ~ sw(log_gdp_total_pc,
                                         log_gdp_priv_ind_pc,
                                         log_gdp_o_g_mining_quarr_21_pc,
                                         log_esa_tot_exp_pp,
                                         log_Total_Rev_Own_Sources_pp + log_Total_IG_Revenue_pp,
                                         log_Property_Tax_pp, 
                                         log_Property_Tax_pp + log_Total_IG_Revenue_pp, 
                                         log_Property_Tax_pp + log_Total_Fed_IG_Revenue_pp + log_State_IGR_Education_pp) | fips + year, data = mines_df, se = "cluster", cluster = "fips") %>% etable

```

### Incorporating state-level trends
```{r}
feols(log_Total_Educ_Current_Exp ~ sw(log_gdp_total, 
                                      log_gdp_priv_ind,
                                      log_gdp_o_g_mining_quarr_21) + time:as.factor(state) | fips + year, data = mines_df, se = "cluster", cluster = "fips") %>%  etable(., drop = "time*")

feols(log_Total_Educ_Current_Exp_pp ~ sw(log_gdp_total_pc, 
                                      log_gdp_priv_ind_pc,
                                      log_gdp_o_g_mining_quarr_21_pc) + time:as.factor(state) | fips + year, data = mines_df, se = "cluster", cluster = "fips") %>%  etable(., drop = "time*")
```


### Incorporating time lags
```{r}
levs_gdp_real_trend <- feols(log_Total_Educ_Current_Exp ~ sw(log_gdp_total + log_gdp_total_l1 + log_gdp_total_l2, log_gdp_priv_ind + log_gdp_priv_ind_l1 + log_gdp_priv_ind_l2) + time:as.factor(state) | fips + year, data = mines_df, se = "cluster", cluster = "fips")
levs_gdp_real_trend %>% etable(., drop = "time*")

feols(log_Total_Educ_Current_Exp ~ sw(log_gdp_total_pc + log_gdp_total_pc_l1 + log_gdp_total_pc_l2, 
                                      log_gdp_priv_ind_pc + log_gdp_priv_ind_pc_l1 + log_gdp_priv_ind_pc_l2,
                                      log_gdp_o_g_mining_quarr_21 + log_gdp_o_g_mining_quarr_21_l1 + log_gdp_o_g_mining_quarr_21_l2) + time:as.factor(state) | fips + year, data = mines_df, se = "cluster", cluster = "fips") %>%  etable(., drop = "time*")

feols(log_Total_Educ_Current_Exp_pp ~ sw(log_gdp_total_pc + log_gdp_total_pc_l1 + log_gdp_total_pc_l2, 
                                      log_gdp_priv_ind_pc + log_gdp_priv_ind_pc_l1 + log_gdp_priv_ind_pc_l2,
                                      log_gdp_o_g_mining_quarr_21_pc + log_gdp_o_g_mining_quarr_21_pc_l1 + log_gdp_o_g_mining_quarr_21_pc_l2) + time:as.factor(state) | fips + year, data = mines_df, se = "cluster", cluster = "fips") %>%  etable(., drop = "time*")

```


## Coal Mine & Production Data
Mine data exists from 1996-2021. Preliminary treatment attempt using data on active coal production (total_active_prod) and active coal mines (total_active_n).

```{r, message = FALSE}

list(feols(log_Total_Educ_Current_Exp_pp ~ log_gdp_priv_ind_pc + log_gdp_priv_ind_pc_l1 + log_gdp_priv_ind_pc_l2 + diff_total_active_n + l1_diff_total_active_n + l2_diff_total_active_n | fips + year, data = mines_df, se = "cluster", cluster = "fips"),
feols(log_Total_Educ_Current_Exp_pp ~ sw(log_gdp_priv_ind_pc + log_gdp_priv_ind_pc_l1 + log_gdp_priv_ind_pc_l2 + diff_total_active_prod + l1_diff_total_active_prod + l2_diff_total_active_prod,
                                         log_gdp_total_pc + log_gdp_total_pc_l1 + log_gdp_total_pc_l2 + diff_total_active_n + l1_diff_total_active_n + l2_diff_total_active_n,
                                         log_gdp_total_pc + log_gdp_total_pc_l1 + log_gdp_total_pc_l2 + diff_total_active_prod + l1_diff_total_active_prod + l2_diff_total_active_prod) | fips + year, data = mines_df, se = "cluster", cluster = "fips")) %>% etable


list(feols(log_Total_Educ_Current_Exp_pp ~ log_gdp_priv_ind_pc + log_gdp_priv_ind_pc_l1 + log_gdp_priv_ind_pc_l2 + l(total_active_n, 0:2)  | fips + year, data = mines_df, se = "cluster", cluster = "fips", panel.id = ~fips+year),
     feols(log_Total_Educ_Current_Exp_pp ~ sw(log_gdp_priv_ind_pc + log_gdp_priv_ind_pc_l1 + log_gdp_priv_ind_pc_l2 + l(total_active_prod, 0:2),
                                         log_gdp_total_pc + log_gdp_total_pc_l1 + log_gdp_total_pc_l2 + l(total_active_n, 0:2),
                                         log_gdp_total_pc + log_gdp_total_pc_l1 + log_gdp_total_pc_l2 + l(total_active_prod, 0:2)) | fips + year, data = mines_df, se = "cluster", cluster = "fips", panel.id = ~fips+year)) %>% etable

```


There is a significant endogeneity concern in using total active production and active mines as the treatment variable. Therefore, I have tried the following two solutions.

### Instrumental Variable
We consider using total active production or total active mines as an instrument affecting education expenditure through property taxes. We know that property taxes have an endogenous relationship with education expenditure (it is a component of the public education budget), however, in theory mine closures/activity is unlikely to affect education expenditure, except via property taxes. We test this hypothesis below. 

The results themselves are not promising (I think??), and this is likely because active mines do indeed have a relationship with education expenditure (resource curse?). 

```{r, message = FALSE}

feols(log_Total_Educ_Current_Exp_pp ~ log_gdp_total_pc | fips + year | log_Property_Tax_pp ~ total_active_prod, data = mines_df, se = "cluster", cluster = "fips")
feols(log_Total_Educ_Current_Exp_pp ~ log_gdp_total_pc | fips + year | log_Property_Tax_pp ~ l(total_active_prod,1), data = mines_df, se = "cluster", cluster = "fips", panel.id = ~fips+year)

feols(log_Total_Educ_Current_Exp_pp ~ log_gdp_total_pc | fips + year | log_Property_Tax_pp ~ total_active_n, data = mines_df, se = "cluster", cluster = "fips")
feols(log_Total_Educ_Current_Exp_pp ~ log_gdp_total_pc | fips + year | log_Property_Tax_pp ~ l(total_active_n,1), data = mines_df, se = "cluster", cluster = "fips", panel.id = ~fips+year)
feols(log_Total_Educ_Current_Exp_pp ~ log_gdp_total_pc | fips + year | log_Property_Tax_pp ~ total_active_n, data = mines_df, se = "cluster", cluster = "fips")
feols(log_Total_Educ_Current_Exp_pp ~ log_gdp_total_pc | fips + year | log_Property_Tax_pp ~ l(total_active_n,1), data = mines_df, se = "cluster", cluster = "fips", panel.id = ~fips+year)

```


## Bartik Instrument
TBA: Results to be added
```{r}

```



```{r, include = FALSE}
# getspanel
# isatpanel(data = mines_df, 
#           formula = "Total_Educ_Current_Exp_pp ~ gdp_total_pc + gdp_priv_ind_pc + gdp_o_g_mining_quarr_21_pc + gdp_govt_pc",
#           index = c("fips","year"),
#          iis = TRUE,
#          t.pval =0.01
#          # SIS = TRUE 
#           )

```

