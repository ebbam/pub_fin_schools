---
title: "Descriptive Analysis & Preliminary Results"
format: html
editor: visual
---

```{r, echo = FALSE, message = FALSE}
library(tidyverse)
library(stargazer)
library(zoo)
library(tidycensus)
library(here)
library(viridis)
library(datasets)
library(broom)
library(fixest)
library(readxl)
library(plm)
library(getspanel)
library(gridExtra)
library(ggridges)
source(here('code/useful_functions.R'))
source(here('code/dicts.R'))

```

```{r, echo = FALSE}
# Does not yet include population controls from 1997-1990
df <- readRDS(here("data/out/school_exp_county.RDS")) %>% 
  filter(year >= 2000) %>% 
  complete(fips, year) %>% 
  # Exclude CT for now because of the redistricting/county reorganisation in 2017 (see master_cleaning for preliminary work on this)
  filter(!(substr(fips, 1,2) %in% c("09")))
```

# Data

County-level revenue and expenditure data for public education: [Willamette University's Government Finance Database]{https://willamette.edu/mba/research-impact/public-datasets/index.html} 

GDP Controls: US Bureau of Economic Analysis 

Economic Diversity: [Chmura Analytics]{https://www.chmura.com/blog/chmura-economic-diversity}. This is time-invariant.

Coal mine activity and production levels: Mine Safety and Health Administration

Note: GDP controls and economic diversity indicators from the original "main_county/pub_fin/data/temp" and cleaned from Willamette_Scoping.Rmd.

The below summary tables display descriptive statistics for all indicators used in regression results below. The table is divided in two (pre- and post-2007) as the establishment of Educational Service Agencies started taking place around 2007.

```{r, echo = FALSE, message = FALSE, include = FALSE}

gdp <- readRDS(here("data/temp/gdp_controls.RDS")) %>% 
  mutate(across(contains("mining"), ~ifelse(is.na(.), 0, .)))

df %>% pull(fips) %>% unique %>% setdiff(unique(gdp$fips)) %>% length(.) == 0
gdp %>% filter(fips %in% unique(df$fips)) %>% filter(!complete.cases(.)) %>% nrow(.) == 0

ec_div <- readRDS(here("data/temp/econ_div_controls.RDS")) %>% select(fips, year, low_econ_div)
df %>% pull(fips) %>% unique %>% setdiff(unique(ec_div$fips)) %>% length(.) == 0

df <- df %>% 
  left_join(., gdp, by = c('fips', 'year')) %>% 
  mutate(across(names(select(gdp, -c(fips, year))), ~./pop_total, .names = "{.col}_pc")) %>% 
  group_by(fips) %>% 
  mutate(across(matches(paste0(names(select(gdp, -c(fips, year))), collapse = "|")),list(diff = ~. - dplyr::lag(., 1), log = ~log(. + 1)), .names = "{.fn}_{.col}"),
         # Currently only GDP controls contain diff
         across(matches(paste0(names(select(gdp, -c(fips, year))), collapse = "|")), list(l1 = ~dplyr::lag(., 1), l2 = ~dplyr::lag(., 2)), .names = "{.col}_{.fn}")) %>% 
  ungroup %>% 
  left_join(., ec_div, by = c('fips', 'year'))

```

```{r, echo = FALSE, results = 'asis'}
# Variables of interest for descriptive statistics
vars <- c("Total_Revenue", "Total_Taxes", "Property_Tax", "Total_IG_Revenue", "Total_Fed_IG_Revenue", "Total_Expenditure", "Total_Interest_on_Debt")

df %>%
  select(year, esa, voc_adult, Enrollment, all_of(vars), paste0(vars, "_pp"), pop_total, pop_school_age, gdp_total, gdp_priv_ind, gdp_govt, gdp_o_g_mining_quarr_21) %>%
  dplyr::group_split(year < 2007) %>% 
      purrr::iwalk(.,~{
        .x %>% 
          select(-year) %>% 
          data.frame() %>%
          stargazer(digits = 0, digits.extra = 3, type = "html")})
  
```

# Panel series per county of expenditure and expenditure per pupil
```{r, echo = FALSE}

mean_df <- df %>% 
  group_by(year) %>%
             summarise(Total_Educ_Total_Exp = mean(Total_Educ_Total_Exp, na.rm = TRUE),
                       Total_Educ_Total_Exp_pp = mean(Total_Educ_Total_Exp_pp, na.rm = TRUE),
                       log_Total_Educ_Total_Exp = log(Total_Educ_Total_Exp),
                       log_Total_Educ_Total_Exp_pp = log(Total_Educ_Total_Exp_pp))
log_tot <- df %>% 
  ggplot() +
  geom_line(aes(x = year, y = log_Total_Educ_Total_Exp, group = fips, colour = state), alpha = 0.3) +
  geom_line(data = mean_df, aes(x = year, y = log_Total_Educ_Total_Exp), linewidth = 1) + 
  labs(x = "Year", y = "Total County-level Education Expenditure (log)", title = "Total (log) Expenditure")


log <- df %>% ggplot() +
  geom_line(aes(x = year, y = Total_Educ_Total_Exp_pp, group = fips, colour = state), alpha = 0.3) +
  geom_line(data = mean_df, aes(x = year, y = Total_Educ_Total_Exp_pp)) + 
  labs(x = "Year", y = "Total County-level Education Expenditure Per Pupil", title = "Total Expenditure Per Pupil")

log_pp <- df %>% ggplot() +
  geom_line(aes(x = year, y = log_Total_Educ_Total_Exp_pp, group = fips, colour = state), alpha = 0.3) +
  geom_line(data = mean_df, aes(x = year, y = log_Total_Educ_Total_Exp_pp)) + 
  labs(x = "Year", y = "Total County-level Education Expenditure Per Pupil (log)", title = "Total (log) Expenditure Per Pupil")

grid.arrange(log_tot,log, log_pp)
  
  
```

# Panel series per county of expenditure and expenditure per pupil
```{r, echo = FALSE}

df %>% 
  mutate(panel = case_when(year %in% 2000:2003 ~ "2000-2003",
                           year %in% 2004:2007 ~ "2004-2007", 
                           year %in% 2008:2011 ~ "2008-2011", 
                           year %in% 2012:2015 ~ "2012-2015", 
                           year %in% 2016:2021 ~ "2016-2021")) %>% 
  group_by(panel) %>% 
  mutate(color_year = year - min(year)) %>% 
  ggplot(aes(log_Total_Educ_Total_Exp_pp, fill = as.factor(color_year), color = as.factor(color_year))) +
  geom_histogram(position = "identity", alpha = 0.1, bins = 200) +
  facet_wrap(~panel, ncol = 1) +
  theme_minimal() + 
  theme(legend.position = "none") +
  scale_fill_viridis(discrete = T) +
  labs(title = "Histogram of (log) Total Education Expenditure per pupil", x = "(log) Expenditure per Pupil", y = "N Counties")
  
df %>% 
  mutate(panel = case_when(year %in% 2000:2003 ~ "2000-2003",
                           year %in% 2004:2007 ~ "2004-2007", 
                           year %in% 2008:2011 ~ "2008-2011", 
                           year %in% 2012:2015 ~ "2012-2015", 
                           year %in% 2016:2021 ~ "2016-2021")) %>% 
  ggplot(aes(x = log_Total_Educ_Total_Exp_pp, y = as.factor(year), fill = year)) +
  geom_density_ridges() +
  theme_minimal() + 
  scale_fill_viridis() +
  theme(legend.position = "none") +
  scale_y_discrete(limits = rev(levels(as.factor(df$year)))) +
  labs(title = "Histogram of Education Expenditure per Pupil per Year", y = "Year", x = "(log) Total Education Expenditure per Pupil")

df %>% 
  mutate(panel = case_when(year %in% 2000:2003 ~ "2000-2003",
                           year %in% 2004:2007 ~ "2004-2007", 
                           year %in% 2008:2011 ~ "2008-2011", 
                           year %in% 2012:2015 ~ "2012-2015", 
                           year %in% 2016:2021 ~ "2016-2021")) %>% 
  ggplot(aes(x = log_gdp_total_pc, y = as.factor(year), fill = year)) +
  geom_density_ridges(alpha = 0.7) +
  theme_minimal() + 
  scale_fill_viridis() +
  theme(legend.position = "none") +
  scale_y_discrete(limits = rev(levels(as.factor(df$year)))) +
  labs(title = "Histogram of Education Expenditure per Pupil per Year", y = "Year", x = "(log) GDP per Capita")
  
```


# Descriptive Statistics

## County

```{r, echo = FALSE}

df %>% 
  group_by(fips) %>% 
  summarise(across(c(Total_Rev_Own_Sources_pp, Total_IG_Revenue_pp), ~mean(., na.rm = TRUE)))  %>% 
  ggplot(aes(x = log(Total_Rev_Own_Sources_pp), y = log(Total_IG_Revenue_pp))) +
  geom_jitter() +
  labs(title = "Scatterplot of Relationship between IG Revenue pp and Local Source Revenue pp")


```

## State

```{r, echo = FALSE, message = FALSE}
state_df <- df %>% 
  group_by(state, year) %>% 
  summarise(across(c(Enrollment, Total_Expenditure, Total_Educ_Total_Exp, Total_Revenue, Total_Rev_Own_Sources, Total_Fed_IG_Revenue, Total_State_IG_Revenue, Tot_Local_IG_Rev, Total_Taxes, Property_Tax), ~sum(., na.rm = TRUE))) %>% ungroup

state_df$state_name = sapply(state_df$state, get_state) 
state_df$region = sapply(state_df$state_name, get_region)

state_df <- state_df %>% 
  relocate(state_name, region, .after = state) 

state_df %>% 
  select(year, state_name, Total_Rev_Own_Sources, Total_Fed_IG_Revenue, Total_State_IG_Revenue, Tot_Local_IG_Rev) %>% 
  pivot_longer(cols = !c(year, state_name), names_to = "Source", values_to = "Revenue") %>%
  ggplot(aes(x = year, y = Revenue, group = Source, fill = Source)) +
  scale_fill_viridis(discrete = T)+
  geom_area(colour = "white", position = "fill", alpha = 0.8) + 
  geom_line(aes(x = year, y = 0.5), linewidth = 0.1, linetype = "dashed") +
  facet_wrap(~state_name) +
  theme(legend.position = "bottom", panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_x_continuous(breaks = c(2000, 2021)) +
  labs(title = "Share of Revenue from Federal, State, Local Sources", subtitle = "State Levels", xlab = "Year", ylab = "Share of Total Revenue") +
  guides(fill=guide_legend(nrow=2))

#ggsave(here("output/plots/state_shares_of_revenue_by_source.jpg"), width = 20, height = 20, units = "cm")

```

## National

```{r, echo = FALSE}

natl_df <- df %>% 
  group_by(year) %>% 
  summarise(across(c(Enrollment, Total_Expenditure, Total_Educ_Total_Exp, Total_Revenue, Total_Rev_Own_Sources, Total_IG_Revenue, Total_Fed_IG_Revenue, Total_State_IG_Revenue, Tot_Local_IG_Rev, Total_Taxes, Property_Tax), ~sum(., na.rm = TRUE))) %>% ungroup %>% mutate(across(Total_Expenditure:last_col(), ~./Enrollment, .names = "{.col}_pp"))

natl_df %>% 
  select(year, Total_Rev_Own_Sources, Total_Fed_IG_Revenue, Total_State_IG_Revenue, Tot_Local_IG_Rev) %>% 
  pivot_longer(cols = !year, names_to = "Source", values_to = "Revenue") %>%
  ggplot(aes(x = year, y = Revenue, group = Source, fill = Source)) +
  scale_fill_brewer(palette = "Spectral")+
  geom_area(colour = "white", position = "fill") + 
  labs(title = "Share of Revenue from Federal, State, Local Sources", subtitle = "National Levels", xlab = "Year", ylab = "Share of Total Revenue") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  guides(fill=guide_legend(nrow=2))

#ggsave(here("output/plots/natl_shares_of_revenue_by_source.jpg"), width = 18, height = 15, units = "cm")

```

### ESAs

```{r, echo = FALSE, message = FALSE}

esa_county <- readRDS(here("data/temp/esa_data_county_97_21.RDS")) %>% 
  mutate(state = substr(fips, 1,2))

esa_county$state_name = sapply(esa_county$state, get_state) 

esa_county %>% 
  filter(year >= 2007) %>% 
  group_by(year, state_name) %>% 
  summarise(across(esa_rev:esa_tot_exp, ~sum(., na.rm = TRUE))) %>% 
  mutate(across(esa_rev:esa_tot_exp, ~ifelse(. == 0, NA, .))) %>% 
  rename("State" = state_name) %>% 
  ggplot(aes(x = year, y = log(esa_tot_exp), group = State, color = State)) +
  geom_line() +
  labs(xlab = "Year", ylab = "Expenditure in log thousand USD", title = "Expenditure by Educational Service Agencies per State", subtitle = "by State; Year = 2007-2021") +
  theme(legend.position = "bottom", panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    guides(fill=guide_legend(nrow=5))
  

```

### ESAs versus expenditure

With this we want to demonstrate how ESAs interact with our expenditure indicator. Does high ESA spending imply low local spending (positive correlaiton it seems). Does increasing ESA spending result in decreasing ESA spending? It seems from the below that the two have a positive correlation implying little substitution?

```{r, echo = FALSE, message = FALSE}

df %>% 
  select(year, fips, log_Total_Expenditure, log_esa_tot_exp) %>% 
  mutate(year = as.factor(year)) %>% 
  group_by(fips) %>% 
  mutate(across(log_Total_Expenditure:log_esa_tot_exp, ~mean(., na.rm = TRUE)))  %>% 
  ungroup %>%  
  ggplot(aes(x = log_Total_Expenditure, y = log_esa_tot_exp, colour = year)) +
  geom_jitter() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_brewer(palette = "PiYG") 
  
df %>% 
 select(year, fips, Total_Expenditure, esa_tot_exp) %>% 
  group_by(fips) %>%
  do(glance(lm(Total_Expenditure ~ year, data = .)))

```


# Key relationships

## GDP and Property Taxes

```{r}

df %>% 
  ggplot(aes(x = log_gdp_total, y = log_Property_Tax, group = state, color = state)) +
  geom_jitter()

df %>% 
  ggplot(aes(x = log_gdp_total_pc, y = log_Property_Tax_pp, group = state, color = state)) +
  geom_jitter()

```

## GDP and Education Expenditure

```{r, echo = FALSE}

df %>% 
  ggplot(aes(x = log_gdp_total, y = log_Property_Tax, group = state, color = state)) +
  geom_jitter()

df %>% 
  ggplot(aes(x = log_gdp_total_pc, y = log_Property_Tax_pp, group = state, color = state)) +
  geom_jitter()

```

## IG Expenditure and Own Sources

```{r, echo = FALSE}

df %>% 
  ggplot(aes(x = log_Total_IG_Expenditure, y = log_Total_Rev_Own_Sources, group = state, color = state)) +
  geom_jitter()

df %>% 
  ggplot(aes(x = log_Total_IG_Expenditure_pp, y = log_Total_Rev_Own_Sources_pp, group = state, color = state)) +
  geom_jitter()

```


# Results

## Panel testing

```{r}
is.pbalanced(df, index = c("fips", "year"))

```

## Mine closures

Mine data exists from 1996-2021

```{r, echo = FALSE, message = FALSE, include = FALSE}
mines_data <- readRDS(here('data/temp/mines_data/allcomp_cap_prod_complete.RDS')) %>% 
  select(-state)

#df %>% filter(!fips %in% unique(mines_data$fips)) %>% pull(fips) %>% unique
# mines_data %>% filter(!fips %in% unique(df$fips)) %>% pull(fips) %>% unique

mines_df <- df %>% 
  #left_join(., allcomp_controls, by = c("year", "fips")) %>% 
  left_join(., mines_data, by = c("year", "fips")) %>% 
  group_by(fips) %>%
  mutate(across(c(Property_Tax_pp, Total_Taxes_pp, Total_Educ_Current_Exp_pp, Total_Rev_Own_Sources_pp, Total_IG_Revenue_pp),  ~. - dplyr::lag(., 1), .names = "diff_{.col}"),
        across(paste0("diff_", c("Property_Tax_pp", "Total_Taxes_pp", "Total_Educ_Current_Exp_pp", "Total_Rev_Own_Sources_pp", "Total_IG_Revenue_pp")), list(l1 = ~dplyr::lag(., 1), l2 = ~dplyr::lag(., 2)), .names = "{.col}_{.fn}"),
        across(c(total_n, total_active_n, total_active_prod, diff_total_active_n, l1_diff_total_active_n, l2_diff_total_active_n, diff_total_active_prod, l1_diff_total_active_prod, l2_diff_total_active_prod), ~ifelse(is.na(.), 0, .)),
        across(c(total_n, total_active_n, total_active_prod), ~log(. + 1), .names = "log_{.col}")) %>% 
  ungroup


# Testing for complete dataset
#Dependent variables are complete
mines_df %>% 
  select(fips, year,"Total_Taxes_pp", "Total_Educ_Current_Exp_pp", "Property_Tax_pp", "diff_Total_Taxes_pp", "diff_Total_Educ_Current_Exp_pp", "diff_Property_Tax_pp") %>% filter(year != 2000) %>% filter(!complete.cases(.))

# Missing a few cases in LA
mines_df %>% 
  filter(year != 2000) %>%  # gdp_o_g_mining_quarr_21_pc,  gdp_o_g_mining_quarr_21_pc, 
  select(fips, year, gdp_total_pc, gdp_priv_ind_pc,gdp_govt_pc, 
         gdp_total_pc, gdp_priv_ind_pc, gdp_govt_pc) %>% 
  filter(!complete.cases(.))
       
# No missing values in coal counties - replaced other counties NA values with 0  
mines_df %>% 
  select(fips, year, total_n, diff_total_active_n, l1_diff_total_active_n, l2_diff_total_active_n, diff_total_active_prod, l1_diff_total_active_prod, l2_diff_total_active_prod) %>% 
  ungroup %>% filter(!complete.cases(.)) 

  
# exog <- c(" ~ diff_total_active_n + l1_diff_total_active_n + l2_diff_total_active_n + realgdp_pc",
#           " ~ diff_total_active_prod + l1_diff_total_active_prod + l2_diff_total_active_prod + realgdp_pc",
#           " ~ i(ruc_bin, diff_total_active_n) + i(ruc_bin, l1_diff_total_active_n) + i(ruc_bin, l2_diff_total_active_n) + realgdp_pc",
#           " ~ i(ruc_bin, diff_total_active_prod) + i(ruc_bin, l1_diff_total_active_prod) + i(ruc_bin, l2_diff_total_active_prod) + realgdp_pc")
# 
# exog_list <- c("diff_total_active_n + l1_diff_total_active_n + l2_diff_total_active_n",
#           "diff_total_active_prod + l1_diff_total_active_prod + l2_diff_total_active_prod",
#           "i(ruc_bin, diff_total_active_n) + i(ruc_bin, l1_diff_total_active_n) + i(ruc_bin, l2_diff_total_active_n",
#           "i(ruc_bin, diff_total_active_prod) + i(ruc_bin, l1_diff_total_active_prod) + i(ruc_bin, l2_diff_total_active_prod)")
#         
#            # Levels & First differences
dep <- c("Total_Rev_Own_Sources_pp", "diff_Total_Rev_Own_Sources_pp",
         "Total_IG_Revenue_pp", "diff_Total_IG_Revenue_pp",
         "Total_Taxes_pp","diff_Total_Taxes_pp",
         "Property_Tax_pp", "diff_Property_Tax_pp",
         "Total_Educ_Current_Exp_pp",  "diff_Total_Educ_Current_Exp_pp")

#forms <- paste0(rep(dep, each = length(exog)), exog)


```

```{r, echo = FALSE}
mines_df <- mines_df %>% 
  filter(year >= 2001) %>% 
  #mutate(ruc_bin = as.factor(ruc_bin)) %>% 
  mutate(across(all_of(dep), ~.*1000),
         time = year - 2000) %>% 
  mutate(across(contains("log"), ~ifelse(is.infinite(.), 0, .)),
         across(c(log_esa_tot_exp_pp, log_esa_tot_exp), ~ifelse(is.na(.), 0, .)))

#spec <- function(form, df){
#  feols(as.formula(paste0(form, " | fips + year")), data = df, se = "cluster", cluster = "fips") %>% return(.)
#}

#reg_results <- lapply(forms, function(x) spec(x, mines_df_02_19))

#for(f in forms){
#  return(spec(f, mines_df_02_19))
#}
# 
# reg_fixest <- feols(.[dep] ~ sw(diff_total_active_n + l1_diff_total_active_n + l2_diff_total_active_n,
#           diff_total_active_prod + l1_diff_total_active_prod + l2_diff_total_active_prod,
#           i(ruc_bin, diff_total_active_n, ref = 0) + i(ruc_bin, l1_diff_total_active_n, ref = 0) + i(ruc_bin, l2_diff_total_active_n, ref = 0),
#           i(ruc_bin, diff_total_active_prod, ref = 0) + i(ruc_bin, l1_diff_total_active_prod, ref = 0) + i(ruc_bin, l2_diff_total_active_prod, ref = 0)) + realgdp_pc | fips + year, data = mines_df_02_19, se = "cluster", cluster = "fips")
# 
# len = 1:length(dep)
# 
# for(rd in subset(len, len %% 2 == 0)){
#   etable(reg_fixest[lhs = rd-1:rd], tex = TRUE) %>% print
# }
# 
# for(rd in subset(len, len %% 2 == 1)){
#   etable(reg_fixest[lhs = dep[rd]], tex = TRUE) %>% print
# }
```


# Descriptive, underlying regression models

```{r}
# Descriptive regressions: Total Educ Current Expenditure
list(feols(log_Property_Tax ~ log_gdp_total | fips + year, data = mines_df, se = "cluster", cluster = "fips"),
     feols(log_Property_Tax_pp ~ log_gdp_total_pc | fips + year, data = mines_df, se = "cluster", cluster = "fips")) %>% etable

feols(log_Total_Educ_Current_Exp ~ sw(log_gdp_total,
                                      log_gdp_priv_ind,
                                      log_gdp_o_g_mining_quarr_21,
                                      log_esa_tot_exp, 
                                       log_Total_Rev_Own_Sources + log_Total_IG_Revenue, 
                                       log_Property_Tax, 
                                       log_Property_Tax + log_Total_IG_Revenue,
                                       log_Property_Tax + log_Total_Fed_IG_Revenue + log_State_IGR_Education) | fips + year, data = mines_df, se = "cluster", cluster = "fips") %>% etable

feols(log_Total_Educ_Current_Exp_pp ~ sw(log_gdp_total_pc,
                                         log_gdp_priv_ind_pc,
                                         log_gdp_o_g_mining_quarr_21_pc,
                                         log_esa_tot_exp_pp,
                                         log_Total_Rev_Own_Sources_pp + log_Total_IG_Revenue_pp,
                                         log_Property_Tax_pp, 
                                         log_Property_Tax_pp + log_Total_IG_Revenue_pp, 
                                         log_Property_Tax_pp + log_Total_Fed_IG_Revenue_pp + log_State_IGR_Education_pp) | fips + year, data = mines_df, se = "cluster", cluster = "fips") %>% etable

```

## Incorporating state-level trends
```{r}
# Expenditure dependent on revenue streams levels
feols(log_Total_Educ_Current_Exp ~ sw(log_gdp_total, 
                                      log_gdp_priv_ind,
                                      log_gdp_o_g_mining_quarr_21) + time:as.factor(state) | fips + year, data = mines_df, se = "cluster", cluster = "fips") %>%  etable(., drop = "time*")


# Expenditure dependent on revenue streams levels
feols(log_Total_Educ_Current_Exp_pp ~ sw(log_gdp_total_pc, 
                                      log_gdp_priv_ind_pc,
                                      log_gdp_o_g_mining_quarr_21_pc) + time:as.factor(state) | fips + year, data = mines_df, se = "cluster", cluster = "fips") %>%  etable(., drop = "time*")
```


## Incorporating time lags
```{r}
levs_gdp_real_trend <- feols(log_Total_Educ_Current_Exp ~ sw(log_gdp_total + log_gdp_total_l1 + log_gdp_total_l2, log_gdp_priv_ind + log_gdp_priv_ind_l1 + log_gdp_priv_ind_l2) + time:as.factor(state) | fips + year, data = mines_df, se = "cluster", cluster = "fips")
levs_gdp_real_trend %>% etable(., drop = "time*")

feols(log_Total_Educ_Current_Exp ~ sw(log_gdp_total_pc + log_gdp_total_pc_l1 + log_gdp_total_pc_l2, 
                                      log_gdp_priv_ind_pc + log_gdp_priv_ind_pc_l1 + log_gdp_priv_ind_pc_l2,
                                      log_gdp_o_g_mining_quarr_21 + log_gdp_o_g_mining_quarr_21_l1 + log_gdp_o_g_mining_quarr_21_l2) + time:as.factor(state) | fips + year, data = mines_df, se = "cluster", cluster = "fips") %>%  etable(., drop = "time*")


# Expenditure dependent on revenue streams levels
feols(log_Total_Educ_Current_Exp_pp ~ sw(log_gdp_total_pc + log_gdp_total_pc_l1 + log_gdp_total_pc_l2, 
                                      log_gdp_priv_ind_pc + log_gdp_priv_ind_pc_l1 + log_gdp_priv_ind_pc_l2,
                                      log_gdp_o_g_mining_quarr_21_pc + log_gdp_o_g_mining_quarr_21_pc_l1 + log_gdp_o_g_mining_quarr_21_pc_l2) + time:as.factor(state) | fips + year, data = mines_df, se = "cluster", cluster = "fips") %>%  etable(., drop = "time*")

```

# Coal Production Data
We restrict the dataset to 2001:2019 as mine data is currently collected until 2019.
```{r}

mines_df_02_19 <- mines_df %>% 
  filter(year %in% 2001:2019)

```


# Full panel model

```{r, message = FALSE}

list(feols(log_Total_Educ_Current_Exp_pp ~ log_gdp_priv_ind_pc + log_gdp_priv_ind_pc_l1 + log_gdp_priv_ind_pc_l2 + diff_total_active_n + l1_diff_total_active_n + l2_diff_total_active_n | fips + year, data = mines_df_02_19, se = "cluster", cluster = "fips"),
feols(log_Total_Educ_Current_Exp_pp ~ sw(log_gdp_priv_ind_pc + log_gdp_priv_ind_pc_l1 + log_gdp_priv_ind_pc_l2 + diff_total_active_prod + l1_diff_total_active_prod + l2_diff_total_active_prod,
                                         log_gdp_total_pc + log_gdp_total_pc_l1 + log_gdp_total_pc_l2 + diff_total_active_n + l1_diff_total_active_n + l2_diff_total_active_n,
                                         log_gdp_total_pc + log_gdp_total_pc_l1 + log_gdp_total_pc_l2 + diff_total_active_prod + l1_diff_total_active_prod + l2_diff_total_active_prod) | fips + year, data = mines_df_02_19, se = "cluster", cluster = "fips")) %>% etable


list(feols(log_Total_Educ_Current_Exp_pp ~ log_gdp_priv_ind_pc + log_gdp_priv_ind_pc_l1 + log_gdp_priv_ind_pc_l2 + l(total_active_n, 0:2)  | fips + year, data = mines_df_02_19, se = "cluster", cluster = "fips", panel.id = ~fips+year),
     feols(log_Total_Educ_Current_Exp_pp ~ sw(log_gdp_priv_ind_pc + log_gdp_priv_ind_pc_l1 + log_gdp_priv_ind_pc_l2 + l(total_active_prod, 0:2),
                                         log_gdp_total_pc + log_gdp_total_pc_l1 + log_gdp_total_pc_l2 + l(total_active_n, 0:2),
                                         log_gdp_total_pc + log_gdp_total_pc_l1 + log_gdp_total_pc_l2 + l(total_active_prod, 0:2)) | fips + year, data = mines_df_02_19, se = "cluster", cluster = "fips", panel.id = ~fips+year)) %>% etable

```

# getspanel

```{r, include = FALSE}

# isatpanel(data = mines_df_02_19, 
#           formula = "Total_Educ_Current_Exp_pp ~ gdp_total_pc + gdp_priv_ind_pc + gdp_o_g_mining_quarr_21_pc + gdp_govt_pc",
#           index = c("fips","year"),
#          iis = TRUE,
#          t.pval =0.01
#          # SIS = TRUE 
#           )

```

# Instrumental Variable Testing

```{r, message = FALSE}

feols(log_Total_Educ_Current_Exp_pp ~ log_gdp_total_pc | fips + year | log_Property_Tax_pp ~ total_active_prod, data = mines_df_02_19, se = "cluster", cluster = "fips")
feols(log_Total_Educ_Current_Exp_pp ~ log_gdp_total_pc | fips + year | log_Property_Tax_pp ~ l(total_active_prod,1), data = mines_df_02_19, se = "cluster", cluster = "fips", panel.id = ~fips+year)

feols(log_Total_Educ_Current_Exp_pp ~ log_gdp_total_pc | fips + year | log_Property_Tax_pp ~ total_active_n, data = mines_df_02_19, se = "cluster", cluster = "fips")
feols(log_Total_Educ_Current_Exp_pp ~ log_gdp_total_pc | fips + year | log_Property_Tax_pp ~ l(total_active_n,1), data = mines_df_02_19, se = "cluster", cluster = "fips", panel.id = ~fips+year)
feols(log_Total_Educ_Current_Exp_pp ~ log_gdp_total_pc | fips + year | log_Property_Tax_pp ~ total_active_n, data = mines_df_02_19, se = "cluster", cluster = "fips")
feols(log_Total_Educ_Current_Exp_pp ~ log_gdp_total_pc | fips + year | log_Property_Tax_pp ~ l(total_active_n,1), data = mines_df_02_19, se = "cluster", cluster = "fips", panel.id = ~fips+year)

```


# Bartik Instrument
```{r}

```

