---
title: "Uneven Wage Growth and Public Goods"
subtitle: "The Case of US Public Education"
author:
  - name: Ebba Mark
    affiliation: University of Oxford
abstract: |
  This study estimates the elasticity of public education expenditure to changes in local economic conditions and livelihoods, offering insights into public service provision within a political economy marked by an uneven industrial landscape and rising income inequality. Over recent decades, the United States has experienced increasingly divergent patterns of economic and wage growth. Wage growth is a key driver of local wealth accumulation, enabling greater household and community investment in public goods. It is frequently posited that regions whose wages track productivity gains tend to benefit from broader economic growth, while lagging regions risk weaker savings capacity and declining support for public services. Using a shift–share instrumental variable design, we examine how uneven wage growth affects public education spending across the US. Accounting for both observable and unobservable heterogeneity in state-level tax regimes, income, and economic growth, we find that this heterogeneity explains majority of the identified elasticity of education expenditure to wages. These results provide insight into region- and state-specific adjustments that can be made to ensure that uneven economic development and structural transformation does not exacerbate existing inequalities in public service delivery in the United States. Furthermore, these results underscore the importance of moving beyond average treatment efffects in panel regression studies to more careful specification choices. \textcolor{violet}{We further contribute to the shift–share literature by emphasizing the potential for model misspecification and the importance of interpreting instrument choice jointly with causal treatment effects.}
  
format:
  pdf:
    documentclass: article
    toc: true
    number-sections: true
    fontsize: 10pt
    pdf-engine: xelatex
    include-in-header: header.tex
editor: 
  markdown: 
    wrap: 72
bibliography: pub_fin_md.bib
---

```{r setup-appendix-writer, include=FALSE}

library(here)

appendix_file <- "appendix_generated.qmd"

# Initialize the file with appendix header only (overwrite if exists)
writeLines(c(
  "# Appendices {-}",
  "",
  "```{=latex}",
  "\\appendix",
  "```",
  ""
), here(paste0("code/", appendix_file)))


# Append Qmd code chunks to appendix
append_to_appendix <- function(title, description_lines) {
  chunk_label <- knitr::opts_current$get("label")
  lines <- c(
    title,
    "",
    paste(description_lines, collapse = "\n"),
    "",
    sprintf("```{r, ref.label='%s', echo = FALSE, eval=TRUE, results = 'asis'}", chunk_label),
    "```",
    ""
  )
  write(lines, file = here("code", appendix_file), append = TRUE)
}

# Append additional tex SI files
append_to_appendix_tex <- function(tex_file) {
    lines <- c(
    "",
    "```{=latex}",
    paste0("\\input{", tex_file, "}"),
    "```",
    ""
  )
  write(lines, file = here("code", appendix_file), append = TRUE)
}

```

```{r si_tex_docs, include = FALSE, echo = FALSE}

append_to_appendix_tex(here("code/si_tex_docs/si.tex"))

```

# Working Notes {#sec-procedural-notes}

\textcolor{violet}{The following are notes to keep in mind while the project is still underway.}

Items to be adjusted:

\begin{itemize}
  \item Include additional control variables (migration, poverty, race, rurality, home ownership rates, private school enrollment)
  \item Local CPI. Do I need to correct for local price levels?
  \item Spatial autocorrelation term
  \item Run gets on central model with CFESIS (preliminary testing indicates coefficient breaks in 2006 and 2013 which neatly bookends the financial crisis/housing market collapse - interesting?)
  \item Separate shift-share on more coarse industrial categories (ie. high and low-wage areas correcting for local CPI) - in other words, to better answer the research question, divide industries by those whose wages line up with productivity growth and those that do not?
  \item Coefficient interpretation in the IV regressions are odd (elasticities > 1). I think this either results from not normalising employment shares when calculating the shift-share instrument or not properly dealing with the commuting zones where there is a high degree of missing data in local employment share data (See first histogram Figure 2).
  \item Label Figures and Tables. Figure out referencing in Quarto Markdown.
\end{itemize}

Note: Any warnings about "missing observations" or "NA being removed"
relates to the lags incorporated.

# Introduction

\textcolor{violet}{I follow the template for writing introductions to economics papers [here](https://www.cgdev.org/blog/how-write-introduction-your-development-economics-paper) - the headings guide the structure of the intro but will be removed later.}

\textcolor{violet}{I am compiling this in Quarto Markdown and have yet to figure out how to reference my tables. Please excuse lack of referencing to regression tables and figures at the moment.}

### Motivate with a puzzle or a problem (1–2 paragraphs)

**Since the 1970s, a persistent divergence between productivity growth and wage growth has emerged in the United States.** While labour productivity has continued to rise, the earnings of typical workers have increased far more slowly, leading to a substantial decoupling between the two trends. Summers and Stansbury (2018) argue that productivity growth still exerts a positive influence on wages overall, but that institutional and structural changes have weakened the link for large segments of the workforce. They point to declining union density, erosion of the minimum wage, globalization, and increased market concentration as key factors that have shifted bargaining power away from workers and reduced labour’s share of national income. Furthermore, additional evidence finds that this decoupling is far from a universal phenomenon. Rather, decoupling applies almost strictly to lower- and medium-wage earners, while already higher wages manage to keep up (relatively) with productivity growth rates. 

This body of work underscores that the relationship between pay and productivity is contingent, and that productivity growth, while necessary, is not sufficient to secure broad-based improvements in living standards. **The direct consequences of this decoupling are clear.** Productivity growth is not sufficient to secure broad-based improvement in living standards and where inequality is not spatially segregated, and high- and low-income households share the same local markets, the divergence between wages and productivity is likely to generate upward pressure on prices that disproportionately burdens lower- and middle-income earners. 

**A link that has been far less explored in this context is the spillover effect of local wage levels to local wealth-building and its effect on public goods.** Diverging economic and wage growth poses potentially severe consequences for local wealth-building which still relies on wages for lower- and middle-income familes and communities. Wage growth is an important contributor to local wealth-building, allowing households and communities to invest more in local public goods. Communities whose wages rise in line with productivity growth will likely reap the benefits of economic growth whereas those who do not, risk falling behind. This link is particularly important in the US given the structure of local public financing. Majority of local public services are funded via property taxes. This funding structure entrenches a mechanism for generating inequality of opportunity between diversely affluent regions of the country. Put plainly, given the structure of US public services, wherein they are funded largely through property taxes and thus tied to on asset values, inequality in wealth-building can have significant effects for the quality of local public services. 

This study therefore aims to determine whether an elasticity of public expenditure to local economic growth exists. If productivity gains translate unevenly into wages across industries and regions, then the fiscal capacity of local governments may be shaped as much by institutional and structural conditions as by aggregate economic growth.

**Community well-being and public expenditure in the US is already characterised by a high degree of
spatial heterogeneity.** Not only does the US consistently rank among
the top five most unequal OECD countries [^1], evidence of how
income and wealth inequality perpetuate other forms of inequality
(opportunity, health, infrastructure quality, and broader well-being) is
steadily increasing (@chetty2016, @logan2012, @semuels2016,
    @Avancena2021, @flavin2009). @boustanEffectRisingIncome2013 find that greater income inequality leads
to higher public expenditure across all public goods indicating that a
presence of higher-earners in a local area contributes to higher levels
of expenditure. Though this does not support an unambiguous denunciation
of inequality as such, it provides additional evidence for the fact that
local incomes affect public expenditure raising the potential for
"superstar" and "left behind" regions to emerge absent significant and
even income growth.


[^1]: The US consistently ranks among the top 5 most unequal countries
    in the OECD alongside Turkey, Mexico, Chile, and Costa Rica across
    all relevant indicators reported by the OECD: Gini coefficient,
    three interdecile income ratios (P50/P10; P90/P10; P90/P50), Palma
    ratio, S80/S20 quintile share.

**Economic history and industrial activity have
heterogeneously impacted the development trajectories of US regions.**

**One public service that has particularly important ties to ensuring
generational resilience to economic decline is education.** Public
schools around the US are responsible for educating over 80% of
school-age children. In 2019, governments around the US (including the
federal government) spent a total of \$870 billion on public education,
roughly \$17,013 per pupil @nationalcenterforeducationstatistics2023 . However, the quality of services delivered varies widely across the
country. In 2016, for example, the Connecticut State Department of
    Education reported that the town of Greenwich, one of the
    highest-income towns in the country, spent \$8,000 more per pupil
    than Bridgeport (\$21.9k versus \$13.7k per pupil), despite both
    towns being part of the same county, located less than 40 kilometers
    apart @semuels2016, and competing in academic and extra-curricular activities.

The quality of public education, especially at an early age, can have
long-lasting consequences for personal and economic well-being over an
individual's lifetime as well as generations following them (@alfonso2020). Therefore, ensuring that local or regional economic decline does not
disrupt or worsen the quality of education delivered is of paramount
importance to ensure greater equality in the long-run. [^3] [^4] [^5a]

[^3]: Perhaps the most prominent and often-cited relationship between
    education and extractive industries is through the lens of the
    'resource curse.' The validity and empirical existence of a
    'resource curse' has been tested since its conception with disparate
    results [@ahlerup2020, @badeeb2017, @blanco2012, @borge2015,
    @brunnschweiler2008, @cockx2014, @cockx2016, @deacon2011,
    @dialga2022, @douglas2017, @haber, @menaldo2016, @ross2018,
    @ross2015, @sincovich2018, @wiens2014]. The literature is divided
    into two strands focusing on either political (the relationship
    between resource wealth and governance) [@ross2015, @ross2015,
    @wiens2014, @deacon2011] or economic (the relationship between
    resource wealth and economic growth or human capital) resource
    curses. Empirical investigation of the economic resource curse has
    explored the effect of resource dependence on economic growth,
    public health and education expenditure and outcomes, mainly at a
    national level [@borge2015, @cockx2016, @douglas2017,
    @sincovich2018]. In the case of education, the distinct outcome
    measured is level of educational attainment, in other words, whether
    the presence of a booming resource extraction economy provides
    disincentives to education for young people. It is worth noting that
    this literature has been repeatedly questioned on theoretical and
    conceptual grounds as institutional context often dictates whether a
    resource curse exists and empirical analyses seem to be very
    sensitive to methodological choices [@ross2018, @ross2015,
    @dialga2022]. Although awareness of this strand of literature is of
    relevance to this work, the unresolved nature of the 'debate'
    surrounding its existence requires caution if eventually utilised as
    a theoretical framework for answering the research question.

[^4]: @ahlerup2020 find that for 30 countries in Africa, the presence of
    gold mines during adolescence have a significant effect on
    educational attainment. @badeeb2017 investigates whether resource
    dependence slows economic growth with no explicit mention of
    education. @blanco2012 find that in Latin America, petroleum export
    has a significant long-run negative relationships with human
    capital. @borge2015 find support for the paradox of plenty
    hypothesis in Norway - that higher local public revenue negatively
    affects the efficiency of local public good provision.
    @brunnschweiler2008 critically evaluate 'the empirical basis for the
    so-called resource curse and find that, despite the topic's
    popularity in economics and political science research, this
    apparent paradox may be a red herring. The most commonly used
    measure of “resource abundance” can be more usefully interpreted as
    a proxy for “resource dependence”-endogenous to underlying
    structural factors. In multiple estimations that combine resource
    abundance and dependence, institutional, and constitutional
    variables, we find that (i) resource abundance, constitutions, and
    institutions determine resource dependence, (ii) resource dependence
    does not affect growth, and (iii) resource abundance positively
    affects growth and institutional quality.' @cockx2014 use a panel on
    140 countries from 1995-2009 and find an inverse relationship
    between resource dependence and and public health spending over
    time. @cockx2016 investigate a panel of 140 countries from 1995-2009
    to find an adverse effect of resource depdence on public education
    expenditures relative to GDP. @dialga2022 find disparate results for
    health and education controlling for institutional quality.
    @douglas2017 "measure the effect of resource-sector dependence on
    long-run income growth using the natural experiment of coal mining
    in 409 Appalachian counties selected for homogeneity. Using a panel
    data set (1970–2010), we find a one standard deviation increase in
    resource dependence is associated with 0.5–1 percentage point
    long-run and a 0.2 percentage point short-run decline in the annual
    growth rate of per capita personal income. We also measure the
    extent to which the resource curse operates through disincentives to
    education, and find significant effects, but this “education
    channel” explains less than 15 percent of the apparent curse.'
    @haber focus on authoriarian regimes. @menaldo2016 argues again that
    this is an institutions curse and not a resource curse issure.
    @sincovich2018 provide a literature review of resource curse
    investigations in the Australian context.
    
[^5a]: One investigation assessed the dependence of local public revenues on fossil fuel production finding that such production generated about \$138
billion annually for US localities, states, tribes, and the federal
government @raimi2022 . This amount is forecast to decline by 2050 even
in a business-as-usual scenario (assuming no changes in climate policy
stringency). Wyoming, North Dakota, Alaska, and New Mexico are the
states most dependent on fossil fuel revenues with at least 14% of state
and local revenues generated from the fossil fuel industry (Wyoming's
dependence is above 50%). The work makes a demonstrative statement about
the link between this revenue stream and essential services like
schools, public health, and infrastructure, but stops short of an
empirical analysis into the impact of fossil fuel decline on revenues
and associated expenditure, even at the state level.

    
### Clearly state your research question (1 paragraph)

Altogether, this evidence points to the value of identifying the extent
to which expenditure on public education is reliant on local economic
health, measured in wages and real value added, across the country. This work aims to answer the following research questions:

*RQ1:* Over the last twenty years, has wage inequality impacted local public education expenditure?

*RQ2:* Do intergovernmental transfers alleviate wealth-driven
inequalities in public education expenditure?

\textcolor{violet}{*RQ3:* Can accounting for non-constant relationships between explanatory
variables improve our understanding of the relationship between public
goods and uneven economic growth?}

### Empirical approach (1 paragraph)

This work interrogates the elasticity of public education expenditure to uneven economic and wage growth across US commuting zones. We leverage the structure of public finance, where local revenues are drawn primarily from property taxation, to construct an instrumental variable design via a shift-share instrument. 

We construct a shift-share (Bartik) instrument that combines fixed local industry employment shares with national industry-level changes in wages and real value added. Following the established literature [@bartik1991; @goldsmith-pinkham2020; @ferri2022], we fix local employment shares to a baseline period and interact them with national growth rates in industry wages and real value added. Using data from the U.S. Bureau of Labor Statistics and Bureau of Economic Analysis, we construct commuting-zone-level Bartik instruments based on both outcomes. This provides a credible and transparent identification strategy that links macroeconomic shocks to local education funding. 

This strategy generates plausibly exogenous local variation by exploiting how different regions are differentially exposed to common national trends, while abstracting from endogenous local dynamics. It is particularly well suited in this setting, since the local tax base, and thus education spending, depends heavily on industries that are unevenly distributed across regions but likely subject to similar industry-specific wage shocks. Finally, we use this instrument to identify the effect of shocks to this instrument on local public education expenditure as reported in a panel dataset from the Annual Survey of State and Local Government Finances.

The outlined instrumental variable strategy tackles the central endogeneity challenge present in any study of the linkage between local economic growth and measures of well-being. In the context of this study, wages and public education expenditure are undoubtedly exogenous, since higher-income families may self-select into districts with greater education spending, confounding causal inference. Therefore, we instrument local wages with the constructed shift-share instruments to circumvent this challenge allowing for plausibly causal inference.

Given the substantial heterogeneity across U.S. states-arising both from structural sources (such as differences in tax systems, regulatory environments, and legislative institutions) and from evolved characteristics (including industrial composition, income levels, inequality, and broader measures of economic diversity) the scope for identifying a single, well-defined national average treatment effect is inherently limited. We provide an initial benchmark using a pooled estimation to establish baseline relationships between wages, GDP, and asset values that appear to generalize reasonably across the national economy, before investigating the htereogeneity that these pooled estimates mask in our main analysis. Centrally, we employ an instrumental variable design using wage and GDP-based shift share instruments to identify the dependence of local public education expenditure on local economic prosperity. We further advance this analysis via state-by-state and industry-by-industry estimations which allow for industry and region-specific results to emerge. Furthermore, we group commuting zones by their historic growth trajectories to improve comparability of treatment and control groups in our instrumental variable design as well as emphasize context-specific outcomes. 

### Detailed results (3–4 paragraphs)

1. Public education expenditure is not agnostic to local economic conditions. Across all estimations, we find a strong positive relationship, both descriptive and causal, between wages, property values, GDP and local public expenditure. This result contributes to the wealth of evidence demonstrating the inequality of public education services across the US.
2. We establish a causal link between public education expenditure and local wage and industry value added growth using a shift-share exposure treatment estimation. 
3. \textcolor{violet}{State-level estimation result.}
4. \textcolor{violet}{Industry-level estimation result.}
5. \textcolor{red}{Incorporate analysis about diverging growth rates to link to intro. Would be nice to contribute to this debate.}

### Value-added relative to related literature (1–3 paragraphs)

### Optional paragraphs: robustness checks, policy relevance 

### Roadmap (1 paragraph)

In the sections that follow, we outline in @sec-data the data to be used
in the analysis; @sec-methods the methodological approach with accompanying results; @sec-discussion and @sec-conclusion provide a discussion and concluding remarks.

```{r, echo = FALSE, message = FALSE, cache = FALSE, include = FALSE, eval = TRUE}

options(width = 500)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(conflicted)
library(stargazer)
library(quantreg)
library(purrr)
library(zoo)
library(tidycensus)
library(here)
library(viridis)
library(viridisLite)
library(datasets)
library(broom)
library(xtable)
library(fipio)
library(panelvar)
library(fixest)
library(paletteer)
library(readxl)
library(ggrepel)
library(plm)
library(getspanel)
library(usmap)
library(patchwork)
library(kableExtra)
library(lattice)
library(lubridate)
library(stringr)
library(xts)
library(urca)
library(dynlm)
library(tseries)
library(quantmod)
library(lmtest)
library(sandwich)
library(patchwork)
library(vars)
library(assertthat)
library(ggridges)
library(grid)
library(RColorBrewer)
library(ggplotify)
source(here('code/source_code/useful_functions.R'))
source(here('code/source_code/dicts.R'))
source(here('code/reg_forms.R'))
source(here('code/source_code/cz_cleaning.R'))
conflict_prefer_all("dplyr", quiet = TRUE)

setFixest_etable(fitstat = ~ . + ivf1 + ivf1.p + ivf2 + ivf2.p + wh + wh.p + ivwaldall + ivwaldall.p + kpr, se.below = TRUE)

# Custom R2 representation for IV regressions - only want to display R2 for second-stage
fitstat_register(
  type = "r2_firststage",
  fun = function(m) {
    is_second_stage <- any(grepl("^fit_", names(coef(m))))
    if (is_second_stage) return(NA_real_)
    unname(r2(m, "r2"))  # standard R²
  },
  alias = "R2 (1st stage)"
)
# Custom Adjusted R² for 1st stage only
fitstat_register(
  type = "ar2_firststage",
  fun = function(m) {
    is_second_stage <- any(grepl("^fit_", names(coef(m))))
    if (is_second_stage) return(NA_real_)
    unname(r2(m, "ar2")) # adjusted R²
  },
  alias = "Adj. R2 (1st stage)"
)

iv_fitstats = ~ n + r2_firststage + ar2_firststage + ivfall + ivfall.p + wh + wh.p + ivwaldall + ivwaldall.p

default_iv_note = c("", "Note that the R2 and Adjusted R2 values for second-stage regressions are irrelevant information here. I have not yet figured out how to suppress them from the regression tables but will do so for the final version.")

unit_id = "cz_id"
new_ss_calculation = FALSE
latex_tables = TRUE

source(here("code/source_code/pull_data.R"))

```


# Data {#sec-data}

We compile a panel dataset of 636 commuting zones across 40 US states between 2001-2021 including the following metrics:

**Expenditure and Revenue:** This work employs Willamette University's Annual Government Finance
Database at the commuting zone (CZ) level. This resource is a harmonised
repository of the data collected annually as part of the US Census
Bureau's Annual Survey of State & Local Government Finances, the 'only
comprehensive source of information on the finances of local governments
in the United States' (@pierson). The data includes commuting-zone level revenue and expenditure on public
education including disaggregated values by revenue source (federal,
state, or other intergovernmental revenue) and expenditure item
(lunches, wages, debt). All values are reported in real US dollars. The
data for property taxes collected used in regressions below also come
from this dataset. Expenditure on vocational training and from
Educational Service Agencies (ESAs) are also sourced from this dataset.
We aggregate school district measures up
to the commuting zone-level to ensure the availability of adequate
control and treatment variables. [^5]

[^5]: The database is provided for six different levels of government:
    state, county, municipal, township, special district, and school
    district. Reporting is only mandated in Census years (every five
    years), and even then missing data remains a challenge. This means
    that data provided at any other level of government suffers from
    significant levels of missing data, with a high level of selection
    bias correlated with administrative capacity. However, strengthened
    by a partnership with the National Center for Education Statistics,
    observations for US school districts exhibit near-complete coverage
    between 1997-2021 (@pierson). We choose to conduct the analysis on the
    commuting zone level because (1) it is a more accurate picture of a
    local labor market area (@carpenterWhenUseCommuting2022) and (2) a
    lack of availability of control variables at a school district
    level.

Thus, this dataset provides estimates in \$USD on total public
school revenue disaggregated by source (federal, state, local
intergovernmental versus own local sources) and expenditure
disaggregated by item (level of schooling, teacher salaries, debt,
etc.).

**Population controls:** US Census Bureau.

**GDP Controls:** Finally, we gather GDP control variables from the Bureau of
Economic Analysis (BEA). This BEA data is only available after 2001,
therefore the panel reported and used below is restricted to 2001-2021. The controls
used in the below are commuting zone-level private industry GDP. We
decide to use private industry GDP as a control variable given the
remaining portion of GDP is government expenditure which includes
education expenditure.

**Property Prices:** The US Federal Housing Financy Agency provides a
geographically linked data on single-family house prices called the
Housing Price Index. HPI is a broad measure of the movement of
single-family house prices. The FHFA HPI is a weighted, repeat-sales
index, meaning that it measures average price changes in repeat sales or
refinancings on the same properties. This information is obtained by
reviewing repeat mortgage transactions on single-family properties whose
mortgages have been purchased or securitized by Fannie Mae or Freddie
Mac since January 1975 [Source](https://www.fhfa.gov/data/hpi). It is
reported at the county level at an annual frequency. We aggregate to the
commuting zone level via a mean.
\textcolor{red}{Should do a population weighted average.}

This data aggregation results in a complete and balanced panel of 636 US commuting zones across 40 states
between 2001-2021. [^6] [^7]

[^6]: The reason 13% of CZs are missing from the dataset is because of
    (1) the exclusion criteria already outlined; (2) Hawaii and Alaska
    have been excluded due to the methodological challenge of
    incorporating their school districts into spatial econometric work;
    and (3) Connecticut, Maryland, North Carolina, and Virginia have
    been excluded due to unconventional or incomplete public school
    district reporting. \textcolor{red}{We aim to resolve this, especially in the case of
    Virginia given its relatively high rates of employment in the coal
    sector.}

[^7]: Given the work's intent to rely on data on property taxes
    collected, any CZ that reports more than five 0 values for property
    taxes collected is excluded.

All data used is reported annually at the commuting zone level. [^8]

[^8]: In line with similar work on US economic geography, commuting
    zones were chosen as the unit of analysis as they are a far less
    arbitrary and more accurate representation of local labour market
    areas/economies
    ( {https://www.ddorn.net/data.htm\\#Local\\%20Labor\\%20Market\\%20Geography}(David
    Dorn's Resource Page),
    {https://www.nature.com/articles/s41597-024-03829-5}(Fowler et
    al. 2024) ).

Therefore, no time-invariant variables are included (apart from an indicator of the
state a CZ is in).

<!-- **Coal mine activity and production levels:** Mine Safety and Health -->

<!-- Administration -->

```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.height = 10, cache = TRUE}

mean_df <- mines_cz %>% 
  group_by(year) %>%
             summarise(real_Total_Educ_Total_Exp = mean(real_Total_Educ_Total_Exp, na.rm = TRUE),
                       real_Total_Educ_Total_Exp_pp = mean(real_Total_Educ_Total_Exp_pp, na.rm = TRUE),
                       real_log_Total_Educ_Total_Exp = mean(log_real_Total_Educ_Total_Exp, na.rm = TRUE),
                       real_log_Total_Educ_Total_Exp_pp = mean(log_real_Total_Educ_Total_Exp_pp, na.rm = TRUE))

```

## Summary statistics

```{r, eval = FALSE, echo = FALSE, cache = FALSE}

is.pbalanced(mines_cz, index = c("cz_id", "year"))

```

Table 1 reports summary statistics across relevant variables. All (dollar) values are reported in (real 2017-chained) thousands.

```{r, results = 'asis', cache = TRUE, message = FALSE}

# Variables of interest for descriptive statistics
vars <- c("Property_Tax", "Total_IG_Revenue", "Total_Fed_IG_Revenue", "Total_State_IG_Revenue", "Total_Educ_Total_Exp", "Elem_Educ_Total_Exp") # Total_Revenu

mines_cz %>%
  select(Enrollment, pop_total, real_Elem_Educ_Total_Exp_pp, real_Property_Tax_pp, real_Total_IG_Revenue_pp,# real_Total_Fed_IG_Revenue_pp, 
         real_Total_State_IG_Revenue_pp, 
         real_gdp_total_pc, real_gdp_priv_ind_pc, #real_gdp_o_g_mining_quarr_21_pc, 
         hpi) %>% 
         #real_Elem_Educ_Total_Exp, real_Property_Tax, real_Total_IG_Revenue, real_Total_Fed_IG_Revenue, 
         #real_Total_State_IG_Revenue, real_gdp_total, real_gdp_priv_ind, real_gdp_o_g_mining_quarr_21, total_active_n, total_active_prod) %>% 
  mutate(across(c(Enrollment, pop_total), ~./1000)) %>%  # gdp_govt, 
          data.frame() %>%
          stargazer(digits = 2, digits.extra = 3, 
                    type = ifelse(latex_tables, "latex", "text"), covariate.labels = c(
         "Enrollment",
         "Population",
         "Elem. Expenditure per pupil",
         "Property Tax per pupil",
         "IG Revenue per pupil", 
         #"Federal IG Revenue per pupil", 
         "State IG Revenue per pupil",
         "GDP per capita",
         "GDP pc - Private Industry",
         "House Price Index"),
         header = FALSE)
         #"GDP pc - Oil, gas, mining",
         #"Elem. Expenditure",
         #"Property Tax",
         #"IG Revenue", 
         #"Federal IG Revenue", 
         #"State IG Revenue",
         #"GDP",
         #"GDP - Private Industry", 
         #"GDP - Oil, gas, mining",
         #"Active Coal Mines",
         #"Coal Produced (k short tons)"))


```

<!-- ##Descriptive Regression Results - Appendix -->

```{r appendix1, include = FALSE, echo = FALSE, results = 'asis'}

append_to_appendix("# Descriptive Regression Results",
"In the following set of results, I report descriptive regressions to establish relationships between property taxes, education expenditure, GDP (total, private industry, O&G&mining), etc.
All regression models that follow include TWFE (CZ- and year- fixed effects) and standard errors clustered by commuting zone.
All functional forms in the feols() functions below are of the form Y ~ X In the cases in which multiple estimations are included via sw(Xa, Xb, Xc + Xd), the function will return results for Y~Xa, Y~Xb, Y ~ Xc + Xd.")

```

```{r appendix2, include = FALSE, echo = FALSE, results = 'asis'}

append_to_appendix("## Property Tax ~ GDP",
               "GDP has a highly relevant relationship to property taxes. A 1% increase in GDP (per capita) leads to a 0.38% (0.32%) increase in property taxes collected (per capita).")

run_model(prop_taxes, mines_cz) %>%
  etable(tex = TRUE, adjustbox = TRUE)

```

```{r appendix3, include = FALSE, echo = FALSE, results = 'asis'}

append_to_appendix("## Education Expenditure ~ Revenue Sources",
               "The below regressions are included to establish the relationship between education expenditure and its component parts. These regressions simply corroborate what is displayed in the section on Key Relationships in [LINK](https://ebbam.github.io/pub_fin_schools/code/cz_results.html) (ie. that the largest form of IG revenue is state funding and Own Source revenue is largely sourced from Property Taxes).")

run_model(educ_source, mines_cz) %>% etable(adjustbox = TRUE, tex = TRUE)

```

```{r appendix4, include = FALSE, echo = FALSE, results = 'asis'}
append_to_appendix("## Education Expenditure ~ GDP",
               "A 1% increase in GDP pc is associated with a 0.19% increase in education expenditure per pupil, dominated by the effect of GDP from private industry (0.16%). I include here also the GDP generated from the oil, gas, mining, and quarrying sector. The effect is small and statistically insignificant.")

run_model(educ_gdp, mines_cz) %>% etable(adjustbox = TRUE, tex = TRUE)

```

```{r KRs, include = FALSE, echo = FALSE, results = 'asis'}

append_to_appendix("# Key Relationships between Economic Variables",
               "Below we display key relationships between several of the economic variables in our study.")

gdp_plot <- mines_cz %>%
  ggplot(aes(x = log_real_gdp_priv_ind_pc, y = log_real_Elem_Educ_Total_Exp_pp)) +
    geom_jitter(colour = "darkorange2", alpha = 0.5) +
    geom_smooth(method=lm, colour = "black")  +
    labs(x = "log Priv. Industry GDP pc", y = "log Education Expenditure pp")

hpi_plot <- mines_cz %>%
  ggplot(aes(x = log_hpi, y = log_real_Elem_Educ_Total_Exp_pp)) +
    geom_jitter(colour = "maroon", alpha = 0.5) +
    geom_smooth(method=lm, colour = "black")  +
    labs(x = "log House Prices (Index Value)", y = "log Education Expenditure pp")

wage_plot <- mines_cz %>%
  ggplot(aes(x = log_weighted_annual_avg_wkly_wage, y = log_real_Elem_Educ_Total_Exp_pp)) +
    geom_jitter(colour = "darkorchid", alpha = 0.5) +
    geom_smooth(method=lm, colour = "black")  +
    labs( x = "log Annual Average Weekly Wage", y = "log Education Expenditure pp")

pop_plot <- mines_cz %>%
  ggplot(aes(x = log_Enrollment, y = log_real_Elem_Educ_Total_Exp_pp)) +
    geom_jitter(colour = "steelblue", alpha = 0.5) +
    geom_smooth(method=lm, colour = "black")  +
    labs(x = "log Enrollment", y = "log Education Expenditure pp")

wage_prop_values <- mines_cz %>%
  ggplot(aes(x = log_weighted_annual_avg_wkly_wage, y = log_hpi)) +
    geom_jitter(colour = "darkgreen", alpha = 0.5) +
    geom_smooth(method=lm, colour = "black")  +
    labs( x = "log Wage", y = "log House Prices (Index Value)")

(gdp_plot + hpi_plot) / (wage_plot + pop_plot)+ plot_annotation(title = "Key Relationships Between Economic Varables and Ed.Exp.",
                                                                 subtitle = "Commuting Zone Level. 2001-2020.",
                                                                 theme = theme(plot.title = element_text(size = 18)))


cat("    \n")
cat("    \n")
cat("    \n")
cat("    \n")


mines_cz %>%
  ggplot(aes(x = log_real_gdp_priv_ind_pc, y = log_real_Total_IG_Revenue_pp)) +
    geom_jitter(, colour = "brown", alpha = 0.5) +
    geom_smooth(method=lm, colour = "black")  +
    labs(title = "IG Transfers (pp) vs. GDP pc", x = "log Priv. Industry GDP pc", y = "log IG Revenue pp")

```

<!-- ### Coal Mining Activity -->

<!-- First, the Mining Safety and Health Administration (MSHA) provides data -->

<!-- at the mine level on activity and production. I have thus far aggregated -->

<!-- this data for a panel of annual county-level estimates of the number of -->

<!-- active coal mines and production volumes (reported in thousand short -->

<!-- tons) between 1996-2021. I restrict the sample to 2001-2021 to align -->

<!-- with the county finance -->

<!-- data.\footnote{I do not yet make a distinction between different types of mining or coal product (ie. surface and undeground mines; (sub)bituminous, lignite, versus anthracite coal), although such distinctions are possible using the data collected.} -->

# Analysis {#sec-methods}

Given the high degree of both structural (state-specific tax,
regulatory, and legislative regimes) and evolved heterogeneity
(industrial activity, income, inequality, economic diversity) the
following analysis only briefly explores the potential to arrive at
national-level average treatment effects using various pooled estimation
strategies. These serve to establish foundational relationships between
local economic conditions that seem to reasonably generalise across the
country.

However, drawing meaningful conclusions necessitates a regional or
state–by-state estimation strategy to truly account for the
heterogeneity across the units of observation. Therefore, the body of
the analysis is dedicated to state-by-state and industry-by-industry
estimation of the relevant econometric specifications. We dedicate
majority of this manuscript to discussion of this latter exploration of
heterogeneity, aiming, wherever possible, for a causal interpretation. We include information about the
uncertainty surrounding our results as candidly as possible. \textcolor{violet}{Jennie: Any places where you think such uncertainty can be better highlighted, please note.}

## Descriptive Regressions

First, we employ a two-way fixed effects ordinary least-squares panel
model with standard errors clustered by commuting zone. We outline the
model specification immediately below:

$$
    Y_{it} = \beta_{0} + \beta_{x}X_{it} + \delta_1 Enrollment_{it} + \delta_2 IGR_{it} +\alpha_i + \eta_i + \gamma_t + \varepsilon_{it}
$$ {#eq-desc_function}


$Y_{it}$ is the natural logarithm of elementary (serving ages 6-12)
education expenditure per pupil for CZ $i$ in year $t$. We focus on elementary education for two reasons. First, this restriction partly shields against a justifiable concern about the endogeneity between wages and quality of local public education. Whereas funding for high school could likely affect local wages given such students are of working age, funding for elementary education is unlikely to impact wage rates via human capital investments. Second, in terms of public impact, elementary education is of foundational importance in the lives of children \textcolor{red}{Stefi provided some sources on this fact}. Slips in public education provision at such a young age could have scarring effects for children in such school systems. $\alpha_i$, $\eta_i$, $\gamma_t$ represent CZ, state, and year-fixed effects, respectively. $\varepsilon_{it}$ represents the error term. We control for enrollment
to account for scaling factors in education expenditure and
intergovernmental transfers to account for the significant role of such
transfers in funding education expenditure. $X_{it}$ takes three forms represented by
@eq-gdp-function, @eq-wage-function, @eq-hpi-function where $h$
represents $h$-year time lags. We estimate all equations in levels and
growth rates.

$$
    X_{it}^{GDP} = \sum_{h=0}^{2} \beta_h^{\text{GDP}} \log(\text{GDP}_{i,t-h})
$$ {#eq-gdp-function}

$$
    X_{it}^{Wage} = \sum_{h=0}^{2} \beta_h^{\text{Wage}} \log(\text{Wage}_{i,t-h})
$$ {#eq-wage-function}

$$
    X_{it}^{HPI} = \sum_{h=0}^{4} \beta_h^{\text{HPI}} \log(\text{HPI}_{i,t-h})
$$ {#eq-hpi-function}

Table 2 reports the results from regressions of log elementary education expenditure per pupil on contemporaneous and lagged measures of local economic activity. Table 3 presents the analogous specifications using annualized growth rates to capture short-run dynamics.The estimates in Table 2 show that per-pupil education spending is systematically higher in commuting zones with 'stronger' local economies measured in local wages, industrial GDP, and asset prices.

In the baseline specification (Column 1), the elasticity of education spending with respect to local GDP per capita (private industry) is positive and statistically significant once lagged values are included. A one-percent increase in local GDP per capita two years prior is associated with roughly a 0.15% increase in current education expenditure per pupil, suggesting that fiscal capacity effects unfold gradually over time. Intergovernmental revenue per pupil emerges as the strongest and most
consistent predictor of education expenditure. A 1% increase in
intergovernmental transfers is associated with approximately a 0.2–0.35%
increase in per-pupil education spending, controlling for unit/state and year
fixed effects. \textcolor{red}{I think this interpretation is correct. Though it might just reflect a "share" of expenditure from those sources?} This finding highlights the importance of state and
federal aid in sustaining local education budgets. Lagged economic
indicators, particularly private industry GDP and average weekly wages,
are also positively and significantly associated with education
spending. In the case of industry GDP, the magnitude of the coefficients increases with the number of
lags, suggesting a gradual adjustment process by which local economic
growth translates into higher public investment in education over time.
For example, a 1% increase in lagged (t–2) real private GDP per capita
is associated with a 0.15% increase in per-pupil spending. 

The house price index also enters positively and significantly in
contemporaneous and time-dynamic specifications (up to t–3) underscoring
the fundamental relationship between community asset wealth and public
education expenditure.

The growth rate regressions, while explaining less variance overall, largely confirm the patterns observed in the level
specifications. Intergovernmental revenue growth remains a strong and
highly significant determinant of education expenditure growth, with
coefficients \>0.3%. Lagged wage and GDP growth also emerge as important
predictors, particularly at longer lags. Notably, wage growth two years
prior is associated with a 0.31% increase in education spending growth,
suggesting that labor market improvements take at least a year to
materialize in local education budgets which hints at the
relevance of our primary identifying relationship.

Taken together, these results offer three key insights. First, public
education investment is strongly mediated by external fiscal flows,
reaffirming the role of intergovernmental transfers in equalizing local
education finance. Second, local labor market conditions, captured
through wages and GDP, exert lagged, cumulative effects on education
spending consistent with lagged effects of local economic conditions to
industrial change. Third, local housing markets play a significant role
shaping education budgets, reflecting the link between property values
and tax revenues.

Additionally, in both levels and growth rates, the consistently negative coefficient on enrollment indicates a scaling relationship in which expenditure per pupil declines as enrollment sizes grow. 

We also estimate these regressions using state rather than
commuting-zone level fixed effects to account for the relevance of
state-level tax regimes and policies that govern education. Though the relationships remain somewhat stable across both level and growth rate specifications, the state-fixed effects affect the stability of our coefficient estimates. \textcolor{red}{Jennie: I don't yet know what this means. But given the heterogeneity across states but homogeneity within states in how school funding is set, I am tempted to use state-level fixed effects over CZ level fixed effects which would change the analysis above.}

```{r, message = FALSE, cache = TRUE, warning = FALSE, results = 'asis'}

baseline_sw <- "log_real_Elem_Educ_Total_Exp_pp ~ sw(log_real_gdp_priv_ind_pc + l1_log_real_gdp_priv_ind_pc + l2_log_real_gdp_priv_ind_pc, log_weighted_annual_avg_wkly_wage + l1_log_weighted_annual_avg_wkly_wage + l2_log_weighted_annual_avg_wkly_wage, log_hpi + l1_log_hpi + l2_log_hpi + l3_log_hpi + l4_log_hpi) + log_real_Total_IG_Revenue_pp + log_Enrollment"

baseline_sw_short <- "log_real_Elem_Educ_Total_Exp_pp ~ sw(log_real_gdp_priv_ind_pc + l1_log_real_gdp_priv_ind_pc + l2_log_real_gdp_priv_ind_pc, log_weighted_annual_avg_wkly_wage + l1_log_weighted_annual_avg_wkly_wage + l2_log_weighted_annual_avg_wkly_wage, log_hpi + l1_log_hpi + l2_log_hpi + l3_log_hpi + l4_log_hpi) + log_real_Total_IG_Revenue_pp + log_Enrollment"

baseline_gr_sw <- "diff_log_real_Elem_Educ_Total_Exp_pp ~ sw(diff_log_real_gdp_priv_ind_pc + l1_diff_log_real_gdp_priv_ind_pc + l2_diff_log_real_gdp_priv_ind_pc,  gr_weighted_annual_avg_wkly_wage + l1_gr_weighted_annual_avg_wkly_wage + l2_gr_weighted_annual_avg_wkly_wage, gr_hpi + l1_gr_hpi + l2_gr_hpi + l3_gr_hpi + l4_gr_hpi) + diff_log_real_Total_IG_Revenue_pp + diff_log_Enrollment"

c(run_model(paste0(baseline_sw,' | unit + year'), mines_cz),
run_model(paste0(baseline_sw,' | state + year'), mines_cz),
run_model(paste0(baseline_sw,' | unit + state + year'), mines_cz)) %>% etable(adjustbox = TRUE, tex = latex_tables, caption = "Descriptive Results in Levels")

c(run_model(paste0(baseline_gr_sw, ' | unit + year'), mines_cz),
run_model(paste0(baseline_gr_sw, ' | state + year'), mines_cz),
run_model(paste0(baseline_gr_sw, ' | unit + state + year'), mines_cz)) %>% etable(adjustbox = TRUE, tex = latex_tables, caption = "Descriptive Results in Growth Rates")

```

```{r baseline_regs_state_fe, include = FALSE, echo = FALSE, results = 'asis'}

append_to_appendix("## Baseline Regressions with State Fixed Effects",
               "Regressions establishing baseline relationships between local economic variables and elementary education expenditure using state-fixed effects rather than commuting-zone level effects.")

run_model(c(log_real_Elem_Educ_Total_Exp_pp ~ sw(
  log_real_gdp_priv_ind_pc + l1_log_real_gdp_priv_ind_pc + l2_log_real_gdp_priv_ind_pc,
   log_real_gdp_priv_ind_pc + l1_log_real_gdp_priv_ind_pc + l2_log_real_gdp_priv_ind_pc + l1_log_real_Elem_Educ_Total_Exp_pp,
  log_weighted_annual_avg_wkly_wage + l1_log_weighted_annual_avg_wkly_wage + l2_log_weighted_annual_avg_wkly_wage,
  log_weighted_annual_avg_wkly_wage + l1_log_weighted_annual_avg_wkly_wage + l2_log_weighted_annual_avg_wkly_wage + l1_log_real_Elem_Educ_Total_Exp_pp,
  log_hpi + l1_log_hpi + l2_log_hpi + l3_log_hpi + l4_log_hpi,
  log_hpi + l1_log_hpi + l2_log_hpi + l3_log_hpi + l4_log_hpi + l1_log_real_Elem_Educ_Total_Exp_pp
) + log_real_Total_IG_Revenue_pp + log_Enrollment | state + year), mines_cz) %>% etable(adjustbox = TRUE, tex = latex_tables)

run_model(c(diff_log_real_Elem_Educ_Total_Exp_pp ~ sw(
  diff_log_real_gdp_priv_ind_pc + l1_diff_log_real_gdp_priv_ind_pc + l2_diff_log_real_gdp_priv_ind_pc,
  diff_log_real_gdp_priv_ind_pc + l1_diff_log_real_gdp_priv_ind_pc + l2_diff_log_real_gdp_priv_ind_pc+ l1_diff_log_real_Elem_Educ_Total_Exp_pp,
  gr_weighted_annual_avg_wkly_wage + l1_gr_weighted_annual_avg_wkly_wage + l2_gr_weighted_annual_avg_wkly_wage,
  gr_weighted_annual_avg_wkly_wage + l1_gr_weighted_annual_avg_wkly_wage + l2_gr_weighted_annual_avg_wkly_wage + l1_diff_log_real_Elem_Educ_Total_Exp_pp,
  gr_hpi + l1_gr_hpi + l2_gr_hpi + l3_gr_hpi + l4_gr_hpi,
  gr_hpi + l1_gr_hpi + l2_gr_hpi + l3_gr_hpi + l4_gr_hpi+ l1_diff_log_real_Elem_Educ_Total_Exp_pp) + diff_log_real_Total_IG_Revenue_pp + diff_log_Enrollment | state + year), mines_cz) %>% etable(adjustbox = TRUE, tex = latex_tables)



```

\FloatBarrier

Furthermore, given the heterogeneity in reliance on intergovernmental
transfers (largely coming from the state), we interact all economic
predictors above with a variable that represents the share of total
elementary education expenditure coming from state-level funding.

\textcolor{red}{Jennie: I need help interpreting Table 4 below...?}

```{r, message = FALSE, cache = TRUE, warning = FALSE, results = 'asis'}

selected_twfe_models_state_share_interaction =
  c(log_real_Elem_Educ_Total_Exp_pp ~ sw(state_share*(log_real_gdp_priv_ind_pc + l1_log_real_gdp_priv_ind_pc + l2_log_real_gdp_priv_ind_pc), state_share*(log_weighted_annual_avg_wkly_wage + l1_log_weighted_annual_avg_wkly_wage + l2_log_weighted_annual_avg_wkly_wage), state_share*(log_hpi + l1_log_hpi + l2_log_hpi + l3_log_hpi + l4_log_hpi + l5_log_hpi)) + log_real_Total_Fed_IG_Revenue_pp + log_Enrollment | unit + year)
    # log_real_Elem_Educ_Total_Exp_pp ~ sw(state_share*(log_weighted_annual_avg_wkly_wage + l1_log_weighted_annual_avg_wkly_wage + l2_log_weighted_annual_avg_wkly_wage), state_share*(log_hpi + l1_log_hpi + l2_log_hpi + l3_log_hpi + l4_log_hpi + l5_log_hpi)) + log_real_Total_Fed_IG_Revenue_pp + log_Enrollment + l1_log_real_Elem_Educ_Total_Exp_pp | unit + year)


run_model(selected_twfe_models_state_share_interaction, mines_cz) %>% etable(adjustbox = TRUE, tex = latex_tables, order = c("GDP", "Wage", "House Price"), caption = "Descriptive Results with Funding Source Interaction Effects")
#run_model(selected_twfe_models_levs_state_share_interaction[1:2], mines_cz) %>% etable(tex = latex_tables)
#run_model(selected_twfe_models_levs_state_share_interaction[3:4], mines_cz) %>% etable(tex = latex_tables)

```

<!-- ### Incorporating state-level trends -->

<!-- The below take the Education Expenditure \~ GDP models and incorporate -->

<!-- deterministic state time trends. -->

<!-- ```{r, message = FALSE, warning = FALSE, results = 'asis'} -->

<!-- # run_model(selected_twfe_models_state_trend[1:2], mines_cz) %>% -->

<!-- #   etable(drop = "*time", tex = TRUE) -->

<!-- run_model(selected_twfe_models_state_trend[3:4], mines_cz) %>% -->

<!--   etable(drop = "*time", tex = TRUE, adjustbox = TRUE) -->

<!-- ``` -->

\FloatBarrier

## Approaching Causal Identification

We are centrally interested in the effect of changes in local wages on public education expenditure. Though the descriptive relationship between various economic variables
and public education expenditure provides convincing evidence of the
reliance of local education expenditure on economic conditions in both levels and growth rates, this
relationship has no causal interpretation. Indeed, there is a significant endogeneity concern in using local wages as a treatment variable given the likely attracting
factor of high levels of education expenditure for higher-income
families. Therefore, we instrument local wages using a shift-share based instrument of industry-specific wages and real value added across 19 industrial categories. 

\begin{figure}[H]
\centering
\caption{Instrumental Variable Path Diagram}
\begin{tikzpicture}
% nodes %
\node[rectangle] (z) at (0,0) {Instrument};
\node (t) at (4,0) {Local Wages};
\node (y) at (8,0) {Education Expenditure};
\node (u) at (6,-2) {Omitted variable};

% edges %
\draw[->, line width=1] (z) -- (t);
\draw[->, line width=1] (t) -- (y);
\draw[->, line width=1, violet, dashed] (u) -- (t);
\draw[->, line width=1, violet, dashed] (u) -- (y);
\draw[->, line width=1, red, bend right=40, dashed] (y) to (t);
\end{tikzpicture}
\label{fig:iv-approach}
\end{figure}

Shift-share or *Bartik* instruments have gained popularity in empirical
work as a method of handling endogeneity issues in panel data
(@ferri2022, @goldsmith-pinkham2020, @bartik1991). Such instruments
combine time-variant, unit-invariant changes in aggregate economic
variables (ie., national changes in industry wage levels) with
time-invariant, unit-variant shares in exposure to these macro-level
changes (ie., local shares of employment in particular industries). This
decomposition of local-level changes via a delocalisation over space and
time allows for a defensible 'de-endogenising' of the treatment.
Notably, the method can also be considered to serve a further purpose as, by construction, it allows for the examination of a macro phenomenon's
effect on more local units.

\footnote{Autor et al. use a shift-share instrument to assess the effect
of Chinese import competition on manufacturing employment in US
commuting zones (@autor2013). As an extension, @feler2017 use a similar
shift-share instrument to assess the effect of the same shock on the
size of local government. @baccini2021 employ a shift-share instrument
for manufacturing layoffs to tease out the effect of a decline in
manufacturing on both economically motivated and racial identity voting
patterns in the US.}
\footnote{An additional popular indicator for modelling industrial shocks
is *oil price* as values are often assumed to be exogenous to local and
even national conditions (@scheer2022). Third, various indicators for measuring
*deindustrialisation* have been proposed including the manufacturing
share of employment, value added, and GDP [@tregenna2009,
@tregenna2020]. Finally, in rare instances,
exogeneity can be secured due to *geographical, climatological, or
geological factors*. For example, @borge2015 obtain an exogenous measure
of local revenue by "instrumenting the variation in hydropower revenue,
and thus total revenue, by topology, average precipitation and meters of
river in steep terrain." Certain authors have argued that the fact that
the location of hydrocarbon deposits is dictated by geomorphological
processes provides a plausible argument for exogeneity [@esposito2021,
@chen2022].}

Therefore, we adopt an identification strategy via a shift-share or
Bartik instrument. A shift-share instrument interacts local industry
shares with national industry-level growth rates to attain a plausibly
exogenous local shock. In the context of this work, we construct the
instrument by interacting a constant industrial employment share
variable with a national industry-level wage and real value added data.

The literature on Bartik instruments allows for an argument of plausible exogeneity via various channels. First, authors argue that local industry shares are
exogenous by imposing that shares be fixed to a particular base year and
are therefore unable to adapt to changes in national-level growth rates.
Such a shift-share instrument would look as follows:

$$
Z_{it} = \sum_{j=1}^{k} S_{ij\tau}G_{njt}
$$ {#eq-ref-bartik}

where $S_{ij\tau}$ is the local share of unit $i$'s economy (measured using metrics like employment, wages, revenue) in industry $j$ at
a fixed base year $\tau$ and $G_{njt}$ is the growth rate of industry
$j$ at a national level $n$ at time $t$.

Alternatively, authors may argue that the claim of exogeneity in the
national-level growth rates is unlikely to be violated even when
allowing the local shares to vary over time. This approach is likely to
come at significant expense to instrument exogeneity. It is constructed
as follows:

$$
Z_{it} = \sum_{j=1}^{k} S_{ijt}G_{njt}
$$

Finally, authors might be concerned about the implausible exogeneity of
both shares and national-level growth rates in which case they could
construct the instrument as follows where the local shares are fixed at
a common base year and industry-specific growth rates $G$ are derived
from data on other similar regions $o$ rather than national-level
changes that are inherently comprised of local-level shifts. This
approach likely comes at significant expense to instrument relevance.

$$
Z_{it} = \sum_{j=1}^{k} S_{0jt}G_{ojt}
$$

Finally, the authors can make an additional design choice about whether
the effect of these instruments should be assumed common to an aggregate
local-level wage growth indicator or allowed to vary by industry. In
other words, whether to construct the first-stage relationship of the
2SLS as...:

$$
X_{it} = \alpha_i + \beta\sum_{j=1}^{k}S_{ijt}G_{njt} + \epsilon_{it}
$$

...or...:

$$
X_{it} = \alpha_i + \sum_{j=1}^{k}\beta_{j}S_{j}G_{jt} + \epsilon_{it}
$$

We choose to employ the first of these options, assuming that industry
shares are only exogenous at a given base period and that national
level growth rates are exogenous and therefore allowed to vary with
time.

Using data from the US Bureau of Labor Statistics' Quarterly Census of
Employment and Wages (QCEW) and Bureau of Economic Analysis, we
construct two types of shift-share Bartik instruments at the commuting
zone level using local employment shares by industry and national
changes in industry-specific wages and real value added represented in Equation @eq-bartik. $G_{njt}$
represents national-level changes in wages or value added in industry
$j$ in time $t$ and $\frac{N_{ij\tau}}{N_{i\tau}}$ represents the
'sensitivity' of a CZ to these national shocks proxied by an initial
share of local employment in industry $j$ in a baseline time period
$\tau$. The product of these two values defines the shift-share
indicator $\tilde{Z}_{i,t,s}$. In order to construct the share portion,
we compute the total local share of employment in a particular industry
$j$. Due to challenges with missing data, we compute an average share
across 2001-2005 as our 'base year'.

\footnote{We explore the sensitivity of results to the choice of base period
    $\tau$ by constructing the instrument for various base periods as
    well as a rolling window.
    \textcolor{red}{I have done this unsystematically so far (testing 2001, 2004, and 2005) but arrived at the decision to compute an average to deal with missing data. Will include a more systematic testing of this in the appendix.}}
    
    
$$
    \tilde{Z}_{it} = \sum_{j=1}^{k}G_{njt} *  \frac{N_{ij\tau}}{N_{i\tau}} 
$${#eq-bartik}



This yields a 2SLS model defined by the first- and second-stage regressions represented in Equations @eq-first-stage and @eq-second-stage and instrument $\tilde{Z}_{ijt}$ is represented in Equation @eq-bartik.


$$ 
\text{First stage:} X_{it} = \pi_0 + \pi_1 \tilde{Z}_{it} + \pi_2 \text{Enrollment}_{it} + \pi_3 \text{IGR}_{it} + \alpha_i + \eta_i + \gamma_t + u_{it}
$${#eq-first-stage}

              
$$\text{Second stage:} \quad Y_{it} = \beta_0 + \beta_x \hat{X}_{it} + \delta_1 \text{Enrollment}_{it} + \delta_2 \text{IGR}_{it} + \alpha_i + \eta_i + \gamma_t + \varepsilon_{it}
$${#eq-second-stage}



<!-- ![Coal Shift-share -->

<!-- Instruments](../output/bartik_graphs.jpg){#fig-bartik_graph} -->

```{r appendix_industry_shares_cleaning, include = FALSE, echo = FALSE, results = 'asis'}

append_to_appendix("## SS Construction",
               "Plots of the data inputs to the shift-share instrument.")

# Draw the functions needed to calculate the SS instruments from the following script.
source(here("data/raw/QCEW/industry_shares_cleaning.R"))

```

```{r compute_ss, echo = FALSE, cache = TRUE}

if(new_ss_calculation){
  ss_shares <- compute_shares(source = "QCEW", base_year = 2004, unit_id = "cz_id", flat = FALSE)

  coverage <- ss_shares %>% select(coverage_2digit_naics, coverage_3digit_naics) %>% distinct

  ss_temp <- compute_ss(ss_shares)

  saveRDS(ss_temp, here("code/ss_cache_manual/ss_temp.RDS"))
  saveRDS(coverage, here("code/ss_cache_manual/coverage_ss.RDS"))
}else{
  ss_temp <- readRDS(here("code/ss_cache_manual/ss_temp.RDS"))
  coverage <- readRDS(here("code/ss_cache_manual/coverage_ss.RDS"))
}

```

We compute the two relevant shift-share instruments across 19 two-digit NAICS industrial categories listed in the table below. Given industry-level disaggregation of local employment and wage data requires data suppression for anonymity reasons, Figure 2 displays the data coverage of our commuting zone level shift-share instruments. Given the high degree of
missingness in the 3-digit categorisation we proceed with the 2-digit
NAICS codes in the rest of the work. \textcolor{red}{I need to double check how I handle Public Adminsitration and Educational Services wage and employment data as I think these would have an additional endogeneity issue...?}

```{r, echo = FALSE, cache = FALSE, results = 'asis', message = FALSE}

rel_inds <- c("Agriculture, Forestry, Fishing, and Hunting" = "11",
"Mining" = "21",
"Construction" = "23",
"Manufacturing" = "31_33",
"Wholesale Trade" = "42",
"Retail Trade" = "44_45",
"Transportation and Warehousing" = "48_49",
"Utilities" = "22",
"Information" = "51",
"Finance and Insurance" = "52",
"Real Estate and Rental and Leasing" = "53",
"Professional, Scientific, and Technical Services" = "54",
"Management of Companies and Enterprises" = "55",
"Administrative and waste management services" = "56",
"Educational Services" = "61",
"Health Care and Social Assistance" = "62",
"Arts, Entertainment, and Recreation" = "71",
"Accommodation and Food Services" = "72",
"Other Services, except government" = "81",
"Public Administration" = "92")

data.frame("NAICS.Code" = unname(rel_inds), "Industry" = names(rel_inds))  %>% 
  mutate(NAICS.Code = gsub("_", "-", NAICS.Code)) %>% 
  xtable() %>% print(include.rownames = FALSE)

```

```{r fig_wage_elasticity, echo = FALSE, cache = TRUE, fig.cap = "Data Coverage of Industry-level Employment as Share of Total Reported Employed"}

probs <- c(0.05, 0.25, 0.75, 0.95)
percentiles_coverage <- quantile(
  coverage$coverage_2digit_naics,
  probs = probs,
  na.rm = TRUE
)

# convert to data frame for plotting
percentile_df <- data.frame(
  x = percentiles_coverage,
  label = paste0(names(percentiles_coverage))
)

coverage %>%
  ggplot() +
  geom_histogram(aes(x = coverage_3digit_naics, fill = "3-digit NAICS Codes"), alpha = 0.8, bins = 30) +
  geom_histogram(aes(x = coverage_2digit_naics, fill = "2-digit NAICS Codes"), alpha = 0.8, bins = 30) +
geom_vline(data = percentile_df,
             aes(xintercept = x),
             linetype = "dashed", color = "black", size = 0.3) +
  geom_text(data = percentile_df,
            aes(x = x, y = 80, label = label),
          vjust = -0.5, hjust = 1,
            size = 2.5) +
  labs(x = "% Coverage of CZ's Employed by NAICS sub-categorisation",
       y = "No. CZs",
       title = "Data Coverage of Industry-level Employment as Share of Total Reported Employed",
       subtitle = "Data coverage is calculated as the fraction of total local employment accounted for in the industry-specific employment values. Percentage labels represent proportion of commuting zones (percentiles) falling below a coverage value.",
       fill = "NAICS Specificity") +
  common_theme +
  theme(legend.position = "bottom", title = element_text(size = 10)) +
  scale_fill_brewer(palette = "Pastel1")

```

```{r, echo = FALSE, cache = TRUE}

if(new_ss_calculation){
  temp_new <- shares_flat_filled %>%
    select(!contains("share")) %>%
    filter(year <= 2005) %>%
    group_by(unit) %>%
    # Creates a mean employment level across 2001-2005 - 5 year mean to deal with missing data
    summarise(across(!year, ~mean(., na.rm = TRUE))) %>%
    ungroup  %>%
    rename(fips = unit)

    if(unit_id == "cz_id"){
      czs_new <- czs %>%
        #select(-old_fips) %>%
        rename(old_fips = fips) %>%
        mutate(fips = case_when(!is.na(getfips[old_fips]) ~ getfips[old_fips],
                                TRUE ~ old_fips),
               cz_id = as.character(cz_id))

      missing_fips <- czs_new %>%
        pull(fips) %>%
        unique %>%
        setdiff(unique(temp_new$fips), .)

      if (length(missing_fips) > 0) {
        message("Warning: Some FIPS codes are missing from czs.")
      }

      temp <- temp_new %>%
        select(fips, matches("^annual_avg_emplvl_\\d{2}$"), annual_avg_emplvl_10_filled) %>%
        left_join(., czs_new, by = "fips", multiple = "first") %>%
        rename("unit" = cz_id) %>%
        select(-c(fips, old_fips, cz_population, cz_id_1990)) %>%
        relocate(unit)

    }else if(unit_id == "fips"){
      temp <- temp %>%
        rename(unit = fips)
    }


  shift_share_filled <- temp %>%
      group_by(unit) %>%
      summarise(across(everything(), ~sum(., na.rm = TRUE))) %>%  # , total_annual_wages)
                #annual_avg_wkly_wage = mean(annual_avg_wkly_wage, na.rm = TRUE)) %>%
      ungroup %>%
    mutate(across(contains("avg_emplvl"), ~./annual_avg_emplvl_10_filled, .names = "share_{.col}")) %>%
    select(unit, contains('share')) %>%
    mutate(year = 2001) %>%
    complete(unit, year = 2001:2022) %>%
    group_by(unit) %>%
    fill(everything(), .direction = "updown") %>%
    ungroup

  assert_that(nrow(shift_share_filled) == n_distinct(shift_share_filled$unit) * n_distinct(shift_share_filled$year))

  ss_temp_fill <- shift_share_filled %>%
        select(unit, year, contains("share")) %>%
        left_join(., natl_rates, by = "year", relationship = "many-to-one") %>%
        rename(!!unit_id := unit) %>%
        select(-ends_with("10"))

  ss_temp_filled <- compute_ss(ss_temp_fill)
  saveRDS(ss_temp_filled, here("code/ss_cache_manual/ss_temp_filled.RDS"))

}else{
  ss_temp_filled <- readRDS(here("code/ss_cache_manual/ss_temp_filled.RDS"))
}

ss_temp_old <- ss_temp
ss_temp <- ss_temp_filled


```

### Industry-level Wages

First, we display the results for a 2SLS estimation using our
wage-based shift-share instrument in Tables 5 and 6.

In Table 5, the instrumental variable estimates provide evidence of a robust causal
relationship between local wages and public education expenditure. Utilising our wage-based shift-share instrument we see highly significant and relevant first-stage relationships when the shift-share instrument is imposed in levels (except in column 5). In each case except columns 5-6 (l1 SS, CZ FE), the first-stage regression yields a statistically significant \textcolor{violet}{and economically large coefficient} \textcolor{red}{Checking the interpretation of this}. Varying the time-lag and inclusion of state or commuting zone fixed effects, we see that a 1%
increase in the shift-share measure (which can be interpreted as a natural logarithm) is associated with a 0.02-0.06% increase
in average weekly wages (p \< 0.01), with an F-statistic between 11-103 (near or above conventional weak instrument thresholds) confirming
instrument relevance. The Wu-Hausman tests reject the null of exogeneity, confirming that OLS estimates are biased and IV estimation is appropriate. Wald tests of joint significance further support the strength of the instruments. 

Using wage shocks in levels yields strong instruments, high first-stage F-statistics, and stable second-stage estimates: higher local wages robustly increase education spending. Furthermore, given the dependent variable measures per pupil expenditure, this result implies direct effects in experience per student. In contrast, when shocks are measured in growth rates (Table 6), the instruments lose predictive power (first-stage F-statistics ~1–2), resulting in weak identification. The second-stage coefficients become unstable and often insignificant, while Hausman tests fail to reject exogeneity. This suggests that the growth-rate specification is poorly identified and cannot provide reliable causal inference, whereas the level specification produces credible and consistent results.

\textcolor{red}{Jennie: Two things on this section: (1) I'm looking into coefficient interpretation of the wage-based shift share instrument. It is possible that the elasticity is greater than 1 but likely this has to do with the calculation of the wage-based SS instrument. (2) I am unsure how to communicate the differences between the level and growth rate specifications. See below for my attempt.}

The specification that uses wage shocks in levels provides the most credible identification strategy. Since levels capture the cross-sectional fiscal variation that drives differences in property values and school spending, the level specification is more consistent with the economic mechanisms of interest and delivers more reliable causal estimates. At the same time, the weakness of the growth-rate specification does raise concerns about the robustness of the results. If the relationship between wages, house prices, and education expenditure is driven by common non-stationary trends, then regressions in levels risk spurious correlation. The fact that the IV design loses power when variables are differenced into growth rates may suggest that part of the strong level results reflect long-run trends rather than short-run causal shocks. While the large first-stage F-statistics and Hausman tests in the level specification support its validity, the weak performance of the growth-rate version cautions that the results could be sensitive to issues of persistence and trending in the data. Taken together, these results suggest that while the level specification provides strong identification and compelling evidence of a positive causal effect of house prices on education spending, the weak performance of the growth-rate specification highlights the need for caution, as the strength of the findings may partly reflect long-run trending relationships rather than purely exogenous shocks. However, examining the structure of the growth rate shock, the instability of the variable is likely causing the poor identification in the growth rate regressions.


```{r, echo = FALSE, results = 'asis', cache = TRUE}

iv_lev_form <- "log_real_Elem_Educ_Total_Exp_pp ~ log_real_Total_IG_Revenue_pp + log_real_gdp_priv_ind_pc + log_Enrollment"

iv_model_2d_lev_gr <- feols(as.formula(paste0(iv_lev_form, "| unit + year | log_weighted_annual_avg_wkly_wage ~ ss_2d")),
    data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))

iv_model_2d_lev_lev <- feols(
    as.formula(paste0(iv_lev_form, " | unit + year | log_weighted_annual_avg_wkly_wage ~ lev_ss_2d")),
    data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))

iv_model_2d_lev_gr_l1 <- feols(as.formula(paste0(iv_lev_form, " | unit + year | log_weighted_annual_avg_wkly_wage ~ l(ss_2d,1)")),
    data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))

iv_model_2d_lev_lev_l1 <- feols(
    as.formula(paste0(iv_lev_form, " | unit + year | log_weighted_annual_avg_wkly_wage ~ l(lev_ss_2d,1)")),
    data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))

iv_model_2d_lev_gr_state_fe <- feols(as.formula(paste0(iv_lev_form, " | state + year | log_weighted_annual_avg_wkly_wage ~ ss_2d")),
    data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))

iv_model_2d_lev_lev_state_fe <- feols(
    as.formula(paste0(iv_lev_form, " | state + year | log_weighted_annual_avg_wkly_wage ~ lev_ss_2d")),
    data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))

iv_model_2d_lev_gr_l1_state_fe <- feols(as.formula(paste0(iv_lev_form, " | state + year | log_weighted_annual_avg_wkly_wage ~ l(ss_2d,1)")),
    data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))

iv_model_2d_lev_lev_l1_state_fe <- feols(
    as.formula(paste0(iv_lev_form, " | state + year | log_weighted_annual_avg_wkly_wage ~ l(lev_ss_2d,1)")),
    data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))

# iv_model_2d_lev_gr_tfe <- feols(as.formula(paste0(iv_lev_form, " | year + state | gr_weighted_annual_avg_wkly_wage ~ l(ss_2d,1)"),
#     data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))
# 
# iv_model_2d_lev_lev_tfe <- feols(
#     as.formula(paste0(iv_lev_form, " | year + state | log_weighted_annual_avg_wkly_wage ~ l(lev_ss_2d,1)"),
#     data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))

# iv_model_2d_share <- feols(
#     as.formula("log_real_Elem_Educ_Total_Exp_pp ~ log_real_gdp_priv_ind_pc | unit + year + log_Enrollment | gr_weighted_annual_avg_wkly_wage ~  state_share*l(ss_2d,1)"),
#     data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year", "unit")), panel.id = c("unit", "year"))
# 
# iv_model_2d_levshare <- feols(
#     as.formula("log_real_Elem_Educ_Total_Exp_pp ~ log_real_gdp_priv_ind_pc + log_Enrollment | unit + year | log_weighted_annual_avg_wkly_wage ~  state_share*l(lev_ss_2d,1)"),
#     data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year", "unit")), panel.id = c("unit", "year"))


etable(iv_model_2d_lev_lev, iv_model_2d_lev_lev_state_fe, iv_model_2d_lev_lev_l1, iv_model_2d_lev_lev_l1_state_fe, adjustbox = TRUE,   headers = list("Stage" = c("1st", "2nd")), stage = 1:2, fitstat = iv_fitstats, tex = latex_tables, caption = "IV Estimation Using Wage-based Shift-Share Instrument (l0, l1) in Levels varying state and CZ fixed effects and lags.")

etable(iv_model_2d_lev_gr, iv_model_2d_lev_gr_state_fe, iv_model_2d_lev_gr_l1, iv_model_2d_lev_gr_l1_state_fe, adjustbox = TRUE, stage = 1:2, fitstat = iv_fitstats, tex = latex_tables, caption = "IV Estimation Using Wage-based Shift-Share Instrument (l0, l1) in Growth Rates varying state and CZ fixed effects and lags.")

```

### Industry-level GDP

We perform a similar IV estimation using the GDP-based shift-share instrument.\textcolor{red}{these are technically value added shocks, not GDP shocks. I will make the language consistent throughout.} In Tables 7 and 8, we find quite different relationships and evidence of a weaker identification strategy. The sign on the coefficient of the first-stage relationship depends on the fixed effect specification (CZ vs. state). 

Though the first-stage F-statistics, Wu-Hausman, and Wald tests indicate the plausible relevance of our instrumental variable, endogeneity of our wage variable, and the significance of our instrumented wage variable, respectively, the temperamental nature of our first- and second-stage relationships of interest complicates the interpretation of our result. Furthermore, the growth rate specifications provide discordant results about the direction of the effect of the causal relationships.

Together with the results from our wage-based shift-hsare instrument, we find evidence that shifts in wage growth, rather than simply changes in economic growth is more important for local public education expenditure. In other words, national level wage
growth is more important predictor local wage effects than the mere presence
of industry-level GDP growth. This makes intuitive sense in that the
link from industrial success (labour) to personal and community wealth creation is mediated via wage and
not necessarily the total industrial output which might not be reflected
in wages (especially given recent evidence of decoupling of wages from
productivity) \textcolor{red}{Source here - OECD and FRED Data}.

![Wages and Productivity](../output/FRED%20wage%20decoupling.png)
```{r, echo = FALSE, results = 'asis', cache = TRUE}

iv_model_2d_lev_gr <- feols(as.formula(paste0(iv_lev_form, " | unit + year | log_weighted_annual_avg_wkly_wage ~ gdp_ss_2d")),
    data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))

iv_model_2d_lev_lev <- feols(
    as.formula(paste0(iv_lev_form, " | unit + year | log_weighted_annual_avg_wkly_wage ~ lev_gdp_ss_2d")),
    data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))

iv_model_2d_lev_gr_l1 <- feols(as.formula(paste0(iv_lev_form, " | unit + year | log_weighted_annual_avg_wkly_wage ~ l(gdp_ss_2d,1)")),
    data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))

iv_model_2d_lev_lev_l1 <- feols(
    as.formula(paste0(iv_lev_form, " | unit + year | log_weighted_annual_avg_wkly_wage ~ l(lev_gdp_ss_2d,1)")),
    data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))

iv_model_2d_lev_gr_state_fe <- feols(as.formula(paste0(iv_lev_form, " | state + year | log_weighted_annual_avg_wkly_wage ~ gdp_ss_2d")),
    data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))

iv_model_2d_lev_lev_state_fe <- feols(
    as.formula(paste0(iv_lev_form, " | state + year | log_weighted_annual_avg_wkly_wage ~ lev_gdp_ss_2d")),
    data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))

iv_model_2d_lev_gr_l1_state_fe <- feols(as.formula(paste0(iv_lev_form, " | state + year | log_weighted_annual_avg_wkly_wage ~ l(gdp_ss_2d,1)")),
    data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))

iv_model_2d_lev_lev_l1_state_fe <- feols(
    as.formula(paste0(iv_lev_form, " | state + year | log_weighted_annual_avg_wkly_wage ~ l(lev_gdp_ss_2d,1)")),
    data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))


etable(iv_model_2d_lev_lev, iv_model_2d_lev_lev_state_fe, iv_model_2d_lev_lev_l1, iv_model_2d_lev_lev_l1_state_fe, adjustbox = TRUE, stage = 1:2,fitstat = iv_fitstats, tex = latex_tables, caption = "IV Estimation Using GDP-based Shift-share instrument (l0,l1) in Levels varying state and CZ fixed effects and lags.")
etable(iv_model_2d_lev_gr, iv_model_2d_lev_gr_state_fe, iv_model_2d_lev_gr_l1, iv_model_2d_lev_gr_l1_state_fe, adjustbox = TRUE, stage = 1:2,fitstat = iv_fitstats, tex = latex_tables,  caption ="IV Estimation Using GDP-based Shift-share instrument (l0,l1) in Growth Rates varying state and CZ fixed effects and lags.")


```

\FloatBarrier

## Accounting for Heterogeneity

In order to make meaningful policy-related insights, we need to unmask the substantial heterogeneity obscured by the national-level average treatment effects described above. Barring design and data issues with our
shift-share instrument, these national-level estimates are unlikely to apply uniformly across states and commuting zones.
Therefore, this next section is dedicated to unpacking this
heterogeneity. Below, we explore various metrics of local economic
growth and decline to (1) partition our sample in a data-driven manner, employ (2) industry-by-industry 
and (2) state-by-state estimations in our baseline descriptive
models and IV specifications using our wage- and GDP-based shift-share instruments.

### Declining vs. Growing Regions

First, we identify declining and growing regions by estimating commuting-zone
growth rates conditional on state and national level growth rates and partition our sample across this distribution.

```{r, include = FALSE, cache = TRUE}

cz_labels <- read_xls(here('data/out/cz00_eqv_v1.xls')) %>%
  clean_names %>% 
  select(commuting_zone_id_2000, metropolitan_area_2003) %>%
  rename(unit = commuting_zone_id_2000) %>% 
  distinct %>% 
  arrange(unit) %>% 
  filter(!is.na(metropolitan_area_2003)) %>% 
  mutate(unit = as.character(unit)) %>% 
  group_by(unit) %>%
  summarise(
    msa = paste(sort(unique(metropolitan_area_2003)), collapse = ";\n"),
    n_msa = n_distinct(metropolitan_area_2003),                     # optional: how many collapsed
    .groups = "drop"
  )

```

```{r, include = FALSE, cache = TRUE}
state_lev <- mines_cz %>%
  group_by(state, year) %>%
  summarise(across(c(real_gdp_priv_ind, real_gdp_total, pop_total), ~sum(., na.rm = TRUE))) %>%
  ungroup %>%
  mutate(real_gdp_priv_ind_pc = real_gdp_priv_ind/pop_total,
         real_gdp_total_pc = real_gdp_total/pop_total,
         across(!c(state, year), ~log(. + 1), .names = "log_{.col}")) %>%
  group_by(state) %>%
  mutate(across(contains("log"), ~.- dplyr::lag(., 1), .names = "diff_{.col}")) %>%
  ungroup

natl_lev <- mines_cz %>%
  group_by(year) %>%
  summarise(across(c(real_gdp_priv_ind, real_gdp_total, pop_total), ~sum(., na.rm = TRUE))) %>%
  ungroup %>%
  mutate(real_gdp_priv_ind_pc = real_gdp_priv_ind/pop_total,
         real_gdp_total_pc = real_gdp_total/pop_total,
         across(!c(year), ~log(. + 1), .names = "log_{.col}"),
         across(contains("log"), ~.- dplyr::lag(., 1), .names = "diff_{.col}"))

growth_rates <- mines_cz %>%
  select(unit, names(state_lev), ) %>%
  left_join(., state_lev, by = c("state", "year"), suffix = c("", "_state")) %>%
  left_join(., natl_lev, by = c("year"), suffix = c("", "_natl"))
```



In order to identify declining and growing commuting zones, we separate time series models by commuting zone...

$$
\Delta \log GDPpc^{CZ}_{t} 
= \alpha_{g} 
+ \beta_{n} \, \Delta \log GDPpc^{nat}_{t} 
+ \beta_{s} \, \widetilde{\Delta \log GDPpc}^{state}_{t} 
+ \varepsilon_{t}
$$


$$
\widetilde{\Delta \log GDPpc}^{state}_{t} 
= \Delta \log GDPpc^{state}_{t} 
- \hat{\gamma}\, \Delta \log GDPpc^{nat}_{t}
$$
 

...where each GDP term represents the private industry GDP per capita at the CZ, state, or national level, denoted by superscript. We estimate the local growth rate while controlling for state and national trends in a two-step framework. First, we orthogonalize the state-level growth rate with respect to the national trend, isolating state-specific fluctuations unrelated to the national business cycle. Second, we regress commuting zone growth on both the national growth rate and the orthogonalized state residuals, thereby decomposing local growth into national, state, and idiosyncratic components. This approach identifies commuting zones whose trajectories systematically diverge from higher-level aggregate patterns, providing a clean measure of relative local economic performance. \textcolor{red}{I think this can be supported by interesting literature from the "left behind" and "geographies of discontent" literature in which 'relative' economic performance is what matters most for individuals' happiness. Might be a conceptual leap but an interesting connection?} Economically, this specification measures how much of each CZ’s growth can be explained by broader aggregate trends versus localized factors. By controlling for orthogonalized state and national variation, the estimated intercept ($\alpha_{g}$) and residual terms capture persistent, region‐specific trends that are not driven by common macroeconomic forces. This allows us to identify which commuting zones are systematically growing or declining relative to their state and national baselines, thereby providing a purer measure of local economic dynamics that is robust to shared higher-level shocks.


We then classify commuting zones by the value of $\alpha_{g}$ which represents their deviation from state- and national-level GDP growth rates. We estimate this trend deviation in per capita values of private industry GDP. \footnote{We provide similar analysis of gross GDP in Appendix \textcolor{red}{X}.} Figure 5 below demonstrates the considerable variability in GDP-level growth rates across commuting zones in the US between 2001-2021. Visualising the per capita growth rate deviations by state and region demonstrates heterogeneity in this variability across states and regions. For example, Texas, Montana, and Colorado have outstanding positive outliers in the distribution whereas Kentucky, Louisiana, South Dakota have outstanding negative outliers. \textcolor{red}{This makes intuitive since but I should make this more clear with text labels in the plot. I have marked the negatively trending outliers and they are all from Louisiana, Oklahoma, and Wyoming which makes sense. I will make this outlier marking clearer.)}


```{r, echo = FALSE, fig.height = 10, fig.width = 10, warning = FALSE, cache = TRUE, fig.cap = c("Distribution of GDP Trend Coefficients", "Lollipop Plot of GDPpc Growth Rates")}


## ---------------------------------------------------------
## 1. Orthogonalise state growth relative to national growth
## ---------------------------------------------------------
growth_rates_orthog <- growth_rates %>%
  group_by(state) %>%
  group_modify(~{
    # state-total residual
    m1 <- lm(diff_log_real_gdp_priv_ind_state ~ diff_log_real_gdp_priv_ind_natl,
             data = .x, na.action = na.exclude)
    .x$state_resid <- residuals(m1)

    # state-per-capita residual
    m2 <- lm(diff_log_real_gdp_priv_ind_pc_state ~ diff_log_real_gdp_priv_ind_pc_natl,
             data = .x, na.action = na.exclude)
    .x$state_resid_pc <- residuals(m2)

    .x
  }) %>%
  ungroup()

## ---------------------------------------------------------
## 2. Regression forms
## ---------------------------------------------------------
trend_forms <- list(
  trend    = diff_log_real_gdp_priv_ind    ~ state_resid    + diff_log_real_gdp_priv_ind_natl,
  trend_pc = diff_log_real_gdp_priv_ind_pc ~ state_resid_pc + diff_log_real_gdp_priv_ind_pc_natl
)

## ---------------------------------------------------------
## 3. Helper to extract coefficients safely
## ---------------------------------------------------------
extract_coefs <- function(formula_obj, data){
  fit <- lm(formula_obj, data = data)
  cf  <- coef(fit)

  tibble(
    intercept = unname(cf["(Intercept)"]),
    beta_nat  = unname(cf[grepl("natl", names(cf))]),
    beta_state= unname(cf[grepl("state_resid", names(cf))])
  )
}

## ---------------------------------------------------------
## 4. Run regressions by commuting zone
## ---------------------------------------------------------
cz_trends <- growth_rates_orthog %>%
  group_by(unit) %>%
  group_modify(~ extract_coefs(trend_forms$trend, .x)) %>%
  ungroup() %>%
  rename(trend = intercept)

cz_trends_pc <- growth_rates_orthog %>%
  group_by(unit) %>%
  group_modify(~ extract_coefs(trend_forms$trend_pc, .x)) %>%
  ungroup() %>%
  rename(trend_pc = intercept,
         beta_nat_pc = beta_nat,
         beta_state_pc = beta_state)

# join them
cz_trends <- cz_trends %>% left_join(cz_trends_pc, by = "unit")

## ---------------------------------------------------------
## 4. Percentiles for classification
## ---------------------------------------------------------
percentiles <- cz_trends %>%
  summarize(
    p25trend     = quantile(trend, 0.25, na.rm = TRUE),
    p75trend     = quantile(trend, 0.75, na.rm = TRUE),
    p25trend_pc  = quantile(trend_pc, 0.25, na.rm = TRUE),
    p75trend_pc  = quantile(trend_pc, 0.75, na.rm = TRUE)
  )

cz_trends <- cz_trends %>%
  mutate(declining = trend < 0,
         declining_extreme = trend < percentiles$p25trend,
         growing_extreme   = trend > percentiles$p75trend,
         declining_pc = trend_pc < 0,
         declining_pc_extreme = trend_pc < percentiles$p25trend_pc,
         growing_pc_extreme   = trend_pc > percentiles$p75trend_pc)

## ---------------------------------------------------------
## 5. Histograms of intercepts
## ---------------------------------------------------------
my_color <- viridis_pal(option = "rocket")(6)

trend_hist <- cz_trends %>%
  ggplot() +
  geom_histogram(aes(x = trend), bins = 75, fill = my_color[2], alpha = 0.7) +
  geom_vline(aes(xintercept = percentiles$p25trend), linetype = "dashed") +
  geom_vline(aes(xintercept = percentiles$p75trend), linetype = "dashed") +
  labs(x = "CZ Intercept (trend)", title = "Distribution of CZ GDP Trend Coefficients", y = "Frequency") +
  theme_minimal()

trend_pc_hist <- cz_trends %>%
  ggplot() +
  geom_histogram(aes(x = trend_pc), bins = 75, fill = my_color[4], alpha = 0.7) +
  geom_vline(aes(xintercept = percentiles$p25trend_pc), linetype = "dashed") +
  geom_vline(aes(xintercept = percentiles$p75trend_pc), linetype = "dashed") +
  labs(x = "CZ Intercept (trend_pc)", title = "Distribution of CZ GDPpc Trend Coefficients", y = "Frequency") +
  theme_minimal()

trend_hist / trend_pc_hist

## ---------------------------------------------------------
## 6. Plot coefficients by state/region (like your version)
## ---------------------------------------------------------
cz_trends_plot <- cz_trends %>%
  left_join(distinct(select(mines_cz, unit, state)), by = "unit")

cz_trends_plot$state = sapply(cz_trends_plot$state, get_state)
cz_trends_plot$region = sapply(cz_trends_plot$state, get_region)

n_states <- dplyr::n_distinct(cz_trends_plot$state)
tmp <- colorRampPalette(brewer.pal(9, "Oranges"))(n_states + 10)
myOranges <- tmp[-c(1:10)]
myOranges <- myOranges[1:n_states]

cz_states <- cz_trends_plot %>%
  group_by(state) %>%
  arrange(state, trend_pc) %>%
  mutate(midpt = ifelse(row_number() == round((max(row_number()) - min(row_number()))/2),1, NA)) %>%
  ungroup() %>%
  mutate(midpt = row_number() * midpt) %>%
  mutate(unit = factor(unit, levels = unit)) %>%
  ggplot(aes(unit, trend_pc)) +
  geom_segment(aes(x=unit ,xend=unit, y=0, yend=trend_pc, color = state)) +
  geom_point(color="darkblue", size=0.5) +
  coord_flip() +
    geom_label(aes(midpt, 0.09,
                   label = state),
               fill = NA,
               #family = "Special Elite",
               fontface = "bold",
               label.padding = unit(.2, "lines"),
               label.r = unit(.25, "lines"),
               label.size = .05,
             size = 3) +
  labs(x = "Commuting Zones by State", y = "GDPpc Trend") +
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position = "none") +
  scale_color_manual(values = myOranges)



cz_trend <- cz_trends_plot %>%
  arrange(trend_pc) %>%
  mutate(unit = factor(unit, levels = unit)) %>%
  ggplot(aes(unit, trend_pc)) +
  geom_segment(aes(x=unit ,xend=unit, y=0, yend=trend_pc, color = unit)) +
  geom_point(color="darkblue", size=0.5) +
  coord_flip() +
  labs(x = "Commuting Zones", y = "GDPpc Trend") +
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position = "none") +
  scale_color_viridis(discrete = TRUE, option = "rocket", direction = -1)

add_labels(cz_trend, cz_trends_plot, "trend_pc", 5) -> cz_trend

cz_regions <- cz_trends_plot %>%
  group_by(region) %>%
  arrange(region, trend_pc) %>%
  mutate(midpt = ifelse(row_number() == round((max(row_number()) - min(row_number()))/2),1, NA)) %>%
  ungroup %>%
  mutate(midpt = row_number() * midpt) %>%
  mutate(unit = factor(unit, levels = unit)) %>%
  ggplot(aes(unit, trend_pc)) +
  geom_segment(aes(x=unit ,xend=unit, y=0, yend=trend_pc, color = region)) +
  geom_point(color="darkblue", size=0.5) +
  coord_flip() +
  labs(x = "Commuting Zones by Region", y = "GDPpc Trend") +
    geom_label(aes(midpt, 0.09,
                   label = region),
               fill = NA,
               #family = "Special Elite",
               fontface = "bold",
               label.padding = unit(.2, "lines"),
               label.r = unit(.25, "lines"),
               label.size = .05,
             size = 3) +
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position = "none") +
  scale_color_brewer(palette = "Reds")

cz_regions + cz_states +  cz_trend + 
  plot_annotation(
    title = "Commuting Zone GDP pc Growth Rates",
    subtitle = "Intercepts from regressions controlling for national growth and state-specific residual growth"
  )

```

```{r, echo = FALSE, fig.height = 10, fig.width = 10, warning = FALSE, cache = TRUE, fig.cap = "Beta Loadings on GDP pc Growth Rates by CZ"}


## ---------------------------------------------------------
## Scatter plot of betas
## ---------------------------------------------------------
scatter_betas <- cz_trends_plot %>%
  ggplot(aes(x = beta_nat, y = beta_state, color = region)) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5) +
  geom_point(alpha = 0.7) +
  labs(
    x = expression(beta["nat"]~"(loading on national growth)"),
    y = expression(beta["state"]~"(loading on state-specific growth)"),
    title = "Commuting Zone GDPpc Growth Loadings",
    subtitle = "Coefficients from regressions on national growth and state-specific residuals",
    color = "Region"
  ) +
  theme_minimal() +
  scale_color_brewer(palette = "Set2")

## ---------------------------------------------------------
## 9. Histograms of betas
## ---------------------------------------------------------
hist_nat <- cz_trends_plot %>%
  ggplot(aes(x = beta_nat)) +
  geom_histogram(fill = "steelblue", alpha = 0.7, bins = 50) +
  labs(x = expression(beta["nat"]), y = "Count",
       title = "Distribution of beta_nat") +
  theme_minimal()

hist_state <- cz_trends_plot %>%
  ggplot(aes(x = beta_state)) +
  geom_histogram(fill = "tomato", alpha = 0.7, bins = 50) +
  labs(x = expression(beta["state"]), y = "Count",
       title = "Distribution of beta_state") +
  theme_minimal()

scatter_betas / (hist_nat + hist_state)

```

 
We perform the same trend deviation calculation for wages where each wage variable represents the commuting zone, state, and national level growth rate in the weekly average wage as reported in QCEW. \textcolor{red}{We only have national level wage growth data. I have not yet implemented state-level wage growth data. So for now we only use the CZ trend, netting out the national trend. This also explains the missing sections in Figure 13 of the relevant betas.}

<!-- $$\Delta (log) Wage^{CZ}_{t} = \alpha + \Delta (log) Wage^{state}_{t} + \Delta (log) Wage^{national}_{t} + \epsilon_t$$ -->

<!-- New implementation:  -->
<!-- % --- Original specification --- -->
<!-- $$ -->
<!-- \Delta \log Wage^{CZ}_{t}  -->
<!-- = \alpha  -->
<!-- + \beta_{s} \, \Delta \log Wage^{state}_{t}  -->
<!-- + \beta_{n} \, \Delta \log Wage^{nat}_{t}  -->
<!-- + \varepsilon_{t} -->
<!-- $$ -->

$$
\Delta \log Wage^{CZ}_{t} 
= \alpha_{w} 
 + \beta_{n} \, \Delta \log Wage^{nat}_{t}
+ \varepsilon_{t}
$$

```{r, echo = FALSE}
# + \beta_{s} \, \widetilde{\Delta \log Wage}^{state}_{t} 

# $$
# \widetilde{\Delta \log Wage}^{state}_{t} 
# = \Delta \log Wage^{state}_{t} 
# - \hat{\gamma}\, \Delta \log Wage^{nat}_{t}
# $$
```



In Figure 8, we see that there is similar variability though the patterns do not consistently indicate the same high- and low-performing outliers across states indicating that GDP and wage growth are not consistently correlated across regions. We demonstrate this fact in Figure 9 where, although there is a positive correlation between commuting zone GDPpc and wage trend deviations, the wage trend deviation represents a nearly inelastic relationship to GDP growth. Figure 13 presents a correlation coefficient by commuting zone between the two rates, providing greater detail on this relationship. \textcolor{violet}{Georgia is an incredibly intereting case in which nearly all cmomuting zones have relatively declinign GDPpc growth rates but relatively growing wage growth rates}.


```{r, echo = FALSE, fig.height = 10, fig.width = 10, warning = FALSE, cache = TRUE, fig.cap = c("Distribution of Wage Trend Coefficients", "Lollipop Plot of Wage Growth Rates", "Correlation between Wage and GDPpc Trends", "Map of Wage GR - Median", "Map of Wage Level - Median")}

# 0. Prepare CZ-level wage growth + national series (you already did this earlier)
wage_growth_rates <- mines_cz %>%
  select(year, unit, state, gr_weighted_annual_avg_wkly_wage) %>%
  left_join(select(natl_rates, year, gr_natl_annual_avg_wkly_wage_10),
            by = "year")


# INCLUDE ONCE STATE-LEVEL DATA IS AVAILABLE
# # 1. Compute a state-level wage growth series (simple mean across CZs by state-year).
# #    If you have a better weighting (e.g., employment or population), replace mean() with weighted.mean(..., w = <weights>).
# state_rates <- wage_growth_rates %>%
#   group_by(state, year) %>%
#   summarise(gr_state = mean(gr_weighted_annual_avg_wkly_wage, na.rm = TRUE), .groups = "drop")
# 
# # 2. Join state-level series back to CZ-level observations so each CZ-year has gr_state & gr_natl
# wage_growth_rates <- wage_growth_rates %>%
#   left_join(state_rates, by = c("state", "year"))

# 3. Orthogonalise the state series relative to national series:
#    For each state, regress gr_state ~ gr_natl and keep residual = state_resid

growth_rates_wage_orthog <- wage_growth_rates %>%
  group_by(state) %>%
  group_modify(~{
    # fit state-level series on national series (na.action = na.exclude to preserve NAs)
    fm <- try(lm(gr_state ~ gr_natl_annual_avg_wkly_wage_10, data = .x, na.action = na.exclude),
              silent = TRUE)
    if(inherits(fm, "try-error")){
      .x$state_resid <- NA_real_
    } else {
      .x$state_resid <- residuals(fm)
    }
    .x
  }) %>%
  ungroup()


wage_trend_formula <- gr_weighted_annual_avg_wkly_wage ~ gr_natl_annual_avg_wkly_wage_10

# INCLUDE ONCE STATE-LEVEL DATA IS AVAILABLE
# 4. Regression formula (orthogonalised): CZ growth ~ state_resid + national growth
#wage_trend_formula <- gr_weighted_annual_avg_wkly_wage ~ state_resid + gr_natl_annual_avg_wkly_wage_10

# 5. Helper to extract coefficients safely (same style as your GDP template)
extract_coefs_wage <- function(formula_obj, data){
  fit <- lm(formula_obj, data = data)
  cf  <- coef(fit)
  tibble(
    intercept = unname(cf["(Intercept)"]),
    beta_nat  = unname(cf[grepl("gr_natl", names(cf))])#, 
    # INCLUDE ONCE STATE-LEVEL DATA IS AVAILABLE

    #beta_state= unname(cf[grepl("state_resid", names(cf))])
  )
}

# 6. Run the per-CZ regressions and extract intercept (wage_trend)
cz_wage_trends <- growth_rates_wage_orthog %>%
  group_by(unit) %>%
  group_modify(~ extract_coefs_wage(wage_trend_formula, .x)) %>%
  ungroup() %>%   # .id returns the unit label from group_map
  rename(wage_trend = intercept)

# 7. Percentiles and classification flags (same as your original)
percentiles <- cz_wage_trends %>%
  summarize(
    p25trend = quantile(wage_trend, 0.25, na.rm = TRUE),
    p75trend = quantile(wage_trend, 0.75, na.rm = TRUE)
  )

cz_wage_trends <- cz_wage_trends %>%
  mutate(declining = wage_trend < 0,
         declining_extreme = wage_trend < percentiles$p25trend,
         growing_extreme = wage_trend > percentiles$p75trend)

# 8. Join back CZ metadata (state) and region mapping like you do downstream
cz_wage_trends_plot <- cz_wage_trends %>%
  left_join(distinct(select(mines_cz, unit, state)), by = "unit")

# convert/clean state and region columns as in your working code
cz_wage_trends_plot$state  <- sapply(cz_wage_trends_plot$state, get_state)
cz_wage_trends_plot$region <- sapply(cz_wage_trends_plot$state, get_region)

my_color <- viridis_pal(option = "mako")(5)
trend_hist <- cz_wage_trends %>%
  ggplot() +
  geom_histogram(aes(x = wage_trend), bins = 75, fill = my_color[3], alpha = 0.7) +
  geom_vline(aes(xintercept = percentiles$p25trend), linetype = "dashed") +
  geom_vline(aes(xintercept = percentiles$p75trend), linetype = "dashed") +
  labs(x = "CZ Wage Trend Coefficient", title = "Distribution of CZ Wage Trend Coefficients", y = "Frequency") +
  annotate("text", x = percentiles$p25trend, y = 40, label = "25th Percentile", color = my_color[3], angle = 90, vjust = -0.5) +
  annotate("text", x = percentiles$p75trend, y = 40, label = "75th Percentile", color = my_color[3], angle = 90, vjust = 1.5) +
  theme_minimal()

trend_hist

theme_update(plot.background = element_rect(fill = NA),
             panel.background = element_rect(fill = NA, color = NA),
             panel.border = element_rect(fill = NA, color = NA),
             panel.grid.major.x = element_blank(),
             panel.grid.minor = element_blank(),
             axis.text.x = element_blank(),
             axis.text.y = element_text(size = 10),
             axis.ticks = element_blank(),
             axis.title.y = element_text(size = 13,
                                         margin = margin(r = 10)),
             legend.title = element_text(size = 9),
             plot.margin = margin(10, 25, 10, 25))

n_states <- dplyr::n_distinct(cz_wage_trends_plot$state)

# generate more colors than you need, then drop the first k lightest
tmp <- colorRampPalette(brewer.pal(9, "Blues"))(n_states + 10)  # oversample
myBlues <- tmp[-c(1:10)]   # drop the 2 lightest shades
myBlues <- myBlues[1:n_states] 
cz_wage_states <- cz_wage_trends_plot %>%
  group_by(state) %>%
  arrange(state,wage_trend) %>%
  mutate(midpt = ifelse(row_number() == round((max(row_number()) - min(row_number()))/2),1, NA)) %>%
  ungroup %>%
  mutate(midpt = row_number() * midpt) %>%
  mutate(unit = factor(unit, levels = unit)) %>%
  ggplot(aes(unit, wage_trend)) +
  geom_segment(aes(x=unit ,xend=unit, y=0, yend=wage_trend, color = state)) +
  geom_point( color="darkblue", size=0.5) +
  geom_label(aes(midpt, 0.09,
                   label = state),
               fill = NA,
               #family = "Special Elite",
               fontface = "bold",
               label.padding = unit(.2, "lines"),
               label.r = unit(.25, "lines"),
               label.size = .05,
             size = 3) +
  coord_flip() +
  labs(x = "Commuting Zones by State", y = "Wage Trend Coefficient") +
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.x = element_text(size = 14),
        legend.position = "none") +
    scale_color_manual(values = myBlues)

cz_wage_trend <-cz_wage_trends_plot %>%
  arrange(wage_trend) %>%
  mutate(unit = factor(unit, levels = unit)) %>%
  ggplot(aes(unit, wage_trend)) +
  geom_segment(aes(x=unit ,xend=unit, y=0, yend=wage_trend, color = unit)) +
  geom_point( color="darkblue", size=0.05) +
  coord_flip() +
  labs(x = "Commuting Zones", y = "Wage Trend Coefficient") +
    theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.x = element_text(size = 14),
        legend.position = "none") +
    scale_color_viridis(discrete= TRUE, option = "mako", direction = -1)


add_labels(cz_wage_trend, cz_wage_trends_plot, "wage_trend", 5) -> cz_wage_trend

cz_wage_regions <- cz_wage_trends_plot %>%
  group_by(region) %>%
  arrange(region, wage_trend) %>%
  mutate(midpt = ifelse(row_number() == round((max(row_number()) - min(row_number()))/2),1, NA)) %>%
  ungroup %>%
  mutate(midpt = row_number() * midpt) %>%
  mutate(unit = factor(unit, levels = unit)) %>%
  ggplot(aes(unit, wage_trend)) +
  geom_segment(aes(x=unit ,xend=unit, y=0, yend=wage_trend, color = region)) +
  geom_point( color="darkblue", size=0.5) +
  geom_label(aes(midpt, 0.05,
                   label = region),
               fill = NA,
               #family = "Special Elite",
               fontface = "bold",
               label.padding = unit(.2, "lines"),
               label.size = .09,
             size = 4) +
  coord_flip() +
  labs(x = "Commuting Zones by Region", y = "Wage Trend Coefficient") +
  theme(axis.text.y=element_blank(),
        #axis.ticks.y=element_blank(),
        axis.text.x = element_text(size = 14),
        legend.position = "none") +
 scale_color_brewer(palette = "Greens")


cz_wage_regions + cz_wage_states + cz_wage_trend + plot_annotation(title = "Commuting Zone Wage Growth Rate Controlling for National and State Level Trends", subtitle = "Calculated as mean of annual growth rate per commuting zone controlling for national and state level wage growth.",
                                                                   theme = theme(
      plot.title = element_text(size = 18),
      plot.subtitle = element_text(size = 16)
    ))


cz_trends %>% left_join(cz_wage_trends, by = "unit") %>% ggplot(., aes(x = trend_pc, y = wage_trend)) +
     geom_point(alpha = 0.2) +
     geom_smooth(method = "lm", se = TRUE, color = "maroon", fill = "maroon") +
     labs(
         x = "Real GDP pc Trend",
         y = "Wage Trend",
         title = "Relationship Between GDPpc and Wage Trends (per CZ)"
     ) +
     theme_minimal() +
  theme(axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14),
        title = element_text(size = 18))

map_data <- mines_cz %>%
  select(year, unit, log_weighted_annual_avg_wkly_wage, gr_weighted_annual_avg_wkly_wage) %>%
  group_by(unit) %>%
  mutate(gr_weighted_annual_avg_wkly_wage = mean(gr_weighted_annual_avg_wkly_wage, na.rm = TRUE)) %>%
  filter(year == 2021) %>%
  select(unit, year, log_weighted_annual_avg_wkly_wage, gr_weighted_annual_avg_wkly_wage) %>%
  rename(cz_id = unit)

map_gr_wage <- gen_czs_years(map_data) %>%
  left_join(., map_data, by = "cz_id") %>%
  plot_usmap(data = ., values = "gr_weighted_annual_avg_wkly_wage", regions = "counties", col = "gray90", linewidth = 0.01, exclude = c("AK", "HI")) +
  scale_fill_gradient2(midpoint = 0.03, na.value = "palegoldenrod", low = "mediumvioletred", high = "midnightblue") +
  #scale_fill_distiller(colours=c(bl,"white", re), name = "", direction = 1, na.value = "gray90", limits = c(-1, 1)) +
  theme(panel.background = element_rect(color = "white", fill = "white"),
        plot.title = element_text(face = "bold")) +
  labs(title = "Growth Rate of Weekly Wage in Relation to Median (CZ)",
       fill = "Growth Rate in Weekly Wage (2001-2021)")

map_lev_wage <- gen_czs_years(map_data) %>%
  left_join(., map_data, by = "cz_id") %>%
  plot_usmap(data = ., values = "log_weighted_annual_avg_wkly_wage", regions = "counties", col = "gray90", linewidth = 0.01, exclude = c("AK", "HI")) +
  scale_fill_gradient2(midpoint = 6.8, na.value = "palegoldenrod", low = "mediumvioletred", high = "midnightblue" )+
  #scale_fill_distiller(colours=c(bl,"white", re), name = "", direction = 1, na.value = "gray90", limits = c(-1, 1)) +
  theme(panel.background = element_rect(color = "white", fill = "white"),
        plot.title = element_text(face = "bold")) +
  labs(title = "Weekly Wage Level (2021) in Relation to Median (CZ)",
       fill = "(log) Annual Average Weekly Wage")


map_gr_wage
map_lev_wage

```


```{r, echo = FALSE, fig.height = 10, fig.width = 10, warning = FALSE, cache = TRUE, fig.cap = "Lollipop Plot of Wage Growth Rates - right panel of Figure 8"}

# # Find high and low outliers
# outliers <- cz_wage_trends_plot %>%
#   left_join(., cz_labels, by = "unit") %>%
#   arrange(wage_trend) %>%
#   slice(c(1:5, (n()-4):n()))
# 
# plot_df <- cz_wage_trends_plot %>%
#   left_join(cz_labels, by = "unit") %>%
#   arrange(wage_trend) %>%
#   mutate(unit = fct_inorder(unit))   # lock order to the arrange() result
# 
# # Outliers from the same ordered df
# outliers <- bind_rows(slice_head(plot_df, n = 5), slice_tail(plot_df, n= 5))
# 


temp <-  cz_wage_trends_plot %>% 
  arrange(wage_trend) %>%
  mutate(unit = factor(unit, levels = unit)) %>%
  ggplot(aes(x = unit, y = wage_trend)) +
  geom_segment(aes(xend = unit, y = 0, yend = wage_trend, color = unit)) +
  geom_point(color = "darkblue", size = 0.6) +
  # geom_text_repel(data = add_labels(cz_wage_trends_plot, "wage_trend", 5), aes(label = msa), direction = "y",
  #                 nudge_y = 0.02, size = 3, segment.color = "grey60",
  #                 max.overlaps = Inf) +
  coord_flip() +
  scale_x_discrete(limits = levels(cz_wage_trends_plot$unit)) +  # <- enforces the order
  scale_color_viridis(discrete = TRUE, option = "mako", direction = -1) +
  labs(x = "Commuting Zones", y = "Wage Trend Coefficient", title = "Commuting Zone Wage Growth Rate Controlling for National and State Level Trends", subtitle = "Zoom in on left-most plot from above to see outlier labels.") +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 14), legend.position = "none")


add_labels(temp, cz_wage_trends_plot, "wage_trend", 5)


```


```{r, echo = FALSE, fig.height = 10, fig.width = 10, warning = FALSE, cache = TRUE, fig.cap = "Beta Loadings on Wage Growth Rates by CZ"}

# -Creating a safe plotting function until state wage growth rates are incorporated
safe_plot <- function(expr, fail_label = "Plot failed", text_size = 4) {
  tryCatch(
    {
      p <- eval(substitute(expr), envir = parent.frame())
      if (!inherits(p, "ggplot")) stop("Expression did not return a ggplot object")
      # Force build so errors in scales/geoms are triggered here (and caught)
      ggplot_build(p)
      p
    },
    error = function(e) {
      ggplot() +
        geom_rect(aes(xmin = 0, xmax = 1, ymin = 0, ymax = 1),
                  fill = "white", color = "grey80") +
        annotate("text", x = 0.5, y = 0.55,
                 label = fail_label,
                 size = text_size, fontface = "bold", hjust = 0.5) +
      
        theme_void()
    }
  )
}

# Example: safe scatter (will be caught if cz_wage_trends_plot or scale mismatches fail)
scatter_betas <- safe_plot({
  cz_wage_trends_plot %>%
    ggplot(aes(x = beta_nat, y = beta_state, color = region)) +
    geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
    geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5) +
    geom_point(alpha = 0.7) +
    labs(
      x = expression(beta["nat"]~"(loading on national growth)"),
      y = expression(beta["state"]~"(loading on state-specific growth)"),
      title = "Commuting Zone GDPpc Growth Loadings",
      subtitle = "Coefficients from regressions on national growth and state-specific residuals",
      color = "Region"
    ) +
    theme_minimal() +
    scale_color_brewer(palette = "Set2")
}, fail_label = "Expected error: \nMissing state wage growth rates so histogram fails.")
## ---------------------------------------------------------
## 9. Histograms of betas
## ---------------------------------------------------------
hist_nat <- safe_plot({cz_wage_trends_plot %>%
  ggplot(aes(x = beta_nat)) +
  geom_histogram(fill = "steelblue", alpha = 0.7, bins = 50) +
  labs(x = expression(beta["nat"]), y = "Count",
       title = "Distribution of β_nat") +
  theme_minimal()}, fail_label = "hist_nat failed")

hist_state <- safe_plot({cz_wage_trends_plot %>%
  ggplot(aes(x = beta_state)) +
  geom_histogram(fill = "tomato", alpha = 0.7, bins = 50) +
  labs(x = expression(beta["state"]), y = "Count",
       title = "Distribution of β_state") +
  theme_minimal()}, fail_label = "Expected error: \nMissing state wage growth rates so histogram fails.")


scatter_betas / (hist_nat + hist_state)

```

Below, we display, by state, the Pearson correlation coefficient between CZ level GDP growth rates and wage growth rates. Interestingly, many states see nearly exclusively positive correlation coefficients, whereas others see a mix of commuting zones keeping up and lagging local GDP growth. 

```{r, echo = FALSE, fig.height = 10, fig.width = 10, warning = FALSE, cache = TRUE, fig.cap = "Correlation Between GDP Growth Rates and Wage Growth Rates by State"}

# 1) compute unit-level correlations (if you already have this, skip this block)
unit_corr <- mines_cz %>%
  group_by(unit) %>%
  summarise(
    corr_gdp_wage = cor(diff_log_real_gdp_priv_ind_pc,
                        gr_weighted_annual_avg_wkly_wage,
                        use = "pairwise.complete.obs",
                        method = "pearson"),
    .groups = "drop"
  )

# join state/region and keep one row per unit
unit_corr_plot <- unit_corr %>%
  left_join(
    mines_cz %>% select(unit, state) %>% distinct(),
    by = "unit"
  )

# 2) order units by state then by correlation (lowest -> highest within state)
unit_corr_plot <- unit_corr_plot %>%
  arrange(state, corr_gdp_wage) %>%
  mutate(unit_ord = factor(unit, levels = unique(unit)))    # preserve order

# 3) compute midpoint (y position) for each state block so we can label it
state_positions <- unit_corr_plot %>%
  group_by(state) %>%
  summarise(
    start = min(as.integer(unit_ord)),
    end   = max(as.integer(unit_ord)),
    mid   = (start + end) / 2,
    .groups = "drop"
  )

# # 4) plot: single column of tiles, states grouped (x is constant=1)
# #p_single_column <- 
#   ggplot(unit_corr_plot) +
#   geom_tile(aes(x = 1, y = unit_ord, fill = corr_gdp_wage), color = "white", height = 0.95) +                 # tile per unit
#   scale_fill_viridis_c(option = "mako", limits = c(-1, 1), na.value = "grey90") +
#   # state separators: horizontal lines between blocks (at integer + 0.5 positions)
#   geom_hline(
#     data = state_positions %>% mutate(bound = end + 0.5),
#     aes(yintercept = bound),
#     color = "grey70", size = 0.3
#   ) +
#   #state labels positioned to the left of the tiles
#   geom_text(
#     data = state_positions,
#     aes(x = 0.7, y = mid, label = state),
#     hjust = 1, fontface = "bold", size = 3
#   ) +
#   #coord_fixed(ratio = 0.045, clip = "off") +                 # shrink tile height; allow labels outside
#   scale_x_continuous(limits = c(0.4, 1.1), expand = c(0,0)) +
#   labs(
#     title = "Per-unit correlation: GDP per capita vs wages",
#     subtitle = "Tiles grouped by state; darker = stronger positive correlation",
#     x = NULL, y = NULL,
#     fill = "Correlation"
#   ) +
#   theme_minimal(base_size = 12) +
#   theme(
#     axis.text = element_blank(),
#     axis.ticks = element_blank(),
#     panel.grid = element_blank(),
#     legend.position = "right",
#     plot.margin = margin(5, 40, 5, 80)   # give space on left for state labels
#   )
# 
# # show plot
# p_single_column


unit_corr_plot$state = sapply(unit_corr_plot$state, get_state)
unit_corr_plot$region = sapply(unit_corr_plot$state, get_region)


ggplot(unit_corr_plot %>% arrange(corr_gdp_wage) %>%
         mutate(unit = factor(unit, levels = unit)),
       aes(x = unit, y = corr_gdp_wage, fill = corr_gdp_wage)) +
  geom_col(show.legend = FALSE) +
  geom_hline(aes(yintercept = 0)) + 
  scale_fill_viridis_c(option = "cividis", limits = c(-1, 1)) +
  coord_flip() +
  labs(
    title = "Commuting Zone Correlation between GDPpc Growth and Wage Growth",
    x = "Commuting Zone (Unit)",
    y = "Correlation Coefficient"
  ) +
  facet_wrap(~state, scales = "free") +
  common_theme +
  theme(
    panel.grid = element_blank(),   # remove grid lines
    panel.background = element_blank(), # remove gray panel background
    plot.background = element_blank(),  # remove outer gray background
    strip.background = element_blank()  # remove facet label background
  )

```




```{r, echo = FALSE, cache = TRUE}

mines_cz_decl <- cz_trends %>%
  select(unit, contains("trend"), contains("growing"), contains("declining")) %>%
  left_join(mines_cz, ., by = "unit")

mines_cz_wage_decl <- cz_wage_trends %>%
  select(unit, contains('trend'), contains('growing'), contains('declining')) %>%
  left_join(mines_cz, ., by = "unit")

# print("Declining")
# run_model(selected_iv_models, filter(mines_cz_decl, declining_pc)) %>% etable(headers = c("INSTR: Total Active Prod", "INSTR: (l1) Total Active Prod","INSTR: Total Active Prod", "INSTR: (l1) Total Active Prod"))
# print("Growing")
# run_model(selected_iv_models, filter(mines_cz_decl, !declining_pc)) %>% etable(headers = c("INSTR: Total Active Prod", "INSTR: (l1) Total Active Prod","INSTR: Total Active Prod", "INSTR: (l1) Total Active Prod"))
#
# print("Extreme Decline (25th percentile of growth rates)")
# run_model(selected_iv_models, filter(mines_cz_decl, declining_pc_extreme)) %>% etable(headers = c("INSTR: Total Active Prod", "INSTR: (l1) Total Active Prod","INSTR: Total Active Prod", "INSTR: (l1) Total Active Prod"))
#
# print("Extreme Growth (75th percentile of growth rates)")
# run_model(selected_iv_models, filter(mines_cz_decl, growing_pc_extreme)) %>% etable(headers = c("INSTR: Total Active Prod", "INSTR: (l1) Total Active Prod","INSTR: Total Active Prod", "INSTR: (l1) Total Active Prod"), title = "Hello")

```

### Baseline Models

Tables 10 and 11 examine how the relationship between local economic conditions and elementary education expenditure per pupil varies across structurally growing and declining regions as defined in the previous section. We partition our sample into four sub-samples by their values of $\alpha_{w}$ and $\alpha_{g}$.

| Category | Definition Wage | Definition GDP |
|-----------|-----------------|----------------|
| Declining | $\alpha_{w} < 0$ | $\alpha_{g} < 0$ |
| Hyper-Declining | $\alpha_{w} < P_{25}(\alpha_{w})$ | $\alpha_{g} < P_{25}(\alpha_{g})$ |
| Growing | $\alpha_{w} > 0$ | $\alpha_{g} > 0$ |
| Hyper-Growing | $\alpha_{w} > P_{75}(\alpha_{w})$ | $\alpha_{g} > P_{75}(\alpha_{g})$ |


Zones with negative (positive) values of $\alpha_{w}$ or $\alpha_g$ are designated as declining (growing), while those in the bottom (P25) and top (P75) quartiles are labelled hyper-declining and hyper-growing, respectively. This stratification enables comparison of fiscal responsiveness across local economies with different long-run growth trajectories.

Table 10 partitions CZs by long-run GDP per capita trends. Enrollment is consistently negative, confirming that scaling effects apply across all commuting zones, regardless of long-run trends. However, the responsiveness of education spending to local GDP differs slightly across regimes.
In declining and hyper-declining areas, GDP coefficients are small and statistically insignificant (except l3), suggesting that output growth in these regions does not translate into higher fiscal capacity or local public investment.
By contrast, in growing and hyper-growing CZs, GDP effects become positive and significant—typically 0.07-0.14, indicating that structurally expanding economies reinvest local income gains into education.
Lagged wage effects are also stronger in these dynamic regions, implying that education budgets adjust upward with rising labor costs or income-driven demand for schooling. \textcolor{red}{Interpret house price elasticities and l3 of real GDP and Wage growth in declining and hyper-declining regions. The positive effects in growing regions could also indicate more expensive education provision (ie. teacher salaries rise, etc.) which is worth noting as an alternative interpretation that does not serve our narrative}.

Table 11 partitions CZs by $\alpha_w$. The broad patterns are similar, but an important distinction emerges wherein the elasticity of education spending with respect to wages is remarkably consistent across all regional regimes. In both declining and growing CZs, a 1% increase in local wages is associated with roughly a 0.18–0.25 percent increase in per-pupil expenditure, and these coefficients are uniformly significant. This suggests that local wage changes influence education budgets through a consistent channel across local economies, not just in dynamic regions. \textcolor{red}{Hypothesise why this might be...?}

\textcolor{violet}{Potential interpretation: This asymmetry implies that while the wage–spending elasticity is pervasive, the sources of fiscal responsiveness differ: in expanding regions, wage growth coincdies with broader income and asset growth, amplifying local revenues; in declining regions, wage changes affect spending primarily through higher labor costs rather than expanded fiscal capacity. Overall, the comparison between the GDP- and wage-based partitions reveals two complementary insights.
First, local fiscal systems everywhere are sensitive to wage movements. Second, the degree to which broader economic variables (GDP, property values, and transfers) translate into education spending depends on structural growth performance: prosperous regions exhibit stronger links between economic activity and public investment, whereas struggling regions rely more heavily on intergovernmental support. These results highlight that the uniform wage effect coexists with substantial heterogeneity in other transmision channels, reinforcing the idea that local fiscal sensitivity is shaped by both macroeconomic structure and long-run growth potential.}

```{r, echo = FALSE, results = 'asis', cache = TRUE}

form <- paste0(baseline_sw_short, " | unit + year")

# gr_form <- "diff_log_real_Elem_Educ_Total_Exp_pp ~ sw(diff_log_real_gdp_priv_ind_pc + l1_diff_log_real_gdp_priv_ind_pc + l2_diff_log_real_gdp_priv_ind_pc, gr_weighted_annual_avg_wkly_wage + l1_gr_weighted_annual_avg_wkly_wage + l2_gr_weighted_annual_avg_wkly_wage, gr_hpi + l1_gr_hpi + l2_gr_hpi + l3_gr_hpi + l4_gr_hpi) + diff_log_real_Total_IG_Revenue_pp | unit + year"

for(k in list(form)){ # gr_form)){ #prop_vals_form, gr_prop_vals_form)){
  mods_list <- list()
  mods_list["Declining"] <- run_model(k, filter(mines_cz_decl, declining_pc))
  n_forms <- mods_list[['Declining']] %>% length
  mods_list["Hyper-Declining"] <- run_model(k, filter(mines_cz_decl, declining_pc_extreme))
  mods_list["Growing"] <- run_model(k, filter(mines_cz_decl, !declining_pc))
  mods_list["Hyper-Growing"] <- run_model(k, filter(mines_cz_decl, growing_pc_extreme))
  etable(mods_list, tex = latex_tables, adjustbox = TRUE, headers = rep(names(mods_list), each = n_forms), title = "Baseline Regression Applied to Declining GDP vs. Growing GDP Regions",  label = "tab:baseline_gdp_subsamples") %>% print(.)
}


for(k in list(form)){ # gr_form)){ #prop_vals_form, gr_prop_vals_form)){
  mods_list <- list()
  mods_list["Declining"] <- run_model(k, filter(mines_cz_wage_decl, declining))
  n_forms <- mods_list[['Declining']] %>% length
  mods_list["Hyper-Declining"] <- run_model(k, filter(mines_cz_wage_decl, declining_extreme))
  mods_list["Growing"] <- run_model(k, filter(mines_cz_wage_decl, !declining))
  mods_list["Hyper-Growing"] <- run_model(k, filter(mines_cz_wage_decl, growing_extreme))
  etable(mods_list, tex = latex_tables, adjustbox = TRUE, headers = rep(names(mods_list), each = n_forms), title = "Baseline Regression Applied to Declining Wage vs. Growing Wage Regions",  label = "tab:baseline_wage_subsamples") %>% print(.)
}

```

\FloatBarrier

```{r, echo = FALSE}

decl <- filter(mines_cz_decl, declining_pc)
grow <- filter(mines_cz_decl, !declining_pc)

decl_extr <- filter(mines_cz_decl, declining_pc_extreme)
grow_extr <- filter(mines_cz_decl, growing_pc_extreme)

dfs <- list("All" = mines_cz_decl, "Declining (GDP)" = decl, "Hyper-Declining (GDP)" = decl_extr, "Growing (GDP)" = grow, "Hyper-Growing (GDP)" = grow_extr)


decl_wage <- filter(mines_cz_wage_decl, declining)
grow_wage <- filter(mines_cz_wage_decl, !declining)

decl_extr_wage <- filter(mines_cz_wage_decl, declining_extreme)
grow_extr_wage <- filter(mines_cz_wage_decl, growing_extreme)

dfs_wage <- list("All" = mines_cz_decl, "Declining (Wage)" = decl_wage, "Hyper-Declining (Wage)" = decl_extr_wage, "Growing (Wage)" = grow_wage, "Hyper-Growing (Wage)" = grow_extr_wage)


```

```{r, echo = FALSE}

mods <- list()
for(df in names(dfs)){
    # IV regression using shift-share instrument
    iv_model <- feols(
   as.formula(paste0(iv_lev_form, " | year + state | log_weighted_annual_avg_wkly_wage ~ l(lev_ss_2d)")),
   data = left_join(dfs[[df]], rename(ss_temp, unit = cz_id), by = c("year", "unit")), panel.id = c("unit", "year"))
    mods[[df]] <- iv_model

}

mods_wage <- list()
for(df_wage in names(dfs_wage)){
    # IV regression using shift-share instrument
    iv_model <- feols(
   as.formula(paste0(iv_lev_form, " | year + state | log_weighted_annual_avg_wkly_wage ~ l(lev_ss_2d)")),
   data = left_join(dfs_wage[[df_wage]], rename(ss_temp, unit = cz_id), by = c("year", "unit")), panel.id = c("unit", "year"))
    mods_wage[[df_wage]] <- iv_model
}

```

### IV Models

When applying our instrumental variable design we find that majority of our relevant signal is picked up in regions across both trend metrics. Though the effects are more consistent across wage-trending sub-samples \textcolor{red}{Not yet sure how to interpret.}

```{r, echo = FALSE, results = 'asis'}

etable(mods, tex = latex_tables, adjustbox = TRUE, headers = names(mods), fitstat = iv_fitstats, title = "Wage-based Shift-Share Instrument (l1) Applied to Declining GDP vs. Growing GDP Regions", label = "tab:wage_ss_gdp_subsamples") 
etable(mods_wage, tex = latex_tables, adjustbox = TRUE, headers = names(mods_wage), fitstat = iv_fitstats, title = "Wage-based Shift-Share Instrument (l1) Applied to Declining Wage vs. Growing Wage Regions", label = "tab:wage_ss_wage_subsamples")

```

\FloatBarrier

```{r, echo = FALSE}

mods <- list()
for(df in names(dfs)){
    # IV regression using shift-share instrument
    iv_model <- feols(
   as.formula(paste0(iv_lev_form, " | year + state | log_weighted_annual_avg_wkly_wage ~ l(lev_gdp_ss_2d)")),
   data = left_join(dfs[[df]], rename(ss_temp, unit = cz_id), by = c("year", "unit")), panel.id = c("unit", "year"))
    mods[[df]] <- iv_model

}

mods_wage <- list()
for(df_wage in names(dfs_wage)){
    # IV regression using shift-share instrument
    iv_model <- feols(
   as.formula(paste0(iv_lev_form, " | year + state | log_weighted_annual_avg_wkly_wage ~ l(lev_gdp_ss_2d)")),
   data = left_join(dfs_wage[[df_wage]], rename(ss_temp, unit = cz_id), by = c("year", "unit")), panel.id = c("unit", "year"))
    mods_wage[[df_wage]] <- iv_model
}

```

The sub-sampling procedure indicates the link between public education expenditure and wages is present in hyper-growing GDP regions only. However, \textcolor{red}{and I am unsure how to interpret this}, the wage effect when using the GDP-based shift-share instrument has different signs depending on rate of wage growth. 

```{r, echo = FALSE, results='asis'}

etable(mods_wage, tex = latex_tables, headers = names(mods_wage), adjustbox = TRUE, fitstat = iv_fitstats, title = "GDP-based Shift-Share Instrument (l1) Applied to Declining Wage vs. Growing Wage Regions", label = "tab:gdp_ss_wage_subsamples")
etable(mods,   tex = latex_tables, adjustbox = TRUE, headers = names(mods), fitstat = iv_fitstats, title = "GDP-based Shift-Share Instrument (l1) Applied to Declining GDP vs. Growing GDP Regions", label = "tab:gdp_ss_gdp_subsamples")

```
\FloatBarrier

### State-by-state estimation

Given the substantial heterogeneity in state-level economic makeup and public finance regimes, we investigate state-specific and industry-specific relationships between our variables of interest. 

First, states vary in the number of commuting zones they contain. Figure 15 demonstrates that states contain anywhere from 2 (Delaware) - 58 (Texas) commuting zones. This allows us to estimate panel-style regressions within each state to net out between-state variation that might be confounding our current treatment estimates (of course, these should be interpreted with caution in those states that contain very few commuting zones). 

Second, given our shift-share instruments are the composite effect of shifts in industry-level wages and real value added, we can decompose this instrument into industry-specific shocks wage and real value added shocks. This decomposition allows us to examine the effect of industry-specific changes across states in a more explicit manner. In other words, our instrument is...

$$
    \tilde{Z}_{ijt} = G_{njt} *  \frac{N_{ij\tau}}{N_{i\tau}}
$${#eq-bartik-decomposed}

...rather than the sum of all industry-level shocks. 

```{r, echo = FALSE, results = 'asis', fig.cap = "Histogram: Commuting Zones by State"}
reg_states <- mines_cz %>%
  pull(state) %>%
  unique
  
mines_cz %>%
  group_by(state) %>%
  summarise(n_czs = n_distinct(cz_id)) -> hist_states_cz

hist_states_cz$state_name = sapply(hist_states_cz$state, get_state)

outliers <- filter(hist_states_cz, n_czs > 25)

ggplot(hist_states_cz, aes(x = n_czs)) +
  geom_histogram(bins = 25, fill = "dodgerblue4", color = "white", alpha = 0.8) +
  # add invisible points for label positioning
  geom_point(data = outliers, aes(y = 0), alpha = 0) +
  geom_text_repel(
    data = outliers,
    aes(x = n_czs, y = 1, label = state_name),
    nudge_y = 3.5,
    size = 3,
    color = "black"
  ) +
  common_theme +
  labs(
    x = "Number of Commuting Zones in State",
    y = "Number of States",
    title = "Distribution of Commuting Zones per State"
  )

```

\FloatBarrier

### Industry by Industry 

First, we estimate separate panel regressions using the full commuting zone sample and then grouping commuting zones by state. We instrument local level wages using these decomposed shift-share shocks by industry. 

Using our value added-based shift share instrument, Figure 15 demonstrates the overall treatment effect of local wage changes instrumented via an industry-specific GDP shock. 

```{r indind, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 8, fig.cap = "Wage Effect via Industry VA SS Shock"}

dat_temp <- left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit"))


# Function to extract relevant info from each model
extract_coef_info <- function(model, state_name) {
  # Get summary
  coef_summary <- summary(model)$coeftable
  model_r2 <- r2(model, type = "wr2")

  # Filter for relevant variables
  coef_df <- as.data.frame(coef_summary) %>%
    rownames_to_column("variable") %>%
    filter(variable %in% vars_of_interest) %>%
    mutate(
      state = state_name,
      significance = case_when(
        `Pr(>|t|)` < 0.001 ~ "***",
        `Pr(>|t|)` < 0.01  ~ "**",
        `Pr(>|t|)` < 0.05  ~ "*",
        `Pr(>|t|)` < 0.1   ~ ".",
        TRUE               ~ ""
      ),
      r2_within = model_r2) %>%
    select(state, variable, estimate = Estimate, significance, r2_within)

  return(coef_df)
}

# --- 0) Inputs / variable list ------------------------------------------------
temp_vars <- ss_temp %>%
  select(starts_with("gdp_ss"), -contains("2d")) %>%  # <- fix select syntax
  names()

vars_of_interest <- c("fit_log_weighted_annual_avg_wkly_wage")

# --- 1) Run models and collect estimates --------------------------------------
ind_mods <- tibble()
for (k in temp_vars) {

  # "All" model IV
  iv_model <- feols(
    as.formula(paste0(
      iv_lev_form,
      "| state + year | log_weighted_annual_avg_wkly_wage ~ l(", k, ")"
    )),
    data = dat_temp, panel.id = c("unit", "year")
  ) %>% extract_coef_info(state_name = "All")

  # State-by-state models
  state_mods_ind <- list()
  for (s in reg_states) {
    tmp <- dat_temp %>% filter(state == s)

    if (tmp %>%
        select(state, unit, year, !!k) %>%
        group_by(unit) %>%
        filter(!all(is.na(get(k)))) %>% n_groups(.) == 1) {
      # skip if no variation
    } else {
      mod <- tmp %>%
        feols(
          as.formula(paste0(
            iv_lev_form,
            "| unit + year | log_weighted_annual_avg_wkly_wage ~ l(", k, ")"
          )),
          data = ., panel.id = c("unit", "year")
        )
      state_mods_ind[[s]] <- mod
    }
  }

  ind_mods <- imap_dfr(state_mods_ind, extract_coef_info) %>%
    rbind(iv_model) %>%
    mutate(industry = gsub("gdp_ss_", "", k)) %>%
    rbind(., ind_mods)
}

# --- 2) Map industry codes to names (using your rel_inds) ---------------------
# assumes: rel_inds is a named vector where names(rel_inds) are industry names
# and values (or names) match the 'industry' codes we created above
results_df <- ind_mods %>%
  mutate(industry_name = names(rel_inds)[match(industry, rel_inds)])

# --- 3) Clean labels (no ordering yet) ----------------------------------------
base_df <- results_df %>%
  mutate(
    label = dplyr::case_when(variable == "fit_log_weighted_annual_avg_wkly_wage" ~ "Wage Effect")
  )

# --- 4) Derive the x-axis order ONLY from the All-model estimates -------------
order_levels <- base_df %>%
  filter(state == "All") %>%
  arrange(desc(estimate)) %>%
  pull(industry_name) %>%
  unique()

# --- 5) Apply order and final cleaning ----------------------------------------
results_df_cleaned <- base_df %>%
  mutate(
    industry_label   = factor(industry_name, levels = order_levels),
    overall_estimate = dplyr::if_else(state == "All", estimate, NA_real_)
  ) #%>%
  #filter(r2_within > 0)

# --- 6) Plot -------------------------------------------------------------------
plot <- results_df_cleaned %>%
  ggplot(aes(x = industry_label)) +
  # state-specific estimates (light x's)
  geom_point(
    data = ~ dplyr::filter(.x, state != "All" & significance != ""),
    aes(y = estimate),
    shape = 4, size = 3
  ) +
  # "All" estimate (colored by within R2)
  geom_point(
    data = ~ dplyr::filter(.x, state == "All"),
    aes(y = estimate, fill = r2_within),
    size = 6, shape = 21
  ) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  common_theme +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 90, hjust = 1)
  ) +
  labs(
    title = "Effect of 1% Increase in Wage on Ed. Exp. per Pupil Using Industry-Specific GDP SS Shock",
    x = "Industry",
    y = "Coefficient Estimate",
    caption = "Effect of 1% increase in Wage Using Industry-Specific GDP (shift-share) Shocks. Controls: enrollment, GDP, intergov transfers, year & state FE.\nWithin R² of 'All' estimation in point color.\n X reflects statistically significant state-specific treatment effects with CZ FE.",
    color = "Within R² (All model)",
    alpha = "Statistical Significance"
  ) +
  scale_fill_distiller(direction = 1, palette = "Greens")

# Lock order and finish
plot +
  scale_x_discrete(limits = order_levels,
                   labels = function(x) stringr::str_wrap(x, width = 14)) +
  coord_cartesian(ylim = c(-1, 1)) +
  scale_x_discrete(
    limits = order_levels,
    labels = function(x) stringr::str_wrap(x, width = 14)
  ) +
  guides(x = guide_axis(n.dodge = 2)) +
  coord_cartesian(clip = "off") +
  theme(
    axis.text.x  = element_text(size = 8, vjust = 1, hjust = 1, angle = 35),
    plot.margin  = margin(t = 10, r = 10, b = 70, l = 10),
    legend.position = "top"
  ) +
  scale_fill_distiller(direction = 1, palette = "Greens") +
  guides(
    fill = guide_colorbar(
      title = "Within R² (All model)",
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(6, "cm"),     # wider bar for cleaner labels
      barheight = unit(0.6, "cm"),
      label.position = "bottom"     # moves tick labels below the bar
    )
  ) +
  theme(
    legend.position = "top",              # places legend above plot
    legend.direction = "horizontal",      # ensures horizontal bar
    legend.key.width = unit(2.5, "cm"),   # sets consistent spacing for color keys
    legend.key.height = unit(0.5, "cm"),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9),
    legend.spacing.x = unit(0.2, "cm"),   # adds horizontal padding
    legend.box.margin = margin(t = 0, r = 0, b = 0, l = 0),
    legend.box.spacing = unit(3, "mm")    # space between legend & plot
  )

```

#### Wage

Using our wage-based shift share instrument, Figure 17 demonstrates the overall treatment effect of local wage changes instrumented via our wage-based shift-share shock. 

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 8, fig.cap = "Wage Effect via Industry Wage SS Shock"}

# --- 0) Inputs kept as-is -----------------------------------------------------
temp_vars <- ss_temp %>%
  select(starts_with("ss"), -contains("2d"), -contains("3d")) %>%
  names()

vars_of_interest <- c("fit_log_weighted_annual_avg_wkly_wage")

# --- 1) Run models and collect estimates --------------------------------------
ind_mods <- tibble()
for (k in temp_vars) {

  # All-states IV (the "All" point)
  iv_model <- feols(
    as.formula(paste0(
      iv_lev_form,
      "| state + year | log_weighted_annual_avg_wkly_wage ~ l(", k, ")"
    )),
    data = dat_temp, panel.id = c("unit", "year")
  ) %>% extract_coef_info(state_name = "All")

  # State-by-state models
  state_mods_ind <- list()
  for (s in reg_states) {
    tmp <- dat_temp %>% filter(state == s)

    if (tmp %>%
        select(state, unit, year, !!k) %>%
        group_by(unit) %>%
        filter(!all(is.na(get(k)))) %>% n_groups(.) == 1) {
      # skip if no variation
    } else {
      mod <- tmp %>%
        feols(
          as.formula(paste0(
            iv_lev_form,
            "| unit + year | log_weighted_annual_avg_wkly_wage ~ l(", k, ")"
          )),
          data = ., panel.id = c("unit", "year")
        )
      state_mods_ind[[s]] <- mod
    }
  }

  ind_mods <- imap_dfr(state_mods_ind, extract_coef_info) %>%
    rbind(iv_model) %>%
    mutate(industry = gsub("ss_", "", k)) %>%
    rbind(., ind_mods)
}

# --- 2) Robust labeling (NAICS key) -------------------------------------------
naics_key <- tibble::tribble(
  ~naics_code, ~industry_name,
  "11","Agriculture, Forestry, Fishing, and Hunting",
  "21","Mining",
  "22","Utilities",
  "23","Construction",
  "31-33","Manufacturing",
  "42","Wholesale Trade",
  "44-45","Retail Trade",
  "48-49","Transportation and Warehousing",
  "51","Information",
  "52","Finance and Insurance",
  "53","Real Estate and Rental and Leasing",
  "54","Professional, Scientific, and Technical Services",
  "55","Management of Companies and Enterprises",
  "56","Administrative and waste management services",
  "61","Educational Services",
  "62","Health Care and Social Assistance",
  "71","Arts, Entertainment, and Recreation",
  "72","Accommodation and Food Services",
  "81","Other Services, except government",
  "92","Public Administration"
)

# --- 3) Clean, join labels (no ordering yet) ----------------------------------
base_df <- ind_mods %>%
  mutate(
    variable   = ifelse(variable == "fit_log_weighted_annual_avg_wkly_wage", "fit_log_weighted_annual_avg_wkly_wage", variable),
    label      = dplyr::case_when(variable == "fit_log_weighted_annual_avg_wkly_wage" ~ "HPI Effect"),
    naics_code = gsub("^ss_", "", industry) |> gsub("_", "-", x = _)
  ) %>%
  left_join(naics_key, by = "naics_code")

# --- 4) Derive the x-axis order ONLY from the All-model estimates -------------
order_levels <- base_df %>%
  filter(state == "All") %>%
  arrange(desc(estimate)) %>%
  pull(industry_name) %>%
  unique()

# --- 5) Apply order and final cleaning ----------------------------------------
results_df_cleaned <- base_df %>%
  mutate(
    industry_label   = factor(industry_name, levels = order_levels),
    overall_estimate = dplyr::if_else(state == "All", estimate, NA_real_)
  ) #%>%
  #filter(!is.na(r2_within), r2_within > 0)

# --- 6) Plot -------------------------------------------------------------------
sig_levels <- c("***","**","*",".")

plot <- results_df_cleaned %>%
  ggplot(aes(x = industry_label)) +
  # state-specific estimates
  geom_point(
    data = ~ dplyr::filter(.x, state != "All" & significance != ""),
    aes(y = estimate),
    shape = 4, size = 2, alpha = 0.5,
    position = position_jitter(width = 0, height = 0.01)
  ) +
  # All (overall) estimate, colored by within R^2
  geom_point(
    data = ~ dplyr::filter(.x, state == "All"),
    aes(y = estimate, color = r2_within, shape = factor(significance, levels = sig_levels)),
    size = 4, stroke = 1
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 0.5) +
  coord_cartesian(ylim = c(-1, 1)) +
  scale_shape_manual(
    name = "Significance",
    values = c("***" = 16, "**" = 17, "*" = 15, "." = 18),
    drop = FALSE
  ) +
  scale_color_viridis_c(name = "Within R² (All model)", option = "C", direction = 1) +
  labs(
    title = "Effect of 1% Increase in Industry-Specific Wage on Education Expenditure per Pupil",
    subtitle = "Dots: State-specific estimates (light) and overall estimate (colored by within R²)",
    x = "Industry (NAICS 2–3 digit groups)", y = "Coefficient estimate",
    caption = "IV: shift-share instrument; controls: enrollment, GDP, intergov transfers; FE: year & state.\nOverall points are from the 'All' model; X represent state-level treatment effects with CZ FE."
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    panel.grid.minor.y = element_blank()
  )

# lock x-order and wrap labels
plot +
  scale_x_discrete(
    limits = order_levels,
    labels = function(x) stringr::str_wrap(x, width = 14)
  ) +
  guides(x = guide_axis(n.dodge = 2)) +
  coord_cartesian(clip = "off") +
  theme(
    axis.text.x  = element_text(size = 8, vjust = 1, hjust = 1, angle = 35),
    plot.margin  = margin(t = 10, r = 10, b = 70, l = 10),
    legend.position = "top"
  )
```

\FloatBarrier

Across both, we find consistently positive effects when using shift-share shocks from the construction; real estate, rental and leasing; agriculture, forestry, and fishing; professional, scientific and technical services industries.

However, for other industries we find opposite effects depending on the instrument shock chosen. 

\textcolor{Red}{Jennie: Again, interpretation of the relationship between the instrument and the outcome is shady here...might it be worth applying this outside of an IV framework, arguing that the shift-share instrument is in itself exogenous.}

Next, we turn to state-by-state estimation, the regression coefficients of which are reported in Figure 18. First, we re-employ our baseline regression in which we regress our outcome variable on wage levels at time $t-h$ where $h = [t-0,t-2]$. The plot below displays the cumulative effect of a 1% increase in wage levels on education expenditure per pupil in purple. The X marks represent the individual betas on each time lag (ie. the linearly combined coefficients that form the total dynamic effect). Majority of states see positive elasticities in relation to wage changes in this descriptive specification, but some (Kansas, Wyoming, Missouri, Washington) see negative elasticities. \textcolor{red}{I think we should have a commuting zone N sample size exclusion restriciton here. The results for Maine, New Jersey, and Delaware, for example are based on only 2-3 units.}

```{r, echo = FALSE, results = 'asis', fig.height = 8, fig.width = 10, fig.cap = "State-by-State Wage Effect - Descriptive"}


state_mods <- list()
for(k in reg_states){
  mod <- dat_temp %>%
    filter(state == k) %>%
    feols(as.formula("log_real_Elem_Educ_Total_Exp_pp ~ log_weighted_annual_avg_wkly_wage + l1_log_weighted_annual_avg_wkly_wage + l2_log_weighted_annual_avg_wkly_wage + log_real_Total_IG_Revenue_pp + log_real_gdp_priv_ind_pc + log_Enrollment | unit + year"),
    data = ., panel.id = c("unit", "year"))
  state_mods[[as.character(k)]] <- mod
}

# Define variable names of interest
vars_of_interest <- c("log_weighted_annual_avg_wkly_wage",
                      "l1_log_weighted_annual_avg_wkly_wage",
                      "l2_log_weighted_annual_avg_wkly_wage")

# Function to extract relevant info from each model
extract_coef_info <- function(model, state_name) {
  # Get summary
  coef_summary <- summary(model)$coeftable
  model_r2 <- r2(model, type = "wr2")

  # Filter for relevant variables
  coef_df <- as.data.frame(coef_summary) %>%
    rownames_to_column("variable") %>%
    filter(variable %in% vars_of_interest) %>%
    mutate(
      state = state_name,
      significance = case_when(
        `Pr(>|t|)` < 0.001 ~ "***",
        `Pr(>|t|)` < 0.01  ~ "**",
        `Pr(>|t|)` < 0.05  ~ "*",
        `Pr(>|t|)` < 0.1   ~ ".",
        TRUE               ~ ""
      ),
      r2_within = model_r2) %>%
    select(state, variable, estimate = Estimate, significance, r2_within)

  return(coef_df)
}

# Apply to list of models
# Assuming: model_list is named by state names
results_df <- imap_dfr(state_mods, extract_coef_info)
results_df$state_name <- sapply(results_df$state, get_state)

results_df_cleaned <- results_df %>%
  # Add lag labels
  mutate(label = case_when(
    variable == 'log_weighted_annual_avg_wkly_wage' ~ 'l0',
    variable == 'l1_log_weighted_annual_avg_wkly_wage' ~ 'l1',
    variable == 'l2_log_weighted_annual_avg_wkly_wage' ~ 'l2'
  )) %>%
  # filter(significance != "") %>%
  # Compute total estimate and max R²
  group_by(state_name) %>%
  mutate(
    total_estimate = sum(estimate, na.rm = TRUE),
    any_significant = any(significance != ""),
    r2_within_max = max(r2_within, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  # Order `state` by R²
  mutate(state_name = fct_reorder(state_name, total_estimate, .desc = TRUE)) %>%
  # Create numeric lag order (to control x-axis sorting within each state)
  mutate(
    lag_order = case_when(label == "l0" ~ 1,
                          label == "l1" ~ 2,
                          label == "l2" ~ 3),
    state_label = paste(state_name, label, sep = "_")
  ) %>%
  # Reorder state_label using combined (state, lag_order)
  arrange(state_name, lag_order) %>%
  mutate(state_label = factor(state_label, levels = unique(state_label)))


# Create axis labels: state names at 'l1' only, blanks otherwise
axis_labels <- ifelse(grepl("_l0$", levels(results_df_cleaned$state_label)),
                      gsub("_l0$", "", levels(results_df_cleaned$state_label)),
                      "")

results_df_cleaned %>%
  # Plot
  ggplot(aes(x = state_label)) +
  geom_point(aes(y = estimate, alpha = significance), shape = "x", size = 3) +
  # geom_point(
  #   data = . %>% filter(label == "l1"),
  #   aes(y = total_estimate, color = r2_within_max), size = 2
  # ) +
  geom_point(
    data = . %>% filter(label == "l1"),
    aes(y = total_estimate, color = as.numeric(any_significant)), size = 2
  ) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  common_theme +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 90, hjust = 1)
  ) +
  labs(
    title = "Effect of 1% Increase in Wage on Education Expenditure per Pupil",
    x = "States (Each with lags: l0, l1, l2)",
    y = "Coefficient Estimate",
    caption = "Effect of contemporaneous, l1, l2 lag of avg weekly wage on PP Education\n Expenditure controlling for enrollment, GDP, and intergovernmental transfers. \n Each state has 3 lagged wage coefficients (l0, l1, l2).\nBlue dots show total effect across lags, plotted at the l1 position.\n Within R^2 of state-level estimation reflected in color of point).",
    color = "Within R2 of State-level Estimation",
    alpha = "Statistical Significance"
  ) +
    scale_x_discrete(labels = axis_labels) +
  scale_color_distiller(direction = 1, palette = "Purples")

# 
# covs <- mines_cz %>%
#   select(cz_id, state, log_real_gdp_priv_ind_pc,
#          log_real_gdp_priv_ind,
#          log_real_Elem_Educ_Total_Exp_pp,
#          log_Enrollment, share_state,
#          log_weighted_annual_avg_wkly_wage,
#         #gr_weighted_annual_avg_wkly_wage,
#          #diff_log_real_gdp_priv_ind, diff_log_real_gdp_priv_ind_pc,
#         log_real_Property_Tax_pp) %>%
#   group_by(cz_id, state) %>%
#   summarise(across(everything(), ~mean(., na.rm = TRUE))) %>%
#   ungroup %>%
#   pivot_longer(!c(cz_id, state), names_to = 'covariate')
# 
# covs$state_name <- sapply(covs$state, get_state)
# 
# facet_labels <- c(
#   'log_real_gdp_priv_ind_pc' = "(log) Private Industry GDP per capita",
#   # 'diff_log_real_gdp_priv_ind_pc' = '(GR) Private Industry GDP per capita',
#   # 'diff_log_real_gdp_priv_ind' = '(GR) Private Industry GDP',
#   'log_real_gdp_priv_ind' = "(log) Private Industry GDP",
#   'log_weighted_annual_avg_wkly_wage' = '(log) Annual Avg Weekly Wage',
#   #'gr_weighted_annual_avg_wkly_wage' = '(GR) Annual Avg Weekly Wage',
#   'log_Enrollment' = '(log) Enrollment',
#   'share_state' = 'Share of Exp from State IG Transfers',
#   'log_real_Property_Tax_pp' = "(log) Property Taxes Collected per pupil"
# )


# covs %>%
#   # use ordering from coefficient estimate above
#   mutate(state_name = factor(state_name, levels = levels(results_df_cleaned$state_name))) %>%
#   ggplot(aes(x = state_name, y = value)) +
#   geom_violin(trim = FALSE, fill = "magenta", alpha = 0.2, color = NA) +
#   stat_summary(fun = median, geom = "point", position = position_dodge(width = 0.8),
#                shape = 21, size = 1.5, color = "black", fill = "magenta") +
#   facet_wrap(~covariate, ncol = 1, scales = "free", labeller = labeller(covariate = facet_labels)) +
#     theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
#   labs(title = "Value of Covariates in Order of State-level Coefficient Estimate",
#        subtitle = "Displays the distribution of various covariates by state.",
#        y = "Value",
#        x = "State (in order of coefficient estimate on wage level as in previous plot)")
# 
# # --- Collapse covariates to state level (mean across CZs) ---
# covs_state <- covs %>%
#   group_by(state_name, covariate) %>%
#   summarise(mean_value = mean(value, na.rm = TRUE), .groups = "drop") %>%
#   pivot_wider(names_from = covariate, values_from = mean_value)
# 
# # --- Extract state-level total_estimate from regression results ---
# estimates_state <- results_df_cleaned %>%
#   group_by(state_name) %>%
#   summarise(total_estimate = unique(total_estimate), .groups = "drop")
# 
# # --- Join estimates and covariates ---
# state_data <- left_join(estimates_state, covs_state, by = "state_name")
# 
# # --- Compute correlations (with total_estimate vs each covariate) ---
# corrs <- state_data %>%
#   select(-state_name) %>%
#   cor(use = "pairwise.complete.obs") %>%
#   as.data.frame() %>%
#   rownames_to_column("var")
# 
# # Filter correlations with total_estimate only
# corrs_total <- corrs %>%
#   filter(var != "total_estimate") %>%
#   select(var, total_estimate) %>%
#   arrange(desc(abs(total_estimate)))
# 
# # --- Plot correlation coefficients ---
# p_corr <- ggplot(corrs_total, aes(x = reorder(var, total_estimate), y = total_estimate)) +
#   geom_col(fill = "steelblue") +
#   geom_hline(yintercept = 0, linetype = "dashed") +
#   coord_flip() +
#   labs(
#     title = "Correlation of State-level Regression Estimates with Covariates",
#     x = "Covariate",
#     y = "Correlation with total_estimate"
#   ) +
#   theme_minimal()
# 
# print(p_corr)
# 
# # state_scatter <- state_data %>%
# #   pivot_longer(-c(state_name, total_estimate), names_to = "covariate", values_to = "value")
# # 
# # ggplot(state_scatter, aes(x = value, y = total_estimate, label = state_name)) +
# #   geom_point(color = "steelblue") +
# #   geom_smooth(method = "lm", se = FALSE, color = "black") +
# #   ggrepel::geom_text_repel(size = 3) +
# #   facet_wrap(~covariate, scales = "free_x") +
# #   labs(title = "State-level Scatterplots: Regression Estimates vs Covariates",
# #        x = "Covariate Value", y = "Total Estimate") +
# #   theme_minimal()
# 
# corr_state_cov <- covs %>%
#   left_join(results_df_cleaned %>% select(state_name, total_estimate), by = c("state_name")) %>%
#   group_by(state_name, covariate) %>%
#   summarise(r = cor(value, total_estimate, use = "pairwise.complete.obs"), .groups = "drop")
# 
# ggplot(corr_state_cov, aes(x = covariate, y = state_name, fill = r)) +
#   geom_tile() +
#   scale_fill_gradient2(limits = c(-1, 1)) +
#   labs(title = "Correlation Heatmap by State and Covariate",
#        x = "Covariate", y = "State", fill = "Correlation") +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

\FloatBarrier

We then proceed by instrumenting local wage levels with our wage- and real-value added based instruments by state. Again, the choice of instrument matters crucially. We see greatest consistency between the descriptive plot (Figure 18) and the wage-based instrument plot (Figure 20), whereas the GDP-based shift-share instrument (Figure 19) provides different wage elasticities, notably even in sign.

```{r, echo = FALSE, fig.height = 8, fig.width = 10, fig.cap = "State-by-State Wage Effect Using SS GDP Shock"}

state_mods_ss <- list()
for(k in reg_states){
  mod <- dat_temp %>%
    filter(state == k) %>%
    feols(as.formula(paste0(iv_lev_form, " | unit + year | log_weighted_annual_avg_wkly_wage ~ l(lev_gdp_ss_2d,1)")),
    data = ., panel.id = c("unit", "year"))
  state_mods_ss[[as.character(k)]] <- mod
}

# Define variable names of interest
vars_of_interest <- c("fit_log_weighted_annual_avg_wkly_wage")

# Apply to list of models
# Assuming: model_list is named by state names
results_df <- imap_dfr(state_mods_ss, extract_coef_info)
results_df$state_name <- sapply(results_df$state, get_state)

results_df_cleaned <- results_df %>%
  # Add lag labels
  mutate(label = case_when(
    variable == 'fit_log_weighted_annual_avg_wkly_wage' ~ 'HPI Effect'
  )) %>%
  #filter(significance != "") %>%
  # Compute total estimate and max R²
filter(r2_within > 0) %>%
  # Order `state` by R²
  mutate(state_name = fct_reorder(state_name, estimate, .desc = TRUE)) %>%
  # Reorder state_label using combined (state, lag_order)
  arrange(state_name) %>%
  mutate(state_label = factor(state_name, levels = unique(state_name)))

# Create axis labels: state names at 'l1' only, blanks otherwise
axis_labels <- levels(results_df_cleaned$state_label)

results_df_cleaned %>%
  # Plot
  ggplot(aes(x = state_label)) +
# Fill layer (with alpha by significance)
geom_point(
  aes(y = estimate, fill = r2_within, shape = significance),
   size = 4) +
geom_point(aes(y = estimate), shape = 21, size = 4, fill = NA, color = "black", stroke = 0.25, alpha = 1) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  common_theme +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 90, hjust = 1)
  ) +
  labs(
    title = "Effect of 1% Increase in Wage (using SS GDP Instrument) on Education Expenditure per Pupil",
    x = "States",
    y = "Coefficient Estimate",
    caption = "Effect of 1% increase in Wage using l1 of GDP SS Instrument on PP Education\n Expenditure controlling for enrollment, GDP, and intergovernmental transfers.\n Within R^2 of state-level estimation reflected in color of point).",
    color = "Within R2 of State-level Estimation",
    alpha = "Statistical Significance"
  ) +
    scale_x_discrete(labels = axis_labels)  +
  scale_fill_distiller(direction = 1) +
  scale_shape_manual(
  values = c(
    "***" = 21,
    "**"  = 22,
    "*"   = 23,
    "."   = 24#,
    #""    = 25  # non-significant
  )
)

# 
# covs <- mines_cz %>%
#   select(cz_id, state, log_real_gdp_priv_ind_pc,
#          log_real_gdp_priv_ind,
#          log_real_Elem_Educ_Total_Exp_pp,
#          log_Enrollment, share_state,
#          log_weighted_annual_avg_wkly_wage,
#         #gr_weighted_annual_avg_wkly_wage,
#          #diff_log_real_gdp_priv_ind, diff_log_real_gdp_priv_ind_pc,
#         log_real_Property_Tax_pp) %>%
#   group_by(cz_id, state) %>%
#   summarise(across(everything(), ~mean(., na.rm = TRUE))) %>%
#   ungroup %>%
#   pivot_longer(!c(cz_id, state), names_to = 'covariate')
# 
# covs$state_name <- sapply(covs$state, get_state)
# 
# facet_labels <- c(
#   'log_real_gdp_priv_ind_pc' = "(log) Private Industry GDP per capita",
#   # 'diff_log_real_gdp_priv_ind_pc' = '(GR) Private Industry GDP per capita',
#   # 'diff_log_real_gdp_priv_ind' = '(GR) Private Industry GDP',
#   'log_real_gdp_priv_ind' = "(log) Private Industry GDP",
#   'log_weighted_annual_avg_wkly_wage' = '(log) Annual Avg Weekly Wage',
#   #'gr_weighted_annual_avg_wkly_wage' = '(GR) Annual Avg Weekly Wage',
#   'log_Enrollment' = '(log) Enrollment',
#   'share_state' = 'Share of Exp from State IG Transfers',
#   'log_real_Property_Tax_pp' = "(log) Property Taxes Collected per pupil"
# )
# 
# 
# covs %>%
#   # use ordering from coefficient estimate above
#   mutate(state_name = factor(state_name, levels = levels(results_df_cleaned$state_name))) %>%
#   ggplot(aes(x = state_name, y = value)) +
#   geom_violin(trim = FALSE, fill = "magenta", alpha = 0.2, color = NA) +
#   stat_summary(fun = median, geom = "point", position = position_dodge(width = 0.8),
#                shape = 21, size = 1.5, color = "black", fill = "magenta") +
#   facet_wrap(~covariate, ncol = 1, scales = "free", labeller = labeller(covariate = facet_labels)) +
#     theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
#   labs(title = "Value of Covariates in Order of State-level Coefficient Estimate",
#        subtitle = "Displays the distribution of various covariates by state.",
#        y = "Value",
#        x = "State (in order of coefficient estimate on wage level as in previous plot)")


```

```{r, echo = FALSE, fig.height = 8, fig.width = 10, fig.cap = "State-by-State Wage Effect Using SS Wage Shock"}

state_mods_ss <- list()
for(k in reg_states){
  mod <- dat_temp %>%
    filter(state == k) %>%
    feols(as.formula(paste0(iv_lev_form, " | unit + year | log_weighted_annual_avg_wkly_wage ~ l(lev_ss_2d,1)")),
    data = ., panel.id = c("unit", "year"))
  state_mods_ss[[as.character(k)]] <- mod
}

# Define variable names of interest
vars_of_interest <- c("fit_log_weighted_annual_avg_wkly_wage")

# Apply to list of models
# Assuming: model_list is named by state names
results_df <- imap_dfr(state_mods_ss, extract_coef_info)
results_df$state_name <- sapply(results_df$state, get_state)

results_df_cleaned <- results_df %>%
  # Add lag labels
  mutate(label = case_when(
    variable == 'fit_log_weighted_annual_avg_wkly_wage' ~ 'HPI Effect'
  )) %>%
  #filter(significance != "") %>%
  # Compute total estimate and max R²
filter(r2_within > 0) %>%
  # Order `state` by R²
  mutate(state_name = fct_reorder(state_name, estimate, .desc = TRUE)) %>%
  # Reorder state_label using combined (state, lag_order)
  arrange(state_name) %>%
  mutate(state_label = factor(state_name, levels = unique(state_name)))

# Create axis labels: state names at 'l1' only, blanks otherwise
axis_labels <- levels(results_df_cleaned$state_label)

results_df_cleaned %>%
  # Plot
  ggplot(aes(x = state_label)) +
# Fill layer (with alpha by significance)
geom_point(
  aes(y = estimate, fill = r2_within, shape = significance),
   size = 4) +
geom_point(aes(y = estimate), shape = 21, size = 4, fill = NA, color = "black", stroke = 0.25, alpha = 1) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  common_theme +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 90, hjust = 1)
  ) +
  labs(
    title = "Effect of 1% Increase in Wage (using SS Wage Instrument) on Education Expenditure per Pupil",
    x = "States",
    y = "Coefficient Estimate",
    caption = "Effect of 1% increase in Wage using l1 of Wage SS Instrument on PP Education\n Expenditure controlling for enrollment, GDP, and intergovernmental transfers.\n Within R^2 of state-level estimation reflected in color of point).",
    color = "Within R2 of State-level Estimation",
    alpha = "Statistical Significance"
  ) +
    scale_x_discrete(labels = axis_labels)  +
  scale_fill_distiller(direction = 1, palette = "Oranges") +
  scale_shape_manual(
  values = c(
    "***" = 21,
    "**"  = 22,
    "*"   = 23,
    "."   = 24#,
    #""    = 25  # non-significant
  )
)
# 
# 
# covs <- mines_cz %>%
#   select(cz_id, state, log_real_gdp_priv_ind_pc,
#          log_real_gdp_priv_ind,
#          log_real_Elem_Educ_Total_Exp_pp,
#          log_Enrollment, share_state,
#          log_weighted_annual_avg_wkly_wage,
#         #gr_weighted_annual_avg_wkly_wage,
#          #diff_log_real_gdp_priv_ind, diff_log_real_gdp_priv_ind_pc,
#         log_real_Property_Tax_pp) %>%
#   group_by(cz_id, state) %>%
#   summarise(across(everything(), ~mean(., na.rm = TRUE))) %>%
#   ungroup %>%
#   pivot_longer(!c(cz_id, state), names_to = 'covariate')
# 
# covs$state_name <- sapply(covs$state, get_state)
# 
# facet_labels <- c(
#   'log_real_gdp_priv_ind_pc' = "(log) Private Industry GDP per capita",
#   # 'diff_log_real_gdp_priv_ind_pc' = '(GR) Private Industry GDP per capita',
#   # 'diff_log_real_gdp_priv_ind' = '(GR) Private Industry GDP',
#   'log_real_gdp_priv_ind' = "(log) Private Industry GDP",
#   'log_weighted_annual_avg_wkly_wage' = '(log) Annual Avg Weekly Wage',
#   #'gr_weighted_annual_avg_wkly_wage' = '(GR) Annual Avg Weekly Wage',
#   'log_Enrollment' = '(log) Enrollment',
#   'share_state' = 'Share of Exp from State IG Transfers',
#   'log_real_Property_Tax_pp' = "(log) Property Taxes Collected per pupil"
# )
# 
# 
# covs %>%
#   # use ordering from coefficient estimate above
#   mutate(state_name = factor(state_name, levels = levels(results_df_cleaned$state_name))) %>%
#   ggplot(aes(x = state_name, y = value)) +
#   geom_violin(trim = FALSE, fill = "magenta", alpha = 0.2, color = NA) +
#   stat_summary(fun = median, geom = "point", position = position_dodge(width = 0.8),
#                shape = 21, size = 1.5, color = "black", fill = "magenta") +
#   facet_wrap(~covariate, ncol = 1, scales = "free", labeller = labeller(covariate = facet_labels)) +
#     theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
#   labs(title = "Value of Covariates in Order of State-level Coefficient Estimate",
#        subtitle = "Displays the distribution of various covariates by state.",
#        y = "Value",
#        x = "State (in order of coefficient estimate on wage level as in previous plot)")


```


\FloatBarrier



```{r, echo = FALSE, include = FALSE, eval = FALSE, results = 'asis'}

# compute_ss takes the source data "QCEW" or "QWI", a base year for the Bartik, whether to compute at CZ or fips level. This si then passed to plot_ss() which returns the instrumetn for a specific industry code and a plot.
if(new_ss_calculation){
  ss_temp_old <- compute_ss_old(source = "QCEW", base_year = 2004, unit_id = "cz_id")
  saveRDS(ss_temp_old, here("code/ss_cache_manual/ss_temp_old.RDS"))
}else{
  ss_temp_old <- readRDS(here("code/ss_cache_manual/ss_temp_old.RDS"))
}


# ind_codes %>% filter(nchar(industry_code) == 2 & industry_code != 99)  %>% select(-keep, -industry_code) %>% xtable() %>% print(include.rownames = FALSE)

ind_mods <- list()
inds <- ind_codes %>% filter(nchar(industry_code) == 2 & !(industry_code %in% c(10, 99))) %>% pull(industry_code) %>% unique
i <- 0
for(k in inds){
    print(k)
    ss_inst <- ss_temp_old %>%
      plot_ss_old(., k, "gr_natl_annual_avg_wkly_wage_", "cz_id", ind_codes)
    name <- ind_codes %>% filter(industry_code == k) %>% pull(industry_title)

    mods <- list()
    for(df in names(dfs)){
      print(df)
      # IV regression using shift-share instrument
      temp_dat <- left_join(dfs[[df]], rename(ss_inst, unit = cz_id), by = c("year", "unit"))
      stopifnot(temp_dat %>% group_by(cz_id, year) %>% n_groups == nrow(temp_dat))
      iv_model <- feols(
        as.formula(paste0("log_real_Elem_Educ_Total_Exp_pp ~ log_real_Total_IG_Revenue_pp + log_real_gdp_priv_ind_pc + log_Enrollment + l1_log_real_Elem_Educ_Total_Exp_pp | state + year | log_weighted_annual_avg_wkly_wage ~ l(ss_", k, ",1)")),
        data = temp_dat, panel.id = c("unit", "year")
      )
      mods[[df]] <- iv_model
    }
    ind_mods[[as.character(k)]] <- mods
}

for(k in names(ind_mods)){
  etable(ind_mods[[k]], title = k, tex = latex_tables, headers = names(ind_mods[[k]]),  adjustbox = TRUE) %>% print()
}

# Filter the list of models for significant log_real_gdp_priv_ind_pc coefficients
significant_mods <- mods[sapply(mods, function(m) {
  coefs <- summary(m)$coeftable
  if ("fit_log_weighted_annual_avg_wkly_wage" %in% rownames(coefs)) {
    return(coefs["fit_log_weighted_annual_avg_wkly_wage", "Pr(>|t|)"] < 0.05)}
  } else {
    return(FALSE)
  }
})]

```

## Additional Analysis

### Quantile Regression

```{r, echo = FALSE, cache = TRUE, fig.height = 8, fig.width = 10, fig.cap = "Quantile Regression"}

# Step 1: Remove fixed effects (Canay 2-step)
fe_model <- feols(log_real_Elem_Educ_Total_Exp_pp ~
                    log_weighted_annual_avg_wkly_wage +
                                      l1_log_weighted_annual_avg_wkly_wage +
                                      l2_log_weighted_annual_avg_wkly_wage +
                                      log_real_Total_IG_Revenue_pp +
                                      log_real_gdp_priv_ind_pc +
                                      log_Enrollment | unit + year, data = dat_temp) %>%
  tidy(.) %>%
  mutate(model = "OLS",
         tau = "1")

# Step 3: Run quantile regression on residuals at multiple quantiles
taus <- c(0.1, 0.25, 0.5, 0.75, 0.9)
qr_models <- map(taus, ~ rq(log_real_Elem_Educ_Total_Exp_pp ~ log_weighted_annual_avg_wkly_wage +
                                      l1_log_weighted_annual_avg_wkly_wage +
                                      l2_log_weighted_annual_avg_wkly_wage +
                                      log_real_Total_IG_Revenue_pp +
                                      log_real_gdp_priv_ind_pc +
                                      log_Enrollment,
                            data = dat_temp, tau = .x))

# Step 4: Tidy results and add quantile info
qr_tidy <- map2_dfr(qr_models, taus, ~ tidy(.x) %>% mutate(tau = as.character(.y), model = "quantile"))

term_levels <- c("(Intercept)", "L0 Wage", "L1 Wage", "L2 Wage",
                 "Enrollment", "IG Rev pp", "Ind. GDP pc")

# Step 5: Add significance stars and reshape
qr_tidy <- qr_tidy %>%
  rbind(fe_model) %>%
  mutate(
    p.value = 2 * (1 - pnorm(abs(statistic))),
    sig = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      p.value < 0.1   ~ ".",
      TRUE ~ ""
    ),
    # Relabel variables for readability
    term = recode(term,
      "l1_log_real_Elem_Educ_Total_Exp_pp" = "AR(1)",
      "log_real_Total_IG_Revenue_pp" = "IG Rev pp",
      "log_real_gdp_priv_ind_pc" = "Ind. GDP pc",
      "log_Enrollment" = "Enrollment",
      "log_weighted_annual_avg_wkly_wage" = "L0 Wage",
      "l1_log_weighted_annual_avg_wkly_wage" = "L1 Wage",
      "l2_log_weighted_annual_avg_wkly_wage" = "L2 Wage"
    ),
    term = factor(term, levels = term_levels),
    xpos = as.numeric(term),

    # Combine shape and color label
    model_label = case_when(
      model == "OLS" ~ "OLS",
      TRUE ~ paste0("Quantile τ = ", tau)
    )
  )

# Plot with unified legend and updated shape mapping
qr_tidy %>%
  ggplot(aes(x = xpos, y = estimate, color = model_label, shape = model_label, alpha = sig)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbar(
    aes(ymin = estimate - 1.96 * std.error,
        ymax = estimate + 1.96 * std.error),
    height = 0.2,
    position = position_dodge(width = 0.6)
  ) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_minimal() +
  labs(
    title = "Coefficient Estimates from OLS and Quantile Regressions",
    x = "Estimate",
    y = NULL,
    color = "Model Type",
    shape = "Model Type"
  ) +
  theme(
    legend.position = "right",
    panel.grid.minor.y = element_blank(),
    panel.grid.major.y = element_line(linetype = "dashed"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_line(color = "slategrey")
  ) +
  scale_shape_manual(values = c(
    "OLS" = 17,  # triangle
    "Quantile τ = 0.1" = 16,
    "Quantile τ = 0.25" = 16,
    "Quantile τ = 0.5" = 16,
    "Quantile τ = 0.75" = 16,
    "Quantile τ = 0.9" = 16
  )) +
  scale_x_continuous(
    breaks = 1:length(term_levels),
    labels = term_levels
  )


```


### High-income Outliers

\textcolor{violet}{This will likely be moved to the Appendix.}

There is a somewhat non-linear
relationship between property taxes and elementary expenditure as
property taxes collected rise as represented in Figure 22 below. This happens largely as a result of very
high-income commuting zones. Therefore, we exclude any commuting zone
that spends more than 22k per pupil to avoid any distorting effects.
This removes 12 CZs (\~2% of the sample).
\textcolor{red}{This could benefit from
more robust outlier detection.}


To assess whether the main results are driven by a small number of very high-income jurisdictions, I re-estimate the baseline and IV specifications excluding such outliers. The findings are fully consistent with the baseline analysis: house prices remain a strong predictor of local education spending, and the IV estimates continue to imply that a 10% increase in house prices raises per-pupil expenditure by roughly 4–6%. The wage-based shift-share instrument yields somewhat larger point estimates, though with wider standard errors, while the GDP-based instrument produces effects in line with earlier results. Overall, this robustness exercise confirms that the causal relationship between housing wealth and education spending is not confined to affluent areas but reflects a broader, generalizable pattern. These findings confirm that the main result is not driven solely by affluent jurisdictions, but reflects a more general relationship between local housing wealth and education spending.

```{r outliers, echo = FALSE, cache = TRUE, results = 'asis', fig.cap = "Scatterplot of Education Expenditure and Property Taxes by Funding Regime"}

mines_no_outliers <- mines_cz %>%
  group_by(unit) %>%
  filter(!any(log_real_Elem_Educ_Total_Exp_pp > 10)) %>%
  ungroup

mines_cz %>%
  ggplot(aes(x = log_real_Elem_Educ_Total_Exp_pp, y = log_real_Property_Tax_pp, colour = share_own_discrete)) +
  geom_jitter() +
    #geom_smooth(method=lm, colour = "black", linetype = "dashed") +
  labs(title = "Elem Education Expenditure pp vs Property Tax pp") +
  geom_vline(xintercept = 10, linetype = 'dashed') +
  theme_bw() +
  theme(title = element_text(size = 9)) +
  labs(colour = "Reliance on Local Sources")

forms <- list(paste0(baseline_sw_short, " | unit + year"), paste0(iv_lev_form, " | year + state | log_weighted_annual_avg_wkly_wage ~ l(lev_ss_2d)"),
paste0(iv_lev_form, " | year + state | log_weighted_annual_avg_wkly_wage ~ l(lev_gdp_ss_2d)"))


baseline <- feols(as.formula(forms[[1]]), data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"), cluster = "unit")
wage_ss <- feols(as.formula(forms[[2]]), data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))
gdp_ss <- feols(as.formula(forms[[3]]), data = left_join(mines_cz, rename(ss_temp, unit = cz_id), by = c("year","unit")), panel.id = c("unit", "year"))

etable(list(baseline, wage_ss, gdp_ss), fitstat = iv_fitstats, headers = c("Baseline 1", "Baseline 2", "Baseline 3", "Wage-based SS", "GDP-based SS"), adjustbox = TRUE, tex = latex_tables, title = "Outlier Trimming Results")


```

\FloatBarrier
```{r appendix_pvar, include = FALSE, echo = FALSE, results = 'asis'}
panel_lines <- c(
  "$$",
  "Y_{it} = \\alpha_i +  \\sum_{k = 1}^{4} \\gamma_{k}A_{i,t-k} + \\beta X_{it} + \\varepsilon_{it}",
  "$$",
  "",
  "Where we approach a level and per capita value expression of the",
  "relationship between total education expenditure, intergovernmental",
  "revenue, house prices conditioned on GDP and wage levels.",
  "",
  "$$",
  "Y_{it} =",
  "\\begin{bmatrix}",
  "\\log(\\text{real Total Educ. Exp.})_{it} \\\\",
  "\\log(\\text{real Total IG Revenue})_{it} \\\\",
  "\\log(\\text{HPI})_{it}",
  "\\end{bmatrix},",
  "\\quad",
  "X_{it} =",
  "\\begin{bmatrix}",
  "\\log(\\text{real GDP})_{it} \\\\",
  "\\log(\\text{wage})_{it}",
  "\\end{bmatrix}",
  "$$",
  "",
  "- $A_1, A_2, A_3, A_4$ are $3 \\times 3$ coefficient matrices",
  "- $\\beta$ is a $3 \\times 2$ matrix of coefficients on the exogenous variables",
  "- $\\alpha_i$ is a vector of unit fixed effects",
  "- $\\varepsilon_{it}$ is the error term",
  "",
  "Where",
  "",
  "$$",
  "Y_{it} =",
  "\\begin{bmatrix}",
  "\\log(\\text{real Own Source Rev. per person})_{it} \\\\",
  "\\log(\\text{real IG Revenue per person})_{it} \\\\",
  "\\log(\\text{wage})_{it} \\\\",
  "\\log(\\text{HPI})_{it}",
  "\\end{bmatrix},",
  "\\quad",
  "X_{it} =",
  "\\begin{bmatrix}",
  "\\log(\\text{real GDP per capita})_{it}",
  "\\end{bmatrix}",
  "$$",
  "",
  "- $A_1, A_2, A_3, A_4$ are $4 \\times 4$ coefficient matrices",
  "- $B$ is a $4 \\times 1$ coefficient matrix",
  "- $\\alpha_i$ unit fixed effects",
  "- $\\varepsilon_{it}$ error term"
)

append_to_appendix("## Panel VAR Specification", panel_lines)


pvar_data <- mines_cz %>%
  #select(unit, year, contains("real_Total_Educ_Total_Exp"), contains("real_gdp_total")) %>%
  drop_na() %>%
  data.frame()

# Estimate PVAR with 1 lag
pvar_model_levels <- pvarfeols(
  dependent_vars = c("log_real_Total_Educ_Total_Exp",
                     #"log_real_Total_Rev_Own_Sources",
                     #"log_real_gdp_priv_ind",
                     #"log_real_Property_Tax",
                     "log_real_Total_IG_Revenue", #"log_real_Total_Fed_IG_Revenue_pp",
                     #"log_weighted_annual_avg_wkly_wage",
                     "log_hpi"),
  exog_vars = c("log_real_gdp_priv_ind", "log_weighted_annual_avg_wkly_wage"), #"share_own",
  lags = 4,
  #transformation = "demean",   # alternative: "firstdiff"
  data = pvar_data,
  panel_identifier = c("unit", "year")
)

pvar_model_levels_pc <- pvarfeols(
  dependent_vars = c(#"log_real_Total_Educ_Total_Exp_pp", #"log_real_gdp_priv_ind_pc",
                     "log_real_Total_Rev_Own_Sources_pp",
                     #"log_real_Property_Tax_pp",
                     "log_real_Total_IG_Revenue_pp",
                     "log_weighted_annual_avg_wkly_wage", #"log_real_Total_State_IG_Revenue_pp", "log_real_Total_Fed_IG_Revenue_pp",
                     "log_hpi"),
  exog_vars = c("log_real_gdp_priv_ind_pc"), #"share_own",
  lags = 4,
  #transformation = "demean",   # alternative: "firstdiff"
  data = pvar_data,
  panel_identifier = c("unit", "year")
)

for(mod in list(pvar_model_levels, pvar_model_levels_pc)){
  #summary(mod) %>% print

  # Impulse response function
  irf_result <- mod %>% girf(n.ahead = 10, ma_approx_steps= 10)

  # irf_result_bootstrapped <- bootstrap_irf(mod, typeof_irf = c("GIRF"),
  #           n.ahead = 10,
  #           nof_Nstar_draws = 3,
  #           confidence.band = 0.95,
  #           mc.cores = 5)
  # Plot IRFs
  plot(irf_result, scales = "free") %>% print()
  cat("    \n")
  cat("    \n")
  cat("    \n")
  cat("    \n")
}


# # Get shock variables (names of shock sources)
# shock_vars <- names(irf_result)
# irf_df <- map_dfr(shock_vars, function(shock) {
#   lower_matrix <- irf_result_bootstrapped$Lower[[shock]]
#   upper_matrix <- irf_result_bootstrapped$Upper[[shock]]
#
#   # Calculate mean pointwise IRF from bootstrap draws
#   mean_matrix <- (lower_matrix + upper_matrix) / 2
#
#   expand.grid(
#     horizon = seq_len(nrow(mean_matrix)),
#     response = colnames(mean_matrix)
#   ) %>%
#     mutate(
#       shock = shock,
#       irf = as.vector(mean_matrix),
#       lower = as.vector(lower_matrix),
#       upper = as.vector(upper_matrix)
#     )
# })
# ggplot(irf_df, aes(x = horizon, y = irf)) +
#   geom_line(color = "steelblue") +
#   geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, fill = "steelblue") +
#   facet_grid(response ~ shock, scales = "free_y") +
#   labs(
#     title = "Impulse Response Functions with 95% Confidence Intervals",
#     x = "Horizon",
#     y = "Response"
#   ) +
#   theme_minimal()

```

<!-- # Property Prices -->

<!-- ```{r, echo = FALSE, results = 'asis', cache = TRUE} -->

<!-- # is <- isatpanel( -->
<!-- #       data = data.frame(mines_cz), -->
<!-- #       formula = as.formula("log_hpi ~ log_weighted_annual_avg_wkly_wage + l1_log_weighted_annual_avg_wkly_wage + l2_log_weighted_annual_avg_wkly_wage"), -->
<!-- #       index = c("unit", "year"), -->
<!-- #       effect = "twoways", -->
<!-- #       #iis = TRUE, -->
<!-- #       fesis = TRUE, -->
<!-- #       #ar = 1, -->
<!-- #       t.pval = 0.01, -->
<!-- #       max.block.size = 5 -->
<!-- #     ) -->

<!-- fun_list <- c(log_hpi ~ log_weighted_annual_avg_wkly_wage + l1_log_weighted_annual_avg_wkly_wage + l2_log_weighted_annual_avg_wkly_wage + log_real_gdp_priv_ind | unit + year, -->

<!-- gr_hpi ~ gr_weighted_annual_avg_wkly_wage + l1_gr_weighted_annual_avg_wkly_wage + l2_gr_weighted_annual_avg_wkly_wage | unit + year, -->

<!-- log_real_Elem_Educ_Total_Exp ~ log_weighted_annual_avg_wkly_wage + l1_log_weighted_annual_avg_wkly_wage + l2_log_weighted_annual_avg_wkly_wage + log_real_gdp_priv_ind + l1_log_real_gdp_priv_ind + l2_log_real_gdp_priv_ind | unit + year, -->

<!-- diff_log_real_Elem_Educ_Total_Exp ~ gr_weighted_annual_avg_wkly_wage + l1_gr_weighted_annual_avg_wkly_wage + l2_gr_weighted_annual_avg_wkly_wage + diff_log_real_gdp_priv_ind + l1_diff_log_real_gdp_priv_ind + l2_diff_log_real_gdp_priv_ind | unit + year, -->

<!-- log_real_Elem_Educ_Total_Exp_pp ~ log_weighted_annual_avg_wkly_wage + l1_log_weighted_annual_avg_wkly_wage + l2_log_weighted_annual_avg_wkly_wage + log_real_gdp_priv_ind_pc + l1_log_real_gdp_priv_ind_pc + l2_log_real_gdp_priv_ind_pc | unit + year, -->

<!-- diff_log_real_Elem_Educ_Total_Exp_pp ~ gr_weighted_annual_avg_wkly_wage + l1_gr_weighted_annual_avg_wkly_wage + l2_gr_weighted_annual_avg_wkly_wage + diff_log_real_gdp_priv_ind_pc + l1_diff_log_real_gdp_priv_ind_pc + l2_diff_log_real_gdp_priv_ind_pc | unit + year) -->

<!-- run_model(fun_list, mines_no_outliers) %>% etable(tex = latex_tables, adjustbox = TRUE) -->

<!-- ``` -->

<!-- ```{r, echo = FALSE, results = 'asis', cache = TRUE} -->
<!-- # General-to-Specific model selection using fixest -->
<!-- gets_fixest <- function(dep_var, indep_vars, data, fe = NULL, pval_cutoff = 0.1) { -->
<!--   remaining_vars <- indep_vars -->

<!--   repeat { -->
<!--     # Build formula -->
<!--     rhs <- paste(remaining_vars, collapse = " + ") -->
<!--     formula_str <- as.formula(paste(dep_var, "~", rhs, if (!is.null(fe)) paste("|", fe) else "")) -->

<!--     # Estimate model -->
<!--     model <- feols(formula_str, data = data) -->
<!--     coefs <- summary(model)$coeftable -->

<!--     # Filter out only the coefficients from the explanatory variables -->
<!--     pvals <- coefs[, "Pr(>|t|)"] -->
<!--     pvals <- pvals[names(pvals) %in% remaining_vars] -->

<!--     # Stop if all variables are below the cutoff or no variables remain -->
<!--     if (length(pvals) == 0 || all(pvals < pval_cutoff)) break -->

<!--     # Remove the variable with the highest p-value -->
<!--     worst_var <- names(which.max(pvals)) -->
<!--     remaining_vars <- setdiff(remaining_vars, worst_var) -->
<!--   } -->

<!--   # Return the final reduced model -->
<!--   final_formula <- paste(dep_var, "~", paste(remaining_vars, collapse = " + "), if (!is.null(fe)) paste("|", fe) else "") -->
<!--   return(final_formula) -->
<!-- } -->

<!-- # Example usage -->
<!-- # Replace 'your_data' with your actual data frame name -->
<!-- final_model <- gets_fixest( -->
<!--   dep_var = "log_real_Elem_Educ_Total_Exp_pp", -->
<!--   indep_vars = c("log_weighted_annual_avg_wkly_wage", -->
<!--                  "l1_log_weighted_annual_avg_wkly_wage", -->
<!--                  "l2_log_weighted_annual_avg_wkly_wage", -->
<!--                  "log_real_gdp_priv_ind_pc", -->
<!--                  "l1_log_real_gdp_priv_ind_pc", -->
<!--                  "l2_log_real_gdp_priv_ind_pc", -->
<!--                  "log_real_Property_Tax_pp", -->
<!--                  #"log_real_Total_State_IG_Revenue_pp", -->
<!--                  #"log_real_Total_Fed_IG_Revenue_pp", -->
<!--                  "log_hpi"),  # replace with your actual variable names -->
<!--   data = mines_cz, -->
<!--   fe = "unit + year",        # optional fixed effects -->
<!--   pval_cutoff = 0.1         # significance threshold -->
<!-- ) -->

<!-- # View results -->
<!-- # At a 10% significance level, we retain a 2-timeperiod lag of real_gdp_pc, contemporaneous wage (not likely), property_tax_pp, state_revenue_pp, hpi -->
<!-- feols(as.formula(final_model), data = mines_cz) %>% etable(adjustbox = TRUE, tex = latex_tables) -->


<!-- # I want to allow the coefficient to vary on the weekly wage treatment variable -->
<!-- feols(as.formula(gsub("log_weighted_annual_avg_wkly_wage", "i(share_own_discrete, log_weighted_annual_avg_wkly_wage)", final_model)), data = mines_cz) %>% -->
<!--   etable(adjustbox = TRUE, tex = latex_tables) -->

<!-- ``` -->

<!-- ```{r, cache = TRUE} -->

<!-- test <- readRDS(here("output/prop_price_breaks_csis.RDS")) -->

<!-- ``` -->

### Property Prices as Endogenous Regressor

\textcolor{violet}{Until a few weeks ago, I was using the following identification strategy which produced perhaps more interesting results (in terms of instrument relevance and statistically significant results. However, it did not answer our fundamental research question of the relationship between local economic performance and education expenditure. They provide evidence of a causal relationship between property values and public education expenditure using the same shift-share instruments as above. I include the results of this work at the end of the document, for reference. In case there is something useful there for the narrative.}


```{r, child = "regressions_prop_prices.qmd"}


```


# Results{#sec-results}

...

# Discussion{#sec-discussion}

...

# Conclusion{#sec-conclusion}

\textcolor{violet}{While results are in flux, I am collecting statements I want to make in the conclusion.}

The determinants of inequality in public education delivery in the US
are multiple and complex. Significant evidence exists of the role of
historically discriminatory policies related to congressional
districting, under-investment in low-income areas of color. Though this
work does not directly inform this debate, further work could explore
the extent to which wage growth interacts with such structural policies.

# Data and Code Availability

\textcolor{red}{Code and data to reproduce the analysis will be made available on Github or Zenodo.}


# Use of AI

- Used ChatGPT to help improve readability of plots (formatting, margins, labeling).
- Used ChatGPT to debug errors in R during data cleaning and plotting.
- Used ChatGPT to provide suggestions for reducing run time of repetitive tasks (ex. downloading and processing multiple data files).


# Acknowledgements

```{r, child = "appendix_generated.qmd"}


```

