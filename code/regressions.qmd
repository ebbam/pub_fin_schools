---
title: "Descriptive Analysis & Preliminary Results"
format: 
  html:
    embed-resources: true
    theme: cosmo
    toc: true
    toc_float: true
    toc-expand: 3
    toc-depth: 4
    toc-location: left
---

# Introduction

The following document summarises the progress made thus far on Chapter 1: Local Fiscal Risks of Decarbonisation of my DPhil. The work aims to pursue a better understanding of how industrial transformation impacts local well-being. From an original interest in looking at all aspects of local public finance, the project has narrowed to focus on expenditure on public education and its connection to industrial prosperity and transformation. 

Below, I provide some descriptive statistics and figures about the data, some preliminary regression tests of the significance of various GDP control variables, and some regression results using a standard TWFE model (with and without state-level trends) and coal mining activity as instruments for property taxes and GDP. 

*The main research question is: How does industrial transformation/activity impact county-level expenditure on public education?*

**Conclusion: I do not yet feel confident in any of the results below but hopefully these steps can help orient the next phase of analysis (ideally moving on to consider oil and gas industry treatment variables as well or treatments that proxy "industrial transformation" in a more general sense).**

```{r, echo = FALSE, message = FALSE}
rm(list = ls())
library(tidyverse)
library(conflicted)
library(stargazer)
library(zoo)
library(tidycensus)
library(here)
library(viridis)
library(datasets)
library(broom)
library(fixest)
library(readxl)
library(ggrepel)
library(plm)
library(getspanel)
library(usmap)
library(gridExtra)
library(kableExtra)
library(lattice)
library(lubridate)
library(stringr)
library(xts)
library(urca)
library(dynlm)
library(tseries)
library(quantmod)
library(lmtest)
library(sandwich)
library(vars)
library(ggridges)
library(grid)
library(ggplotify)
source(here('code/source_code/useful_functions.R'))
source(here('code/source_code/dicts.R'))

conflict_prefer_all("dplyr", quiet = TRUE)

```

```{r, echo = FALSE}
# MOVE TO CLEANING SCRIPT

# Of all variables available in the school district dataset, select below which to retain (commenting out irrelevant ones)
# Saves compile time later
rel_vars <- c("fips", 
              "state",
              "year", 
              "esa", 
              "voc_adult", 
              "Enrollment", 
              "Total_Revenue", 
              "Total_Rev_Own_Sources", 
              #"General_Revenue"
              #"Gen_Rev_Own_Sources"
              "Total_Taxes",             
              "Property_Tax",         
              "Total_IG_Revenue",     
              "Total_Fed_IG_Revenue",     
              #"Fed_IGR_Education",        
              "Total_State_IG_Revenue",    
              #"State_IGR_Education",       
              "Tot_Local_IG_Rev",
              #"Local_IGR_InterSchool_Aid" ,   
              #"Local_IGR_Other_Education",
              #"Tot_Chgs_and_Misc_Rev",
              #"Total_General_Charges",
              #"Chg_Total_Education",
              #"Chg_Total_Elem_Education",
              #"Chg_Elem_Ed_Sch_Lunch",
              #"Chg_Elem_Ed_Tuition",
              #"Chg_Elem_Ed_NEC",
              #"Misc_General_Revenue",
              #"Interest_Revenue",
              #"Misc_General_Rev_NEC",
              # "Total_Expenditure",
              # "Total_IG_Expenditure",
              # "Direct_Expenditure" ,
              # "Total_Current_Expend",
              # "Total_Current_Oper",
              # "Total_Capital_Outlays",
              # "Total_Construction",
              # "Total_Other_Capital_Outlays",
              # "Total_Interest_on_Debt",
              # "Total_Salaries___Wages",
              # "General_Expenditure",
              # "Direct_General_Expend",
              # "General_Current_Expend",
              # "General_Current_Oper",
              # "General_Capital_Outlay",
              # "General_Construction",
              # "General_Capital_Outlay_Other",
              # "General_Debt_Interest",
              "Total_Educ_Total_Exp",
              #"Total_Educ_Direct_Exp",
              #"Total_Educ_Cap_Outlay",
              #"Total_Educ_Current_Exp",
              #"Total_Educ_Construct",
              "Elem_Educ_Total_Exp",
              #"Elem_Educ_Direct_Exp",
              #"Elem_Educ_Cap_Outlay",
              #"Elem_Educ_Current_Exp",
              #"Elem_Educ_Construction",
              #"Elem_Educ_IG_Sch_to_Sch",
              #"Interest_on_Gen_Debt",
              #"Total_Debt_Outstanding",
              #"Total_Long_Term_Debt_Out",
              #"Total_Beg_LTD_Out",
              #"Beg_LTD_Out_All_Other",
              #"Total_LTD_Retired",
              #"LTD_Ret_All_Other",
              #"Total_LTD_Out",
              #"LTD_Out_All_Other",
              #"Total_Cash___Securities",
              #"Nonin_Trust_Cash___Sec",
              #"Sinking_Fd_Cash___Sec",
              #"Bond_Fd_Cash___Sec",
              #"Oth_Nonin_Fd_Cash___Sec",
              "esa_rev",
              "esa_tot_exp",
              "voc_adult_tot_rev",
              "voc_adult_tot_exp",
              "pop_total",
              "pop_school_age")  

df_all <- readRDS(here("data/out/school_exp_county.RDS")) %>% 
  select(-contains("log")) %>% 
  select(contains(rel_vars))

```


```{r, echo = FALSE}

# MOVE TO CLEANING SCRIPT

#Note: GDP controls and economic diversity indicators from the original #"main_county/pub_fin/data/temp" and cleaned from Willamette_Scoping.Rmd.
gdp <- readRDS(here("data/temp/gdp_controls.RDS")) %>% 
  mutate(across(contains("mining"), ~ifelse(is.na(.), 0, .)))

deflators <- gdp %>% 
  filter(fips %in% unique(df_all$fips)) %>% 
  select(year, fips, real_gdp_total, gdp_total) %>% 
  group_by(year) %>% 
  summarise(nom_gdp = sum(gdp_total, na.rm = TRUE),
            real_gdp = sum(real_gdp_total, na.rm = TRUE)) %>% 
  mutate(defl = nom_gdp/real_gdp) %>% 
  dplyr::select(-c(nom_gdp, real_gdp))

# Does not yet include population controls from 1997-1990
df_cleaned <- df_all %>% 
  left_join(deflators, by = "year") %>% 
  # Convert to real dollars
  mutate(across(!c(fips, state, year, Enrollment, esa, voc_adult, pop_total, pop_school_age), ~./defl, .names = "real_{.col}")) %>% 
  complete(fips, year) %>% 
  # Exclude CT for now because of the redistricting/county reorganisation in 2017 (see master_cleaning for preliminary work on this)
  filter(!(substr(fips, 1,2) %in% c("09"))) %>% 
  # remove any counties that have reported 0-value property taxes in more than 5 years (30 counties are removed from total sample)
  group_by(fips) %>%
  filter(sum(Property_Tax == 0) < 5) %>% 
  ungroup %>% 
  # Logs of all relevant variables
  mutate(across(!c(fips, state, year, esa, voc_adult), ~log((.*1000) + 1), .names = "log_{.col}")) %>% 
  group_by(fips) %>% 
  # first-difference of all variable
  mutate(across(!c(state, year, esa, voc_adult),  ~. - dplyr::lag(., 1), .names = "diff_{.col}"),
        across(!c(state, year, esa, voc_adult), list(l1 = ~dplyr::lag(., 1), l2 = ~dplyr::lag(., 2)), .names = "{.fn}_{.col}"),
        share_fed = sum(Total_Fed_IG_Revenue, na.rm = TRUE)/sum(Elem_Educ_Total_Exp),
        share_state = sum(Total_State_IG_Revenue, na.rm = TRUE)/sum(Elem_Educ_Total_Exp),
        share_local_ig = sum(Tot_Local_IG_Rev, na.rm = TRUE)/sum(Elem_Educ_Total_Exp),
        share_own = sum(Total_Rev_Own_Sources, na.rm = TRUE)/sum(Elem_Educ_Total_Exp),
        share_own_discrete = case_when(share_own > 0.5 ~ "1 = high",
                                        share_own < 0.25 ~ "3 = low",
                                        TRUE ~ "2 = medium")) %>% 
  ungroup %>% 
  filter(year >= 2001) 

```

# Data

All data used is reported annually at the county-level. Therefore, no time-invariant variables are included (apart from the State in which a county is in, which is made time-variant through the inclusion of a state-level trend in various models).

**Expenditure and Revenue:** The dependent variables of interest come from [Willamette University's Government Finance Database](https://willamette.edu/mba/research-impact/public-datasets/index.html). The data includes county-level revenue and expenditure on public education including disaggregated values by revenue source (federal, state, or other intergovernmental revenue) and expenditure item (lunches, wages, debt). All values are reported in current US dollars. The data for property taxes collected used in regressions below also come from this dataset. Expenditure on vocational training and from Educational Service Agencies (ESAs) are also sourced from this dataset. The challenge of accounting for ESAs are shown in KR2 section below. 

**GDP Controls:** US Bureau of Economic Analysis. Values are also reported in current US dollars (real GDP values exist). The controls used in the below are total, private industry, and oil, gas, mining & quarrying county-level GDP.

**Population controls:** US Census Bureau.

```{r, echo = FALSE, include = FALSE}

# *Economic Diversity:* [Chmura Analytics](https://www.chmura.com/blog/chmura-economic-diversity). This is time-invariant and not yet included in any regressions below.

```

**Coal mine activity and production levels:** Mine Safety and Health Administration

```{r, echo = FALSE, message = FALSE, include = FALSE}

# MOVE TO CLEANING SCRIPT

df_cleaned %>% pull(fips) %>% unique %>% setdiff(unique(gdp$fips)) %>% length(.) == 0
gdp %>% filter(fips %in% unique(df_cleaned$fips)) %>% filter(!complete.cases(.)) %>% nrow(.) == 0

ec_div <- readRDS(here("data/temp/econ_div_controls.RDS"))

df_cleaned %>% pull(fips) %>% unique %>% setdiff(unique(ec_div$fips)) %>% length(.) == 0

df <- df_cleaned %>% 
  left_join(., gdp, by = c('fips', 'year')) %>% 
  mutate(across(contains("gdp"), ~./pop_total, .names = "{.col}_pc")) %>% 
  group_by(fips) %>% 
  mutate(across(contains("gdp"), list(diff = ~. - dplyr::lag(., 1), log = ~log((.*1000) + 1)), .names = "{.fn}_{.col}"),
         # Currently only GDP controls contain diff
         across(contains('gdp'), list(l1 = ~dplyr::lag(., 1), l2 = ~dplyr::lag(., 2)), .names = "{.fn}_{.col}")) %>%
  ungroup %>%
  left_join(., ec_div, by = c('fips', 'year'))

df$state_name = sapply(df$state, get_state) 
df$region = sapply(df$state_name, get_region)

#rm(df_cleaned)
#rm(ec_div)
#rm(deflators)
##rm(gdp)

```

```{r, echo = FALSE, message = FALSE, include = FALSE}

# MOVE TO CLEANING SCRIPT

mines_data <- readRDS(here('data/temp/mines_data/allcomp_cap_prod_complete.RDS')) %>% 
  dplyr::select(-state)

#df %>% filter(!fips %in% unique(mines_data$fips)) %>% pull(fips) %>% unique
# mines_data %>% filter(!fips %in% unique(df$fips)) %>% pull(fips) %>% unique

mines_dff <- df %>% 
  #left_join(., allcomp_controls, by = c("year", "fips")) %>% 
  left_join(., mines_data, by = c("year", "fips")) %>% 
  group_by(fips) %>%
  mutate(across(c(total_n, total_active_n, total_active_prod, diff_total_active_n, l1_diff_total_active_n, l2_diff_total_active_n, diff_total_active_prod, l1_diff_total_active_prod, l2_diff_total_active_prod), ~ifelse(is.na(.), 0, .)),
        across(c(total_n, total_active_n, total_active_prod), ~log(. + 1), .names = "log_{.col}")) %>% 
  ungroup


# Testing for complete dataset
#Dependent variables are complete
mines_dff %>% 
  dplyr::select(fips, year,"Total_Taxes_pp", "Total_Educ_Total_Exp_pp", "Property_Tax_pp", "diff_Total_Taxes_pp", "diff_Total_Educ_Total_Exp_pp", "diff_Property_Tax_pp") %>% filter(year > 2001) %>% filter(!complete.cases(.))

# Missing a few cases in LA
mines_dff %>% 
  #filter(year != 2000) %>%  # gdp_o_g_mining_quarr_21_pc,  gdp_o_g_mining_quarr_21_pc, 
  dplyr::select(fips, year, gdp_total_pc, gdp_priv_ind_pc,gdp_govt_pc, 
         gdp_total_pc, gdp_priv_ind_pc, gdp_govt_pc) %>% 
  filter(!complete.cases(.))
       
# No missing values in coal counties - replaced other counties NA values with 0  
mines_dff %>% 
  dplyr::select(fips, year, total_n, diff_total_active_n, l1_diff_total_active_n, l2_diff_total_active_n, diff_total_active_prod, l1_diff_total_active_prod, l2_diff_total_active_prod) %>% 
  ungroup %>% filter(!complete.cases(.)) 

# deflators <- mines_dff %>% 
#   dplyr::select(year, fips, real_gdp_total, gdp_total) %>% 
#   group_by(year) %>% 
#   summarise(nom_gdp = sum(gdp_total),
#             real_gdp = sum(real_gdp_total)) %>% 
#   mutate(defl = nom_gdp/real_gdp) %>% 
#   dplyr::select(-c(nom_gdp, real_gdp))

# mines_df <- mines_dff %>% 
#   filter(year >= 2001) %>% 
#   #mutate(ruc_bin = as.factor(ruc_bin)) %>% 
#   mutate(across(all_of(dep), ~.*1000),
#          time = year - 2000) %>% 
#   mutate(across(contains("log"), ~ifelse(is.infinite(.), 0, .)),
#          across(c(log_esa_tot_exp_pp, log_esa_tot_exp), ~ifelse(is.na(.), 0, .))) %>% 
#   left_join(deflators, by = "year") %>% 
#   mutate(across(c(diff_log_Total_Educ_Total_Exp_pp, log_Total_Educ_Total_Exp, log_Total_Educ_Total_Exp_pp,Total_Educ_Total_Exp, Total_Educ_Total_Exp_pp,
#   diff_log_Elem_Educ_Total_Exp_pp, log_Elem_Educ_Total_Exp_pp, Elem_Educ_Total_Exp, log_Elem_Educ_Total_Exp,
#   log_Property_Tax_pp, log_Property_Tax, diff_log_Property_Tax_pp, diff_log_Property_Tax_pp, Property_Tax, log_Total_Rev_Own_Sources_pp, log_Total_Rev_Own_Sources, log_Total_IG_Revenue, log_Total_IG_Revenue_pp, log_Total_Fed_IG_Revenue, log_Total_Fed_IG_Revenue_pp, log_Total_State_IG_Revenue_pp, log_Total_State_IG_Revenue, log_Total_Revenue_pp, ), ~./defl, .names = "real_{.col}")) %>% 
#   group_by(fips) %>% 
#   mutate(share_fed = sum(Fed_IGR_Education, na.rm = TRUE)/sum(Elem_Educ_Total_Exp),
#          share_state = sum(State_IGR_Education, na.rm = TRUE)/sum(Elem_Educ_Total_Exp),
#          share_local_ig = sum(Tot_Local_IG_Rev, na.rm = TRUE)/sum(Elem_Educ_Total_Exp),
#          share_own = sum(Total_Rev_Own_Sources, na.rm = TRUE)/sum(Elem_Educ_Total_Exp),
#          share_own_discrete = case_when(share_own > 0.5 ~ "1 = high",
#                                         share_own < 0.25 ~ "3 = low",
#                                         TRUE ~ "2 = medium")) %>% 
#   ungroup

mines_restr <- mines_dff %>% 
  group_by(fips) %>% 
  filter(!(any(log_Property_Tax_pp < 4))) %>% 
  ungroup
  
rm(mines_dff)
rm(mines_data)

#saveRDS(mines_restr, here('data/temp/mines_restr.RDS'))
```


## ...
```{r, echo = FALSE, message = FALSE, warnings = FALSE, fig.height = 10}

mines_restr <- readRDS(here('data/temp/mines_restr.RDS')) %>% 
  mutate(time = year - 2000)

mean_df <- mines_restr %>% 
  group_by(year) %>%
             summarise(real_Total_Educ_Total_Exp = mean(real_Total_Educ_Total_Exp, na.rm = TRUE),
                       real_Total_Educ_Total_Exp_pp = mean(real_Total_Educ_Total_Exp_pp, na.rm = TRUE),
                       log_real_Total_Educ_Total_Exp = mean(log_real_Total_Educ_Total_Exp, na.rm = TRUE),
                       log_real_Total_Educ_Total_Exp_pp = mean(log_real_Total_Educ_Total_Exp_pp, na.rm = TRUE))

```

The following plots show the share of revenue for public education that comes from own sources, local intergovernmental, state intergovernmental, and federal intergovernmental by state. Almost all states have a near 50% split of revenue from state and own sources, which aligns with data from the Congressional Research Service cited in the Transfer of Status report. Massachusetts has an unusually high share of local IG support (inter-school aid), eclipsing own sources almost completely. From further research, I believe this has to do with a unique structure of Massachusetts public school funding which is reliant on several multi-county funding agencies (similar to the mentioned ESAs). This anomaly might warrant the exclusion of MA from the analysis.

**Conclusion: I am still unsure how best to control for the effects of these shares on our results.** 

```{r, echo = FALSE, message = FALSE, fig.height = 12}

state_df <- mines_restr %>% 
  group_by(state, year) %>% 
  summarise(across(c(Enrollment, Total_Educ_Total_Exp, Elem_Educ_Total_Exp, Total_Revenue, Total_Rev_Own_Sources, Total_Fed_IG_Revenue, Total_State_IG_Revenue, Tot_Local_IG_Rev, Total_Taxes, Property_Tax), ~sum(., na.rm = TRUE))) %>% ungroup

state_df$state_name = sapply(state_df$state, get_state) 
state_df$region = sapply(state_df$state_name, get_region)

state_df <- state_df %>% 
  relocate(state_name, region, .after = state) 
```

The below plot provides the same information as above but on a national level. 

**Conclusion: Corroborates the near-even split of revenue between state and own sources which seems to be a fact of public education revenue. I mainly include this as an alternative summarising figure to the above.**

```{r, echo = FALSE, fig.height = 8}

natl_df <- mines_restr %>% 
  group_by(year) %>% 
  summarise(across(c(Enrollment, Total_Educ_Total_Exp, Elem_Educ_Total_Exp, Total_Revenue, Total_Rev_Own_Sources, Total_IG_Revenue, Total_Fed_IG_Revenue, Total_State_IG_Revenue, Tot_Local_IG_Rev, Total_Taxes, Property_Tax), ~sum(., na.rm = TRUE))) %>% ungroup %>% mutate(across(Total_Educ_Total_Exp:last_col(), ~./Enrollment, .names = "{.col}_pp"))

#ggsave(here("output/plots/natl_shares_of_revenue_by_source.jpg"), g, width = 20, height = 25, units = "cm")

```

# Dataset coverage    
~ 9% of students are enrolled in private schools
```{r}
natl_coverage <- mines_restr %>%
  select(year, Enrollment, pop_school_age) %>%
  group_by(year) %>%
  summarise(across(c(Enrollment, pop_school_age), ~sum(., na.rm = TRUE))) %>%
  mutate(pupils_covered = Enrollment/(pop_school_age*(14/15)))

all_ff_states <- readRDS(here("data/temp/shift_shares_base_01_05_11.RDS")) %>% 
  mutate(state = substr(fips, start = 1, stop = 2)) %>% group_by(state) %>% filter(any(annual_avg_emplvl_211 > 100)) %>% 
  ungroup %>% 
  arrange(annual_avg_emplvl_211) %>% 
  pull(state) %>% 
  unique %>% 
  lapply(., get_state)
  

```


# Maps
```{r}

mines_restr_2021 <- mines_restr %>% filter(year == 2021) %>% 
  select(fips, log_real_Property_Tax_pp, log_real_Elem_Educ_Total_Exp_pp, log_real_gdp_priv_ind_pc)
```


# Preliminary Results
In the following set of results I report results for the sample used in the descriptive statistics above. With respect to the outlier threshold represented in KR3 I exclude any counties that report 

## Panel testing

```{r}

is.pbalanced(mines_restr, index = c("fips", "year"))

```

## Descriptive regression models

The below models were run to test the relevance of various GDP control variables (total, private industry, oil, gas & mining) as well as corroborate some relationships in the above scatter plots of KRs. Ideally, once variables have been surveyed, they will be put through model selection via getspanel.

All regression models that follow include TWFE (county- and year- fixed effects) and standard errors clustered by county.

All functional forms in the feols() functions below are of the form "Y ~ X"
In the cases in which multiple estimations are included via sw(Xa, Xb, Xc + Xd), the function will return results for "Y~Xa", "Y~Xb", "Y ~ Xc + Xd".


<!-- ### Property Tax ~ GDP -->
<!-- GDP has a highly relevant relationship to property taxes. A 1% increase in GDP and GDP per capita leads to a 0.3% increase in property taxes collected. -->

<!-- ```{r} -->
<!-- list(feols(log_Property_Tax ~ log_gdp_total + sw0(l(log_Property_Tax, 1)) | fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year), -->
<!--      feols(log_Property_Tax_pp ~ log_gdp_total_pc + sw0(l(log_Property_Tax_pp, 1))| fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)) %>% etable(se.below = TRUE) %>% kable -->

<!-- ``` -->

<!-- ### Education Expenditure ~ Revenue Sources -->
<!-- The below regressions are included to establish the relationship between education expenditure and its component parts. These regressions simply corroborate what is displayed in the section on Key Relationships above (ie. that the largest form of IG revenue is state funding and "Own Source" revenue is largely sourced from Property Taxes). -->
<!-- ```{r} -->
<!-- feols(c(log_Total_Educ_Total_Exp_pp, log_Elem_Educ_Total_Exp_pp) ~ sw(log_Property_Tax,  -->
<!--                                        log_Property_Tax + log_Total_IG_Revenue, -->
<!--                                        log_Property_Tax + log_Total_Fed_IG_Revenue + log_State_IGR_Education, -->
<!--                                       log_Total_Rev_Own_Sources + log_Total_IG_Revenue) | fips + year, data = mines_restr, se = "cluster", cluster = "fips") %>% etable(se.below = TRUE) %>% kable -->

<!-- feols(c(log_Total_Educ_Total_Exp_pp, log_Elem_Educ_Total_Exp_pp) ~ sw(log_Total_Rev_Own_Sources_pp + log_Total_IG_Revenue_pp, -->
<!--                                          log_Property_Tax_pp,  -->
<!--                                          log_Property_Tax_pp + log_Total_IG_Revenue_pp,  -->
<!--                                          log_Property_Tax_pp + log_Total_Fed_IG_Revenue_pp + log_State_IGR_Education_pp) | fips + year, data = mines_restr, se = "cluster", cluster = "fips") %>% etable(se.below = TRUE) %>% kable -->

<!-- ``` -->


### Education Expenditure ~ GDP
A 1% increase in GDP is associated with a 0.14% increase in education expenditure, dominated by the effect of GDP from private industry (0.12%). I include here also the GDP generated from the oil, gas, mining, and quarrying sector. The effect is statistically significant but small. 
#### Nominal values
```{r}
tot_vars = c("diff_log_Total_Educ_Total_Exp_pp", "log_Total_Educ_Total_Exp_pp")
elem_vars = c("diff_log_Elem_Educ_Total_Exp_pp", "log_Elem_Educ_Total_Exp_pp")

list(feols(log_Total_Educ_Total_Exp_pp ~ l(log_Total_Educ_Total_Exp_pp, 1) + sw0(log_gdp_total_pc,
                                         log_gdp_priv_ind_pc,
                                         log_gdp_o_g_mining_quarr_21_pc) | fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year),
     feols(.[tot_vars] ~ sw(log_gdp_total_pc,
                                         log_gdp_priv_ind_pc,
                                         log_gdp_o_g_mining_quarr_21_pc) | fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)) %>% etable(se.below = TRUE) #%>% kable

list(feols(log_Elem_Educ_Total_Exp_pp ~ l(log_Elem_Educ_Total_Exp_pp, 1) + sw0(log_gdp_total_pc,
                                         log_gdp_priv_ind_pc,
                                         log_gdp_o_g_mining_quarr_21_pc) | fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year),
     feols(.[elem_vars] ~ sw(log_gdp_total_pc,
                                         log_gdp_priv_ind_pc,
                                         log_gdp_o_g_mining_quarr_21_pc) | fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)) %>% etable(se.below = TRUE) %>% kable

```

#### Real values
```{r}
tot_vars = c("diff_log_real_Total_Educ_Total_Exp_pp", "log_real_Total_Educ_Total_Exp_pp")
elem_vars = c("diff_log_real_Elem_Educ_Total_Exp_pp", "log_real_Elem_Educ_Total_Exp_pp")

list(feols(log_real_Total_Educ_Total_Exp_pp ~ l(log_real_Total_Educ_Total_Exp_pp, 1) + sw0(log_real_gdp_total_pc,
                                         log_real_gdp_priv_ind_pc,
                                         log_real_gdp_o_g_mining_quarr_21_pc) | fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year),
     feols(.[tot_vars] ~ sw(log_real_gdp_total_pc,
                                         log_real_gdp_priv_ind_pc,
                                         log_real_gdp_o_g_mining_quarr_21_pc) | fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)) %>% etable(se.below = TRUE) #%>% kable

list(feols(log_real_Elem_Educ_Total_Exp_pp ~ l(log_real_Elem_Educ_Total_Exp_pp, 1) + sw0(log_real_gdp_total_pc,
                                         log_real_gdp_priv_ind_pc,
                                         log_real_gdp_o_g_mining_quarr_21_pc) | fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year),
     feols(.[elem_vars] ~ sw(log_real_gdp_total_pc,
                                         log_real_gdp_priv_ind_pc,
                                         log_real_gdp_o_g_mining_quarr_21_pc) | fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)) %>% etable(se.below = TRUE)# %>% kable

```


#### Incorporating state-level trends
The below take the Education Expenditure ~ GDP models and incorporate state-level time trends.
```{r, message = FALSE, warnings = FALSE}
list(feols(log_Total_Educ_Total_Exp_pp ~ l(log_Total_Educ_Total_Exp_pp, 1) + sw0(log_gdp_total_pc,
                                         log_gdp_priv_ind_pc,
                                         log_gdp_o_g_mining_quarr_21_pc) + time:as.factor(state) | fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year),
     feols(log_Total_Educ_Total_Exp_pp ~ l(log_Total_Educ_Total_Exp_pp, 1) +sw(log_gdp_total_pc,
                                         log_gdp_priv_ind_pc,
                                         log_gdp_o_g_mining_quarr_21_pc) + time:as.factor(state) | fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)) %>% etable(., drop = "time*", se.below = TRUE) %>% kable

list(feols(log_Elem_Educ_Total_Exp_pp ~ l(log_Elem_Educ_Total_Exp_pp, 1) + sw0(log_gdp_total_pc,
                                         log_gdp_priv_ind_pc,
                                         log_gdp_o_g_mining_quarr_21_pc) + time:as.factor(state) | fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year),
     feols(log_Elem_Educ_Total_Exp_pp ~ l(log_Elem_Educ_Total_Exp_pp, 1) + sw(log_gdp_total_pc,
                                         log_gdp_priv_ind_pc,
                                         log_gdp_o_g_mining_quarr_21_pc) + time:as.factor(state) | fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)) %>% etable(., drop = "time*", se.below = TRUE) %>% kable

```


#### Incorporating time lags
*Have not yet incorporated an AR term*
Education expenditure has a highly relevant time dependence. The effect of increases in GDP two years prior has the greatest effect on current education expenditure, implying a delayed effect of county-level economic prosperity/decline on public education expenditure. 

**Question: Is the above interpretation of the time dependence accurate?**
```{r}
levs_gdp_real_trend <- feols(c(log_real_Total_Educ_Total_Exp_pp, log_real_Elem_Educ_Total_Exp_pp) ~ sw(log_real_gdp_total + l1_log_real_gdp_total + l2_log_real_gdp_total, log_real_gdp_priv_ind + l1_log_real_gdp_priv_ind + l2_log_real_gdp_priv_ind) + time:as.factor(state) | fips + year, data = mines_restr, se = "cluster", cluster = "fips")
levs_gdp_real_trend %>% etable(., drop = "time*", se.below = TRUE) %>% kable

feols(c(log_Total_Educ_Total_Exp_pp, log_Elem_Educ_Total_Exp_pp) ~ sw(log_gdp_total_pc + l1_log_gdp_total_pc + l2_log_gdp_total_pc, 
                                      log_gdp_priv_ind_pc + l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc,
                                      log_gdp_o_g_mining_quarr_21 + l1_log_gdp_o_g_mining_quarr_21 + l2_log_gdp_o_g_mining_quarr_21) + time:as.factor(state) | fips + year, data = mines_restr, se = "cluster", cluster = "fips") %>%  etable(., drop = "time*", se.below = TRUE) %>% kable

feols(c(log_Total_Educ_Total_Exp_pp, log_Elem_Educ_Total_Exp_pp) ~ sw(log_gdp_total_pc + l1_log_gdp_total_pc + l2_log_gdp_total_pc, 
                                      log_gdp_priv_ind_pc + l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc,
                                      log_gdp_o_g_mining_quarr_21_pc + l1_log_gdp_o_g_mining_quarr_21_pc + l2_log_gdp_o_g_mining_quarr_21_pc) + time:as.factor(state) | fips + year, data = mines_restr, se = "cluster", cluster = "fips") %>%  etable(., drop = "time*", se.below = TRUE) %>% kable

```


## Coal Mine & Production Data
Coal mine data exists from 1996-2021. The below is a preliminary treatment attempt using data on active coal production (total_active_prod) and active coal mines (total_active_n).

**Question: might it be more interesting to look at the first difference of mining and production activity to understand the effect of a change in activity?**

### Standard TWFE panel regression

```{r, message = FALSE}
list(feols(c(log_Total_Educ_Total_Exp_pp, log_Elem_Educ_Total_Exp_pp) ~ log_gdp_priv_ind_pc + l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc + diff_total_active_n + l1_diff_total_active_n + l2_diff_total_active_n | fips + year, data = mines_restr, se = "cluster", cluster = "fips"),
feols(c(log_Total_Educ_Total_Exp_pp, log_Elem_Educ_Total_Exp_pp) ~ sw(log_gdp_priv_ind_pc + l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc + diff_total_active_prod + l1_diff_total_active_prod + l2_diff_total_active_prod,
                                         log_gdp_total_pc + l1_log_gdp_total_pc + l2_log_gdp_total_pc + diff_total_active_n + l1_diff_total_active_n + l2_diff_total_active_n,
                                         log_gdp_total_pc + l1_log_gdp_total_pc + l2_log_gdp_total_pc + diff_total_active_prod + l1_diff_total_active_prod + l2_diff_total_active_prod) | fips + year, data = mines_restr, se = "cluster", cluster = "fips")) %>% etable(se.below = TRUE) %>% kable


list(feols(c(log_Total_Educ_Total_Exp_pp, log_Elem_Educ_Total_Exp_pp) ~ log_gdp_priv_ind_pc + l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc + l(total_active_n, 0:2)  | fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year),
     feols(c(log_Total_Educ_Total_Exp_pp, log_Elem_Educ_Total_Exp_pp) ~ sw(log_gdp_priv_ind_pc + l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc + l(total_active_prod, 0:2),
                                         log_gdp_total_pc + l1_log_gdp_total_pc + l2_log_gdp_total_pc + l(total_active_n, 0:2),
                                         log_gdp_total_pc + l1_log_gdp_total_pc + l2_log_gdp_total_pc + l(total_active_prod, 0:2)) | fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)) %>% etable(se.below = TRUE) %>% kable
```


### TWFE panel with state-level trends

```{r, message = FALSE}

list(feols(c(log_Total_Educ_Total_Exp_pp, log_Elem_Educ_Total_Exp_pp) ~ log_gdp_priv_ind_pc + l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc + diff_total_active_n + l1_diff_total_active_n + l2_diff_total_active_n + time:as.factor(state) | fips + year, data = mines_restr, se = "cluster", cluster = "fips"),
feols(c(log_Total_Educ_Total_Exp_pp, log_Elem_Educ_Total_Exp_pp) ~ sw(log_gdp_priv_ind_pc + l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc + diff_total_active_prod + l1_diff_total_active_prod + l2_diff_total_active_prod,
                                         log_gdp_total_pc + l1_log_gdp_total_pc + l2_log_gdp_total_pc + diff_total_active_n + l1_diff_total_active_n + l2_diff_total_active_n,
                                         log_gdp_total_pc + l1_log_gdp_total_pc + l2_log_gdp_total_pc + diff_total_active_prod + l1_diff_total_active_prod + l2_diff_total_active_prod) + time:as.factor(state) | fips + year, data = mines_restr, se = "cluster", cluster = "fips")) %>% etable(se.below = TRUE, drop = "time*") %>% kable


list(feols(c(log_Total_Educ_Total_Exp_pp, log_Elem_Educ_Total_Exp_pp) ~ log_gdp_priv_ind_pc + l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc + l(total_active_n, 0:2)  + time:as.factor(state) | fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year),
     feols(c(log_Total_Educ_Total_Exp_pp, log_Elem_Educ_Total_Exp_pp) ~ sw(log_gdp_priv_ind_pc + l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc + l(total_active_prod, 0:2),
                                         log_gdp_total_pc + l1_log_gdp_total_pc + l2_log_gdp_total_pc + l(total_active_n, 0:2),
                                         log_gdp_total_pc + l1_log_gdp_total_pc + l2_log_gdp_total_pc + l(total_active_prod, 0:2)) + time:as.factor(state) | fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)) %>% etable(se.below = TRUE, drop = "time*") %>% kable

```


### Dealing with endogeneity
There is a significant endogeneity concern in using total active production and active mines as the treatment variable. Therefore, I have tried two instrumental variable approaches below and aim to add results using production- and employment-based Bartik instruments.

#### Instrumental Variable
We consider using total active production or total active mines as an instrument affecting education expenditure through property taxes or GDP. We know that property taxes have an endogenous relationship with education expenditure (it is a component of the public education budget), however, in theory mine closures/activity is unlikely to affect education expenditure, except via property taxes. We test this hypothesis below. 

**Conclusion: The results themselves are not promising (I think??)**

##### Using coal production and mine activity as instruments for per capita property tax
To my eye, I don't see any of these being useful - either they fail a first-stage F-test or the resulting coefficient on the treatment is statistically insignificant. 

```{r, message = FALSE, warnings = FALSE}
# Using total active production as an instrument for per capita property tax
feols(log_Total_Educ_Total_Exp_pp ~ l(log_Total_Educ_Total_Exp_pp, 1) | fips + year | log_Property_Tax_pp ~ total_active_prod, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)
feols(log_Elem_Educ_Total_Exp_pp ~ l(log_Elem_Educ_Total_Exp_pp, 1) | fips + year | log_Property_Tax_pp ~ total_active_prod, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)

# Using the lag of total active production as an instrument for per capita property tax
feols(log_Total_Educ_Total_Exp_pp ~ l(log_Total_Educ_Total_Exp_pp, 1) | fips + year | log_Property_Tax_pp ~ l(total_active_prod,1), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)

feols(log_Elem_Educ_Total_Exp_pp ~ l(log_Elem_Educ_Total_Exp_pp, 1) | fips + year | log_Property_Tax_pp ~ l(total_active_prod,1), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)

# Using total active mines as an instrument for per capita property tax
feols(log_Total_Educ_Total_Exp_pp ~ l(log_Total_Educ_Total_Exp_pp, 1) | fips + year | log_Property_Tax_pp ~ total_active_n, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)

feols(log_Elem_Educ_Total_Exp_pp ~ l(log_Elem_Educ_Total_Exp_pp, 1) | fips + year | log_Property_Tax_pp ~ total_active_n, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)

# Using lag of total active mines as an instrument for per capita property tax
feols(log_Total_Educ_Total_Exp_pp ~ l(log_Total_Educ_Total_Exp_pp, 1) | fips + year | log_Property_Tax_pp ~ l(total_active_n,1:2), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)

feols(log_Elem_Educ_Total_Exp_pp ~ l(log_Elem_Educ_Total_Exp_pp, 1) | fips + year | log_Property_Tax_pp ~ l(total_active_n,1:2), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)
```

####### Incorporating additional control variables

```{r, message = FALSE, warnings = FALSE}
# Using total active production as an instrument for per capita property tax
feols(log_Total_Educ_Total_Exp_pp ~ l(log_Total_Educ_Total_Exp_pp, 1) | fips + year | log_Property_Tax_pp ~ total_active_prod, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)
feols(log_Elem_Educ_Total_Exp_pp ~ l(log_Elem_Educ_Total_Exp_pp, 1) | fips + year | log_Property_Tax_pp ~ total_active_prod, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)

# Using the lag of total active production as an instrument for per capita property tax
feols(log_Total_Educ_Total_Exp_pp ~ l(log_Total_Educ_Total_Exp_pp, 1) | fips + year | log_Property_Tax_pp ~ l(total_active_prod,1), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)

feols(log_Elem_Educ_Total_Exp_pp ~ l(log_Elem_Educ_Total_Exp_pp, 1) | fips + year | log_Property_Tax_pp ~ l(total_active_prod,1), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)

```




##### Using coal production and mine activity as instruments for per capita gdp
All pass a first-stage F-test with high statistic and low p-value; however, less than satisfactory on the Wu-Hausman endogeneity test.

It seems that if we replace the "total education expenditure per pupil" with a measure of total expenditure on elementary education only, the effect is more pronounced.

**Conclusion: These are the results I am most inclined to "report" in some way, even though it is weak. So I am curious for your thoughts on the validity (and blind spots I've missed when constructing the model).**

```{r, message = FALSE, warnings = FALSE}
# Using total active production as an instrument for per capita gdp
feols(log_Total_Educ_Total_Exp_pp ~ 1 | fips + year | log_gdp_total_pc ~ total_active_prod, data = mines_restr, se = "cluster", cluster = "fips")

feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_gdp_total_pc ~ total_active_prod, data = mines_restr, se = "cluster", cluster = "fips")

# Using the lag of total active production as an instrument for per capita gdp
feols(log_Total_Educ_Total_Exp_pp ~ 1 | fips + year | log_gdp_total_pc ~ l(total_active_prod,1), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)

feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_gdp_total_pc ~ l(total_active_prod,1), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)

# Using total active mines as an instrument for per capita gdp
feols(log_Total_Educ_Total_Exp_pp ~ 1 | fips + year | log_gdp_total_pc ~ total_active_n, data = mines_restr, se = "cluster", cluster = "fips")

feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_gdp_total_pc ~ total_active_n, data = mines_restr, se = "cluster", cluster = "fips")

# Using lag og total active mines as an instrument for per capita gdp
feols(log_Total_Educ_Total_Exp_pp ~ 1 | fips + year | log_gdp_total_pc ~ l(total_active_n,1), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)

feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_gdp_total_pc ~ l(total_active_n,1), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)

```


```{r, include = FALSE}
# getspanel
# isatpanel(data = mines_restr, 
#           formula = "Total_Educ_Total_Exp_pp ~ gdp_total_pc + gdp_priv_ind_pc + gdp_o_g_mining_quarr_21_pc + gdp_govt_pc",
#           index = c("fips","year"),
#          iis = TRUE,
#          t.pval =0.01
#          # SIS = TRUE 
#           )

```

# Regression tables for ToS
## Standard controls and coal production data
```{r}

# Total educ w/0 county-level trends
feols(c(log_Total_Educ_Total_Exp_pp, log_Elem_Educ_Total_Exp_pp)  ~ log_gdp_priv_ind_pc +
             sw0(l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc,
                l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc + diff_total_active_n,
                l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc + l(diff_total_active_n, 0:2),
                 l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc + diff_total_active_prod,
                l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc + l(diff_total_active_prod, 0:2)) | fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year) %>% etable(se.below = TRUE)
     
feols(c(log_Total_Educ_Total_Exp_pp, log_Elem_Educ_Total_Exp_pp)  ~ log_gdp_priv_ind_pc +
             sw0(l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc,
                l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc + diff_total_active_n,
                l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc + l(diff_total_active_n, 0:2),
                 l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc + diff_total_active_prod,
                l1_log_gdp_priv_ind_pc + l2_log_gdp_priv_ind_pc + l(diff_total_active_prod, 0:2)) + time:as.factor(state) | fips + year, data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year) %>% etable(se.below = TRUE, drop = "time*")


```

## Instrumental Variable
```{r}
setFixest_etable(fitstat = ~ . + ivf1 + ivf1.p + wh + wh.p + ivwald1 + ivwald1.p + ivf2 + ivf2.p + ivwald2 + ivwald2.p, se.below = TRUE)

# Using total active production as an instrument for per capita property tax
lapply(list(feols(log_Total_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ total_active_prod, data = mines_restr, se = "cluster", cluster = "fips"), 
  feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ total_active_prod, data = mines_restr, se = "cluster", cluster = "fips"),
  # Using the lag of total active production as an instrument for per capita property tax
  feols(log_Total_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ l(total_active_prod,1), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year),
  feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ l(total_active_prod,1), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)), summary) %>% etable()

# Using total active production as an instrument for per capita property tax controlling for state and federal support
lapply(list(feols(log_Total_Educ_Total_Exp_pp ~ log_Total_State_IG_Revenue_pp + log_Total_Fed_IG_Revenue_pp | fips + year | log_Property_Tax_pp ~ total_active_prod, data = mines_restr, se = "cluster", cluster = "fips"), 
  feols(log_Elem_Educ_Total_Exp_pp ~ log_Total_State_IG_Revenue_pp + log_Total_Fed_IG_Revenue_pp | fips + year | log_Property_Tax_pp ~ total_active_prod, data = mines_restr, se = "cluster", cluster = "fips"),
  # Using the lag of total active production as an instrument for per capita property tax
  feols(log_Total_Educ_Total_Exp_pp ~ log_Total_State_IG_Revenue_pp + log_Total_Fed_IG_Revenue_pp | fips + year | log_Property_Tax_pp ~ l(total_active_prod,1), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year),
  feols(log_Elem_Educ_Total_Exp_pp ~ log_Total_State_IG_Revenue_pp + log_Total_Fed_IG_Revenue_pp | fips + year | log_Property_Tax_pp ~ l(total_active_prod,1), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)), summary) %>% etable()

# Using total active mines as an instrument for per capita property tax
lapply(list(feols(log_Total_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ total_active_n, data = mines_restr, se = "cluster", cluster = "fips"),
  feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ total_active_n, data = mines_restr, se = "cluster", cluster = "fips"),
  
  # Using lag of total active mines as an instrument for per capita property tax
 feols(log_Total_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ l(total_active_n,1:2), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year),
  feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ l(total_active_n,1:2), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)), summary)  %>% etable()
```


# Removing outliers - really high-income counties!!!
```{r}

mines_no_outliers <- mines_restr %>% 
  group_by(fips) %>% 
  filter(!any(log_real_Property_Tax_pp > 10.5)) %>% 
  ungroup

mines_no_outliers %>% 
  ggplot(aes(x = log_real_Elem_Educ_Total_Exp_pp, y = log_real_Property_Tax_pp, colour = share_own_discrete)) +
  geom_jitter() +
    #geom_smooth(method=lm, colour = "black", linetype = "dashed") +
  labs(title = "Elem Education Expenditure pp vs Property Tax pp") +
  geom_abline(slope = 1, intercept = 0, linetype = 'dashed') +
  theme_bw() +
  theme(title = element_text(size = 9)) +
  labs(colour = "Reliance on Local Sources")


setFixest_etable(fitstat = ~ . + ivf1 + ivf1.p + wh + wh.p + ivwald1 + ivwald1.p + ivf2 + ivf2.p + ivwald2 + ivwald2.p, se.below = TRUE)

# Using total active production as an instrument for per capita property tax
lapply(list(feols(log_Total_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ total_active_prod, data = mines_no_outliers, se = "cluster", cluster = "fips"), 
  feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ total_active_prod, data = mines_no_outliers, se = "cluster", cluster = "fips"),
  # Using the lag of total active production as an instrument for per capita property tax
  feols(log_Total_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ l(total_active_prod,1), data = mines_no_outliers, se = "cluster", cluster = "fips", panel.id = ~fips+year),
  feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ l(total_active_prod,1), data = mines_no_outliers, se = "cluster", cluster = "fips", panel.id = ~fips+year)), summary) %>% etable()

# Using total active production as an instrument for per capita property tax controlling for state and federal support
lapply(list(feols(log_Total_Educ_Total_Exp_pp ~ log_Total_State_IG_Revenue_pp + log_Total_Fed_IG_Revenue_pp | fips + year | log_Property_Tax_pp ~ total_active_prod, data = mines_no_outliers, se = "cluster", cluster = "fips"), 
  feols(log_Elem_Educ_Total_Exp_pp ~ log_Total_State_IG_Revenue_pp + log_Total_Fed_IG_Revenue_pp | fips + year | log_Property_Tax_pp ~ total_active_prod, data = mines_no_outliers, se = "cluster", cluster = "fips"),
  # Using the lag of total active production as an instrument for per capita property tax
  feols(log_Total_Educ_Total_Exp_pp ~ log_Total_State_IG_Revenue_pp + log_Total_Fed_IG_Revenue_pp | fips + year | log_Property_Tax_pp ~ l(total_active_prod,1), data = mines_no_outliers, se = "cluster", cluster = "fips", panel.id = ~fips+year),
  feols(log_Elem_Educ_Total_Exp_pp ~ log_Total_State_IG_Revenue_pp + log_Total_Fed_IG_Revenue_pp | fips + year | log_Property_Tax_pp ~ l(total_active_prod,1), data = mines_no_outliers, se = "cluster", cluster = "fips", panel.id = ~fips+year)), summary) %>% etable()

# Using total active mines as an instrument for per capita property tax
lapply(list(feols(log_Total_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ total_active_n, data = mines_no_outliers, se = "cluster", cluster = "fips"),
  feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ total_active_n, data = mines_no_outliers, se = "cluster", cluster = "fips"),
  
  # Using lag of total active mines as an instrument for per capita property tax
 feols(log_Total_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ l(total_active_n,1:2), data = mines_no_outliers, se = "cluster", cluster = "fips", panel.id = ~fips+year),
  feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ l(total_active_n,1:2), data = mines_no_outliers, se = "cluster", cluster = "fips", panel.id = ~fips+year)), summary)  %>% etable()

```


# On Coal Counties Only
First stage F-test is significant in the case of l0, l1, l2, l3 with significant treatment effect in l0 (.1%), l1 (1%), l2 & l3 (5%)

Significance disappears when we control for level and per capita GDP.
```{r}

cc_only <- mines_restr %>% 
  group_by(fips) %>% 
  filter(any(total_n > 0)) %>% 
  ungroup

# Using total active production as an instrument for per capita property tax
feols(log_Elem_Educ_Total_Exp_pp ~ sw(1, log_real_gdp_total, log_gdp_total, log_real_gdp_total_pc, log_gdp_total_pc) | fips + year | log_Property_Tax_pp ~ total_active_prod, data = cc_only, se = "cluster", cluster = "fips") %>% summary

feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ total_active_prod, data = cc_only, se = "cluster", cluster = "fips", panel.id = ~fips+year) 

feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ l(total_active_prod,2), data = cc_only, se = "cluster", cluster = "fips", panel.id = ~fips+year)

feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ l(total_active_prod,3), data = cc_only, se = "cluster", cluster = "fips", panel.id = ~fips+year)

feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ total_active_prod + l(total_active_prod,1) + l(total_active_prod,2), data = cc_only, se = "cluster", cluster = "fips", panel.id = ~fips+year) 


```


# Changes in activity
```{r, include = FALSE}

# Using total active production as an instrument for per capita property tax
lapply(list(feols(log_Total_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ diff_total_active_prod, data = mines_restr, se = "cluster", cluster = "fips"), 
  feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ diff_total_active_prod, data = mines_restr, se = "cluster", cluster = "fips"),
  # Using the lag of total active production as an instrument for per capita property tax
  feols(log_Total_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ l(diff_total_active_prod,1), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year),
  feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ l(diff_total_active_prod,1), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)), summary) %>% etable()

# Using total active mines as an instrument for per capita property tax
  lapply(list(feols(log_Total_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ diff_total_active_n, data = mines_restr, se = "cluster", cluster = "fips"),
  feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ diff_total_active_n, data = mines_restr, se = "cluster", cluster = "fips"),
  
  # Using lag of total active mines as an instrument for per capita property tax
 feols(log_Total_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ l(diff_total_active_n,1:2), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year),
  feols(log_Elem_Educ_Total_Exp_pp ~ 1 | fips + year | log_Property_Tax_pp ~ l(diff_total_active_n,1:2), data = mines_restr, se = "cluster", cluster = "fips", panel.id = ~fips+year)), summary)  %>% etable()

```

## Bartik

#### Bartik Instrument

```{r}

ss <- readRDS(here("data/temp/shift_shares_base_01_05_11.RDS"))

ss %>% 
  #filter(!(substr(fips, 1,2) %in% c("02", "15", "51", "09", "24"))) %>% 
  pull(fips) %>% 
  unique %>% 
  setdiff(unique(mines_restr$fips), .)

ss_df <- mines_restr %>% 
  left_join(., ss, by = c("year", "fips"))


# library(ShiftShareSE)
# # Estimate the shift-share instrumental variable regression
# ivreg_ss(d_sh_empl ~ 1 | shock, 
#           X=IV, 
#           data=ADH$reg,
#           W=ADH$W,
#           method=c("ehw", "akm", "akm0")
#           )
# 
# ivreg_ss(log_Elem_Educ_Total_Exp_pp ~ 1 | fd_annual_avg_emplvl_21,
#          X = fd_annual_avg_emplvl_21,
#         data=ss_df,
#         W=ss_df$share_emp_extraction,
#         method=c("ehw", "akm", "akm0")
#          )

ss_labs <- as_labeller(c("ss_emp_coal_2001" = "Coal",
    "ss_emp_oil_gas_2001" = "Oil & Gas",
    "ss_emp_extraction_2001" = "Extractive Industries",
    "ss_wage_coal_2001" = "Coal",
    "ss_wage_oil_gas_2001" = "Oil & Gas",
    "ss_wage_extraction_2001" = "Extractive Industries"))



sswage <- ss_df %>% 
  dplyr::select(fips, year,ss_emp_coal_2001, ss_emp_oil_gas_2001, ss_emp_extraction_2001) %>% 
  pivot_longer(contains("ss")) %>% 
  group_by(fips) %>% 
  filter(any(!is.na(value))) %>% 
  ungroup %>% 
  ggplot(aes(x = year, y = value, group = fips)) +
  geom_line(alpha = 0.2, color = "darkblue") + 
  facet_wrap(~name, scales = "free", labeller = ss_labs) +
  xlab("Year") +
  ylab("Change in Total Employment") +
  labs(title = "Employment-based Shift-Share Instrument") +
  theme_bw() + 
  theme(legend.position = "none",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        strip.text = element_text(face = "bold"),
                strip.background = element_rect(
     color="grey", fill="lightsteelblue2", linetype="solid"),
        panel.border = element_rect(color = "grey"),
        plot.background = element_blank(),
        plot.title = element_text(hjust=0.5))
  
ss_coal <- ss_df %>% 
  dplyr::select(fips, year,ss_wage_coal_2001, ss_wage_oil_gas_2001, ss_wage_extraction_2001) %>% 
  pivot_longer(contains("ss")) %>% 
  group_by(fips) %>% 
  filter(any(!is.na(value))) %>% 
  ungroup %>% 
  mutate(value = value/1000000) %>%  
  ggplot(aes(x = year, y = value, group = fips)) +
  geom_line(alpha = 0.2, color = "violetred3") + 
  facet_wrap(~name, scales = "free", labeller = ss_labs) +
  xlab("Year") +
  ylab("Change in Total Wages (millions)") +  
  labs(title = "Wage-based Shift-Share Instrument") +
  theme_bw() +
  theme(legend.position = "none",
        strip.background = element_rect(
     color="grey", fill="pink1", linetype="solid"),
        panel.grid.major = element_blank(), 
        panel.border = element_rect(color = "grey"),
             strip.text = element_text(face = "bold"),
        panel.grid.minor = element_blank(),
        plot.background = element_blank(),
        plot.title = element_text(hjust=0.5))

bartik <- arrangeGrob(grid.arrange(sswage, ss_coal, ncol = 1))

#ggsave(here("output/plots/bartik_graphs.jpg"), bartik, width = 25, height = 25, units = "cm")

```

##### Wage Instrument
```{r}

scaled_ss <- ss_df %>% 
  mutate(across(contains("ss"), ~./1000000000))


feols(log_Elem_Educ_Total_Exp_pp ~ log_gdp_total_pc + 
        sw(ss_wage_coal_2001, ss_wage_coal_2005, ss_wage_coal_2011,  
           ss_wage_oil_gas_2001, ss_wage_oil_gas_2005, ss_wage_oil_gas_2011,  
           ss_wage_ff_2001, ss_wage_ff_2005, ss_wage_ff_2011, 
            ss_wage_extraction_2001, ss_wage_extraction_2005, ss_wage_extraction_2011) | fips + year, data = scaled_ss, se = "cluster", cluster = "fips")


```

##### Employment Instrument
```{r}
feols(log_Elem_Educ_Total_Exp_pp ~ log_gdp_total_pc + 
        sw(ss_emp_coal_2001, ss_emp_coal_2005, ss_emp_coal_2011,  
           ss_emp_oil_gas_2001, ss_emp_oil_gas_2005, ss_emp_oil_gas_2011,  
           ss_emp_ff_2001, ss_emp_ff_2005, ss_emp_ff_2011, 
            ss_emp_extraction_2001, ss_emp_extraction_2005, ss_emp_extraction_2011) | fips + year, data = scaled_ss, se = "cluster", cluster = "fips")
```


# Summary statistics with coal production
```{r}

# Variables of interest for descriptive statistics
vars <- c("Total_Revenue", "Property_Tax", "Total_IG_Revenue", "Total_Fed_IG_Revenue", "Total_State_IG_Revenue", "Total_Educ_Total_Exp", "Elem_Educ_Total_Exp")

mines_restr %>%
  mutate(across(c(esa_tot_exp, vars, paste0(vars, "_pp"), gdp_total, gdp_priv_ind, gdp_govt, gdp_o_g_mining_quarr_21), ~./1000)) %>% 
  dplyr::select(year, esa_tot_exp, esa_tot_exp_pp, Enrollment, all_of(vars), paste0(vars, "_pp"), pop_total, pop_school_age, gdp_total, gdp_priv_ind, gdp_govt, gdp_o_g_mining_quarr_21, total_active_n, total_active_prod) %>% 
  # rename("ESA Expenditure" = esa_tot_exp, 
  #        "ESA Expenditure per pupil" = esa_tot_exp_pp, 
  #        "Revenue" = "Total_Revenue", 
  #        "Property Tax" = "Property_Tax",
  #        "IG Revenue" = "Total_IG_Revenue", 
  #        "Federal IG Revenue" = "Total_Fed_IG_Revenue", 
  #        "State IG Revenue" = "Total_State_IG_Revenue",
  #        "Expenditure" = "Total_Expenditure",
  #        "Revenue per pupil" = "Total_Revenue_pp", 
  #        "Property Tax per pupil" = "Property_Tax_pp",
  #        "IG Revenue per pupil" = "Total_IG_Revenue_pp", 
  #        "Federal IG Revenue per pupil" = "Total_Fed_IG_Revenue_pp", 
  #        "State IG Revenue per pupil" = "Total_State_IG_Revenue_pp",
  #        "Expenditure per pupil" = "Total_Expenditure_pp",
  #        "Population" = pop_total,
  #        "School Age Population" = pop_school_age, 
  #        "GDP" = gdp_total,
  #        "Private Industry GDP" = gdp_priv_ind, 
  #        "Government GDP" = gdp_govt, 
  #        "Oil, gas, mining GDP" = gdp_o_g_mining_quarr_21) %>% 
  #dplyr::group_split(year < 2007) %>% 
  #    purrr::iwalk(.,~{
  #      .x %>% 
          dplyr::select(-year) %>% 
          data.frame() %>%
          stargazer(digits = 0, digits.extra = 3, covariate.labels = c("ESA Expenditure", 
         "ESA Expenditure per pupil",
         "Enrollment",
         "Revenue", 
         "Property Tax",
         "IG Revenue", 
         "Federal IG Revenue",
         "State IG Revenue",
         "Expenditure",
         "Revenue per pupil", 
         "Property Tax per pupil",
         "IG Revenue per pupil", 
         "Federal IG Revenue per pupil", 
         "State IG Revenue per pupil",
         "Expenditure per pupil",
         "Population",
         "School Age Population", 
         "GDP",
         "GDP - Private Industry", 
         "GDP - Government", 
         "GDP - Oil, gas, mining",
         "Active Coal Mines",
         "Coal Produced (k short tons)"), type = "latex")


```



### PANELVAR
```{r}
library(panelvar)

test_pvar <- pvargmm(
  dependent_vars = c("real_Elem_Educ_Total_Exp", "log_real_Property_Tax", "log_real_gdp_priv_ind"),
  lags = 1, 
  panel_identifier = c("fips", "year"),
  steps = c("twostep"),
  data = data.frame(mines_restr)
)


```

# Defining Decline
What would be great is to be able to econometrically test when a county is "declining." In the first step, it would be good to identify when a county is declining overall (GDP, poverty, etc) but ideally eventually apply this to the education outcome. My hope is that being able to identify counties that are "declining" we can either use this variable as a covariate or as a central point of analysis. The below analysis looks at state-level variables as a first step (mainly to aid in visual comparison and plotting). Ideally, once a method is decided on this would be applied to county-level data which would need to be summarise/collated in some way for plotting.

Below I suggest a few options (some of which I have tried). They require functions and tests from time series literature and it would be great to get Jennie's input/direction on this. 

## First step (GDP only):
- Negative trend (X)
- Autocorrelation (X)
-- If autocorrelation is consistently positive indicates trend? 
-- Should this focus on autocorrelation in levels or differences?
- Trend indicator saturation - negative trend breaks? (_)
- Exhibit national or state-level GDP growth as global common factor; counties with negative factor loadings might arguably exhibit decline (_)


```{r, include = FALSE}

state_lev <- mines_restr %>% 
  group_by(state, year) %>% 
  summarise(across(c(real_gdp_priv_ind, real_Elem_Educ_Total_Exp, log_real_gdp_priv_ind, log_real_Elem_Educ_Total_Exp, log_real_Property_Tax, real_Property_Tax), ~sum(., na.rm = TRUE))) %>% 
  group_by(state) %>% 
  mutate(across(c(real_gdp_priv_ind, real_Elem_Educ_Total_Exp, log_real_gdp_priv_ind, log_real_Elem_Educ_Total_Exp, log_real_Property_Tax), ~.- dplyr::lag(., 1), .names = "diff_{.col}"))  %>% 
  ungroup %>% 
  mutate(time = year - 2000)

```

### Negative trend
```{r}

trends <- feols(log_real_gdp_priv_ind ~ time:as.factor(state) | state + year, data = state_lev, se = "cluster", cluster = "state", panel.id = ~state+year)

trends %>% etable(., se.below = TRUE)

trends$coefficients %>% 
  tibble %>% 
  rename(coef = '.') %>% 
  ggplot() + 
  geom_histogram(aes(x = coef), bins = 15) + 
  theme_bw() +
  labs(title = "Histogram of State-level Trend Coefficient: (log) Real Private Industry GDP")


```

### Autocorrelation
```{r}

state_list <- unique(state_lev$state)

acf_list <- list()
for(s in 1:length(state_list)){
  ps <- state_lev %>% 
    filter(state == state_list[s]) %>% 
    pull(diff_real_Elem_Educ_Total_Exp) %>% 
    acf(., na.action = na.pass, plot = FALSE)

  acf_list[[s]] <- ps
}

acf_list[[1]] %>% plot
acf_list[[10]] %>% plot
acf_list[[15]] %>% plot
acf_list[[30]] %>% plot

```

## Second step (Education):
- Autocorrelation (Education only) (_)
- Correlation plots (X)
- Correlation plot of Education and GDP (_)
- Are GDP and Education Expenditure cointegrating (or do they exhibit a decoupling?) (_)


### Correlation Plots (Education and GDP)
```{r}

ggplot(state_lev, 
       aes(x= year))+
  geom_line(aes(y = real_Elem_Educ_Total_Exp, colour = 'red'))+
  geom_line(aes(y= real_gdp_priv_ind/20, colour = 'blue')) +
  facet_wrap(~state, scales = "free") +
  scale_color_discrete(name="",
                         breaks=c("red", "blue"),
                        labels = c("Elem. Educ. Exp.", "Priv. Ind. GDP")) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(), 
        legend.position = "bottom") +
  labs(title = "Plot of Elementary Education Expenditure and Private Industry GDP",
       subtitle = "in real USD by state",
       y = NULL)

ggplot(state_lev, 
       aes(x= real_gdp_priv_ind, 
           y= real_Elem_Educ_Total_Exp))+
  geom_point()+
  facet_wrap(~state, scales = "free") +
  geom_smooth(fill="blue", alpha=0.1)+
  geom_smooth(method='lm', formula= y~x, se=FALSE, col="red",lty=2)+
  theme(axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(),
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank())+
    labs(title = "Correlation Plot of Elementary Ed. Expenditure and Private Industry GDP",
       subtitle = "in real USD by state",
       y = "Elem. Ed. Exp",
       x = "Priv. Ind. GDP")


ggplot(state_lev, 
       aes(x= year))+
  geom_line(aes(y = real_Property_Tax, colour = 'red'))+
  geom_line(aes(y= real_gdp_priv_ind/100, colour = 'blue')) +
  facet_wrap(~state, scales = "free") +
  scale_color_discrete(name="",
                         breaks=c("red", "blue"),
                        labels = c("Property Tax", "Priv. Ind. GDP")) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(), 
        legend.position = "bottom") +
  labs(title = "Plot of Property Tax and Private Industry GDP",
       subtitle = "in real USD by state",
       y = NULL)

ggplot(state_lev, 
       aes(x= real_Property_Tax, 
           y= real_gdp_priv_ind))+
  geom_point()+
  facet_wrap(~state, scales = "free") +
  geom_smooth(fill="blue", alpha=0.1)+
  geom_smooth(method='lm', formula= y~x, se=FALSE, col="red",lty=2)+
  theme(axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(),
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank())+
    labs(title = "Correlation Plot of Property Taxes and Private Industry GDP",
       subtitle = "in real USD by state",
       y = "Priv. Ind. GDP",
       x = "Property Taxes")

ggplot(state_lev, 
       aes(x = year))+
  geom_line(aes(y = real_Property_Tax, colour = 'red'))+
  geom_line(aes(y= real_Elem_Educ_Total_Exp/5, colour = 'blue')) +
  facet_wrap(~state, scales = "free") +
  scale_color_discrete(name="",
                         breaks=c("red", "blue"),
                        labels = c("Property Tax", "Elem. Ed. Exp")) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(), 
        legend.position = "bottom") +
  labs(title = "Plot of Property Tax and Elem. Ed. Exp.",
       subtitle = "in real USD by state",
       y = NULL)

ggplot(state_lev, 
       aes(x= real_Property_Tax, 
           y= real_Elem_Educ_Total_Exp))+
  geom_point()+
  facet_wrap(~state, scales = "free") +
  geom_smooth(fill="blue", alpha=0.1)+
  geom_smooth(method='lm', formula= y~x, se=FALSE, col="red",lty=2)+
  theme(axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(),
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank())+
    labs(title = "Correlation Plot of Elem. Ed. Exp and Property Taxes",
       subtitle = "in real USD by state",
       y = "Elem. Ed. Exp.",
       x = "Property Taxes")

```


```{r}

for(fip in unique(mines_restr$fips)){
  gdp_var <- %>% %>% 
    filter(fips == fip) %>% 
    pull(real_gdp_priv_ind)
  
  elem_ed_var <- mines_restr %>% 
    filter(fips == fip) %>% 
    pull(real_Elem_Educ_Total_Exp)
    
  cor(gdp_var, elem_ed_var)
  ccf(as.numeric(gdp_var), as.numeric(elem_ed_var)) %>% print
}

```

