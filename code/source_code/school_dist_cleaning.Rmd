---
title: "prelim_clean"
author: "Ebba Mark"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(here)
library(tidyverse)
library(janitor)
library(gridExtra)
library(readr)
library(data.table)
library(readxl)
library(fixest)
library(forcats)
library(panelView)
library(openxlsx)
library(stargazer)
library(usmap)
library(kableExtra)


source(here('code/dicts.R'))
source(here('code/useful_functions.R'))

```

# School Level Codes
```{r}

schlevcodes <- rbind(c(1,"Elementary only"),
                c(2, "Secondary only"),
                c(3, "Elementary and Secondary"),
                c(4, "Postsecondary"),
                c(5, "Special / Vocational education"),
                c(6, "Nonoperating school system"),
                c(7, "Education Service Agency only")) %>% 
  as.data.frame %>% 
  rename("SchLevCode" = 1, "Definition" = 2)


```

# Raw data
```{r raw_data}

temp <- read.csv(here('data/raw/TheGovernmentFinanceDatabase_SchoolDistrictData/SchoolDistrictData.csv'), colClasses = c('FIPS_Combined' = "character", 'FIPSid' = "character", 'GOVSid' = "character"), na.strings = "") %>%
  tibble %>% 
  # Fills GOVSid for FIPSid with an assigned GOVSid in most observations except a few
  group_by(FIPSid) %>% 
  fill(GOVSid, .direction = "updown") %>% 
  # Fills GOVSid for FIPSid with an assigned GOVSid in most observations except a few
  group_by(GOVSid) %>% 
  fill(FIPSid, .direction = "updown") %>% 
  # Assign arbitrary unique FIPSid codes to each unique GOVSid
  ungroup %>% 
  mutate(FIPSid = ifelse(is.na(FIPSid), GOVSid, FIPSid),
         GOVSid = ifelse(is.na(GOVSid), FIPSid, GOVSid)) %>% 
  # Remove any columns that only have one value ie. no variation
  select(where(~n_distinct(.) > 1)) %>% 
  select(-c(GOVSid, State_Code, County, FIPS_Code_State, FIPS_County, FYEndDate, YearPop, Population)) %>% 
  rename(year = Year4, fips = FIPS_Combined) %>% 
  # Unlabeled year in which Wichita TEch changed name - manually adding 2017 value
  mutate(year = ifelse(is.na(year) & FIPSid == "00205173224962", 2017, year)) %>% 
  # Rest are observations with 0 enrollment or other data/measurement issues
  filter(!is.na(year)) %>% 
  group_by(FIPSid) %>% 
  # Fill missing school level codes = down first because introduction of an NA likely means a "recategorisation" in that year and then up to fill in missing values in beginning of time series
  fill(SchLevCode, .direction = "downup") %>% 
  mutate(SchLevCode = ifelse(FIPSid == "285035101", 1, SchLevCode)) %>% 
  ungroup
  

# Saves a clean dataset of full School district dataset
#temp %>% saveRDS(here('data/temp/school_district_all_1970_2021.RDS'))

# Create shorter version for which coverage is adequate (data coverage between 1993-1996 is poor)
temp_short <- temp %>% 
  filter(year >= 1997)

temp_short <- temp_short %>% 
  # Remove columns in which there are more than 30% missing values
  select(where(~sum(is.na(.) | . == 0)/nrow(temp_short) < 0.7)) %>% 
  # Manual changes to inconsistent codes after research - 5 & 7 School Level Code for same FIPSid
  mutate(SchLevCode = case_when(FIPSid == "145060401"~ 5,
                                # Regional special education centre - reclassified as vocational/transition to independence in 2012 - keep as "regional" not vocational
                                FIPSid == "145057202" ~ 7,
                                # Regional education service center
                                FIPSid == "055015101" ~ 7,
                                # Regional education service center
                                FIPSid == "055050101" ~ 7, 
                                TRUE ~ SchLevCode))
  
# Saves a subset of full cleaned dataset from 1997-2021 for which there is adequate coverage
#temp_short %>% saveRDS(here('data/temp/school_district_all_1997_2021.RDS'))

# Create dataset with adult/vocational training
temp_voc_adult <- temp_short %>% 
  filter(SchLevCode %in% c(4,5))

# Saves a dataset with the subset of school districts that identify as vocational/adult
#temp_voc_adult %>% saveRDS(here('data/temp/voc_adult_districts_1997_2021.RDS'))

# Create dataset with main school districts of interest (excl. vocational and adult)
temp_df <- temp_short %>% 
  filter(!(SchLevCode %in% c(4,5))) %>% 
  group_by(FIPSid) %>% 
  mutate(test_7 = ifelse(any(SchLevCode == 7), 1, 0)) %>% 
  ungroup %>% 
  mutate(SchLevCode = ifelse(test_7, 7, SchLevCode)) %>%
  select(-test_7) %>% 
  group_by(FIPSid) %>% 
  # these are the possible school districts labelled as non-operating that are in fact Education Service Agencies (7)
  mutate(test_6 = ifelse(any(Name %in% c('SOUTH COAST EDUCATION SERVICE DIST', 
                        'WILLAMETTE REGIONAL EDUCATION SE' , 
                        'SHERMAN EDUCATION SERVICE DIST',
                        'MOUNTAIN TOWNS REGIONAL EDUCATION DISTRICT USD #301',
                        'WHEELER EDUCATION SERVICE DIST' ,
                        'WILLAMETTE REGIONAL EDUCATION SERVICE DIST',
                        'SOUTH COAST EDUC SVC DIST' ,
                        'CLACKAMAS EDUCATION SERV DIST',
                        'BUCKLD-COLRAIN-SHELBURNE REG SCH',
                        'ASHFIELD-PLAINFIELD ACADEMIC REG',
                        'SOUTH COAST EDUCATION SERVICE DI', 
                        'GILLIAM EDUCATION SERVICE DIST',
                        'MALHEUR EDUCATION SERVICE DIST',
                        'WILLAMETTE REGIONAL EDUC SVC DIST',
                        'YAMHILL EDUCATION SERVICE DIST',
                        'PATRICIA A HANNAFORD REGIONAL TECHNICAL CENTER SCHOOL DISTRICT')), 1, 0)) %>%
  ungroup %>% 
  mutate(SchLevCode = ifelse(test_6, 7, SchLevCode)) %>%
  select(-test_6) #%>% 
  # Mark school districts that count as regional education districts
  #mutate(regional_ed = ifelse(SchLevCode == 7, TRUE, FALSE))

nrow(temp_voc_adult) + nrow(temp_df) == nrow(temp_short)

# Saves a dataset with the main school districts of interest (including regional education agencies)
#temp_df %>% saveRDS(here('data/temp/school_district_main_1997_2021.RDS'))


```


## County-level dataframe
```{r}

county_df <- temp_df %>% 
  filter(SchLevCode != 7) %>% 
  group_by(fips, year) %>% 
  select(-c(FIPSid, Name, SchLevCode)) %>% 
  group_by(fips, year) %>% 
  summarise(across(where(is.numeric), ~sum(., na.rm = TRUE))) %>% 
  ungroup

```


# Combining vocational expenditure
```{r}

voc_adult_counties <- temp_voc_adult %>% 
  group_by(fips, SchLevCode, year) %>% 
  summarise(across(where(is.numeric), ~sum(., na.rm = TRUE))) %>% 
  mutate(SchLevCode = case_when(SchLevCode == 4 ~ "adult",
                                SchLevCode == 5 ~ "voc",
                                TRUE ~ NA)) %>% 
  pivot_wider(id_cols = c(fips, year), names_from = SchLevCode, values_from = Enrollment:Oth_Nonin_Fd_Cash___Sec, names_glue = "{SchLevCode}_{.value}") %>% 
  ungroup

```


# Testing identities in dataset
```{r}

# For all Government codes except 229 (0.07% of sample) this identity is true (General_Debt_Interest == Total_Interest_on_Debt)
Total_Expenditure = Total_Educ_Total_Exp + Total_Interest_on_Debt
# Except in 9 cases, total fed ig revenue = fed IGR education
Total_Fed_IG_Revenue = Fed_IGR_Education
Total_Revenue = Total_Rev_Own_Sources + Total_IG_Revenue

# Total_revenue recorded is that collected for total_education expenditure
temp_df %>% mutate(test = Total_Revenue - Total_Educ_Total_Exp) %>% ggplot(.) + geom_histogram(aes(test), bins = 1000)

# Total taxes collected as recorded are those that are designated to school expenditure
temp_df %>% mutate(test = Total_Taxes - Property_Tax) %>% ggplot(.) + geom_histogram(aes(test), bins = 1000)



```


# Regional education agencies
Potentially worth excluding rhode island as there are two counties whose school districts are only represented by ESAs.
```{r}

test <- temp_df %>% 
  filter(SchLevCode != 7)

# There are 3 fips codes represented in the regional dataframe that are not in the main dataframe...One is an Oceaonolgy project in Connecticut which is to be excluded and the other two are West and East Bay Collaboratives of Rhode Island which serve FIPS codes not represented in the rest of the dataset....argument to exclude Rhode Island?
temp_df %>% 
  filter(SchLevCode == 7 & !(fips %in% unique(test$fips))) %>% pull(Name) %>% unique

# 45 states represented by ESAs which is in line with nationally reported numbers
temp_df %>% mutate(state = substr(fips, 1,2)) %>% relocate(state, .before = fips) %>% pull(state) %>% n_distinct

```


## Table of Educational Service Agencies
```{r}
options(knitr.kable.NA = '')

read.xlsx(here('documentation/esa_names_by_state.xlsx')) %>% 
  rename("ESA Name" = 2, "Number of Agencies" = 3) %>% 
  kable(format = "latex", caption = "Educational Service Agencies by State", label = "si_tbl:esa_names_tbl") %>% 
  kable_styling() %>%
  kableExtra::row_spec(0, bold = TRUE) %>% 
   add_footnote("Source: Association of Educational Service Agencies, State by State ESA Report 2021")


```

## Regional ESA dataframe
Important to understand which counties are assigned to which agencies....
```{r}

# Method: Create regional table and then merge with general county table
esa_county <- temp_df %>% 
  filter(SchLevCode == 7) %>% 
  select(-c(FIPSid, Name, SchLevCode)) %>% 
  group_by(fips, year) %>% 
  summarise(across(where(is.numeric), ~sum(., na.rm = TRUE))) %>% 
  ungroup %>% 
  select(fips, year, Total_Revenue, Total_Expenditure) %>% 
  rename(esa_rev = 3, esa_tot_exp = 4) %>% 
  mutate(esa = TRUE)

esa_county %>% saveRDS(here("data/temp/esa_data_county_97_21.RDS"))

```


# County vocational dataset
```{r}

# There are two fips codes in the vocational dataset not in the county dataset: 20000; 51710 - these are for Adult Colleges - OK to be excluded
voc_adult_county <- temp_voc_adult %>% 
  select(-c(FIPSid, Name, SchLevCode)) %>% 
  group_by(fips, year) %>% 
  summarise(across(where(is.numeric), ~sum(., na.rm = TRUE))) %>% 
  ungroup %>% 
  select(fips, year, Total_Revenue, Total_Expenditure) %>% 
  rename(voc_adult_tot_rev = 3, voc_adult_tot_exp = 4) %>% 
  mutate(voc_adult = TRUE)


```


# Combining county, ESA, and vocational datasets
```{r}


# Still needs population estimates from 1997-1999
pop <- readRDS(here("data/temp/population_age_controls.RDS")) %>% 
  select(fips, year, pop_total, pop_school_age)

temp_county <- county_df %>% 
  # 50050 is a fips code with no recent record and 31129 has a very poor time series
  filter(!(fips %in% c("50050", "31129"))) %>%
  mutate(fips = ifelse(fips == "46113", "46102", fips)) %>% 
  complete(fips, year) %>% 
  group_by(fips) %>%
  # Interpolate values at max gap of 2 values
  mutate(across(where(is.numeric), ~na.approx(., maxgap = 2, rule = 2))) %>% 
    ungroup %>%
    # filter((fips %in% c("13263", '28051', '17069', '28053'))) %>% all.equal(filter(complete(county_df, fips, year), !(fips %in% c("13263", '28051', '17069', '28053'))))
  left_join(., esa_county, by = c("year", "fips")) %>% 
  left_join(., voc_adult_county, by = c("year", "fips")) %>% 
  mutate(esa = ifelse(is.na(esa), FALSE, esa),
         voc_adult = ifelse(is.na(voc_adult), FALSE, voc_adult),
         state = substr(fips, 1,2)) %>% 
  left_join(pop, by = c("fips", "year")) %>% 
         # Use proportion of enrollment over school-age population for a county to impute missing values - only ever 1 or 2 in a row in which case likely not an issue
         #Enrollment = ifelse(fips == "13265" & year >= 2011, pop_school_age, Enrollment)) %>% 
  mutate(Enrollment = case_when(fips == "13265" & year >= 2011 ~ pop_school_age,
                                fips == "31129" & Enrollment == 0 ~ pop_school_age*0.58,
                                fips == "31135" & Enrollment == 0 ~ pop_school_age*0.7,
                                TRUE ~ Enrollment)) %>%
  relocate(state, .after = fips) %>%
  relocate(c(esa, voc_adult, pop_total, pop_school_age), .after = year) %>%
  mutate(across(c(Total_Revenue:voc_adult_tot_exp), ~./Enrollment, .names = "{.col}_pp")) %>% 
  mutate(across(c(Total_Revenue:voc_adult_tot_exp_pp), log, .names = "log_{.col}")) %>%
  relocate(c(pop_total, pop_school_age), .after = last_col())

temp_county %>% is.pbalanced(index = c("fips", "year"))

#temp_county %>% saveRDS(here("data/out/school_exp_county.RDS"))

temp_county %>% 
  group_by(state, year) %>% 
  summarise(across(c(Enrollment, Total_Expenditure, esa_tot_exp, voc_adult_tot_exp), ~sum(., na.rm = TRUE))) %>% 
  mutate(across(c(Total_Expenditure, esa_tot_exp, voc_adult_tot_exp), ~./Enrollment, .names = "{.col}_pp")) %>% 
  pivot_longer(cols = !c(state, year)) %>% 
  ggplot() +
  geom_line(aes(x = year, y = value, group = state, color = state)) +
  facet_wrap(~name, scales = "free_y")

```

# Identities
```{r}

temp_county %>% 
  mutate(test = round(sum(Total_Revenue, -Total_Rev_Own_Sources, -Total_IG_Revenue, na.rm = TRUE)),
         test2 = round(sum(Total_IG_Revenue, - Total_Fed_IG_Revenue, -Total_State_IG_Revenue, -Tot_Local_IG_Rev, na.rm = TRUE)),
         test3 = round(sum(Total_Revenue, -Total_Rev_Own_Sources, - Total_Fed_IG_Revenue, -Total_State_IG_Revenue, -Tot_Local_IG_Rev, na.rm = TRUE))) %>%
  select(test3) %>% distinct
```



